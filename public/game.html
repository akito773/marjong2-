<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻雀ゲーム - プレイテスト</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { 
            text-align: center;
            color: #FFD700;
            margin-bottom: 30px;
        }
        .section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover { background: #45a049; }
        .button:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        .game-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .player-info {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .current-player {
            border: 2px solid #FFD700;
        }
        .tiles {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        .tile {
            background: #f0f0f0;
            color: #333;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            border: 2px solid transparent;
        }
        .tile:hover {
            background: #FFD700;
            border-color: #333;
        }
        .tile.selected {
            background: #ff6b6b;
            color: white;
        }
        .debug-mode .player-info {
            border: 2px solid #00ff00;
        }
        .debug-info {
            background: rgba(0,255,0,0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        .waiting-tiles {
            color: #ffff00;
            font-weight: bold;
        }
        .possible-melds {
            color: #ff9500;
            font-weight: bold;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        input[type="text"] {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🀄 麻雀ゲーム - プレイテスト</h1>
        
        <!-- ゲーム作成セクション -->
        <div class="section">
            <h3>🎮 新しいゲーム作成</h3>
            <div>
                <input type="text" id="player1" placeholder="プレイヤー1" value="あなた">
                <input type="text" id="player2" placeholder="プレイヤー2" value="CPU1">
                <input type="text" id="player3" placeholder="プレイヤー3" value="CPU2">
                <input type="text" id="player4" placeholder="プレイヤー4" value="CPU3">
                <button class="button" onclick="createGame()">ゲーム作成</button>
            </div>
        </div>

        <!-- 現在のゲーム情報 -->
        <div class="section" id="gameSection" style="display: none;">
            <h3>🎯 現在のゲーム</h3>
            <div class="status" id="gameStatus"></div>
            
            <div class="game-info">
                <div>
                    <h4>🎲 ゲーム操作</h4>
                    <button class="button" onclick="refreshGameState()">状態更新</button>
                    <button class="button" onclick="testDiscard()" id="discardBtn" disabled>選択牌を捨牌</button>
                    <button class="button" onclick="toggleDebugMode()" id="debugBtn">🔍 デバッグモード</button>
                    <div>選択中の牌: <span id="selectedTile">なし</span></div>
                    <div>モード: <span id="currentMode">通常表示</span></div>
                </div>
                
                <div>
                    <h4>📊 ゲーム情報</h4>
                    <div id="gameInfo"></div>
                </div>
            </div>

            <!-- プレイヤー情報 -->
            <div id="playersInfo"></div>
        </div>

        <!-- アクティブゲーム一覧 -->
        <div class="section">
            <h3>📋 アクティブゲーム一覧</h3>
            <button class="button" onclick="loadActiveGames()">一覧更新</button>
            <div id="activeGames"></div>
        </div>

        <!-- ログ -->
        <div class="section">
            <h3>📝 ログ</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let currentGameId = null;
        let currentGameState = null;
        let selectedTileId = null;
        let debugMode = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 新しいゲーム作成
        async function createGame() {
            const playerNames = [
                document.getElementById('player1').value,
                document.getElementById('player2').value,
                document.getElementById('player3').value,
                document.getElementById('player4').value
            ];

            try {
                const response = await fetch('/api/game/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerNames })
                });

                const result = await response.json();
                
                if (result.status === 'OK') {
                    currentGameId = result.data.gameId;
                    currentGameState = result.data.gameState;
                    
                    log(`✅ ゲーム作成成功: ${currentGameId}`);
                    document.getElementById('gameSection').style.display = 'block';
                    updateGameDisplay();
                } else {
                    log(`❌ ゲーム作成失敗: ${result.message}`);
                }
            } catch (error) {
                log(`❌ エラー: ${error.message}`);
            }
        }

        // ゲーム状態更新
        async function refreshGameState() {
            if (!currentGameId) return;

            try {
                const endpoint = debugMode ? `/api/game/${currentGameId}/debug` : `/api/game/${currentGameId}`;
                const response = await fetch(endpoint);
                const result = await response.json();
                
                if (result.status === 'OK') {
                    currentGameState = result.data.gameState || result.data;
                    if (debugMode && result.data.playerDetails) {
                        // デバッグモード時は詳細情報も保存
                        currentGameState.debugDetails = result.data;
                    }
                    updateGameDisplay();
                    log(`🔄 ゲーム状態更新完了 ${debugMode ? '(デバッグ情報含む)' : ''}`);
                } else {
                    log(`❌ 状態取得失敗: ${result.message}`);
                }
            } catch (error) {
                log(`❌ エラー: ${error.message}`);
            }
        }

        // 捨牌テスト
        async function testDiscard() {
            if (!currentGameId || !selectedTileId) return;

            const currentPlayer = currentGameState.players[currentGameState.currentPlayer];
            const selectedTile = currentPlayer.hand.tiles.find(tile => tile.id === selectedTileId);

            if (!selectedTile) {
                log(`❌ 選択された牌が見つかりません`);
                return;
            }

            try {
                const response = await fetch(`/api/game/${currentGameId}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'discard',
                        playerId: currentPlayer.id,
                        tile: selectedTile
                    })
                });

                const result = await response.json();
                
                if (result.status === 'OK') {
                    currentGameState = result.data.gameState;
                    selectedTileId = null;
                    updateGameDisplay();
                    log(`🀄 捨牌成功: ${selectedTile.displayName}`);
                } else {
                    log(`❌ 捨牌失敗: ${result.message}`);
                }
            } catch (error) {
                log(`❌ エラー: ${error.message}`);
            }
        }

        // 牌選択
        function selectTile(tileId, displayName) {
            selectedTileId = tileId;
            document.getElementById('selectedTile').textContent = displayName;
            document.getElementById('discardBtn').disabled = false;
            
            // 選択状態の見た目更新
            document.querySelectorAll('.tile').forEach(tile => tile.classList.remove('selected'));
            document.querySelector(`[data-tile-id="${tileId}"]`).classList.add('selected');
            
            log(`🎯 牌選択: ${displayName}`);
        }

        // ゲーム画面更新
        function updateGameDisplay() {
            if (!currentGameState) return;

            // ゲーム状態表示
            const gameStatus = document.getElementById('gameStatus');
            gameStatus.innerHTML = `
                <strong>ゲームID:</strong> ${currentGameState.id}<br>
                <strong>フェーズ:</strong> ${currentGameState.phase}<br>
                <strong>現在のターン:</strong> ${currentGameState.players[currentGameState.currentPlayer].name}<br>
                <strong>残り牌数:</strong> ${currentGameState.remainingTiles}
            `;

            // ゲーム情報表示
            const gameInfo = document.getElementById('gameInfo');
            gameInfo.innerHTML = `
                <strong>局:</strong> 東${currentGameState.round.roundNumber}局<br>
                <strong>本場:</strong> ${currentGameState.round.honbaCount}<br>
                <strong>リーチ棒:</strong> ${currentGameState.round.riichiSticks}<br>
                <strong>ドラ:</strong> ${currentGameState.doraIndicators.map(tile => tile.unicode).join(' ')}
                ${debugMode && currentGameState.debugDetails && currentGameState.debugDetails.wallInfo ? `
                    <br><strong>🔍 牌山情報:</strong><br>
                    <strong>引き済み:</strong> ${currentGameState.debugDetails.wallInfo.totalDrawn}枚<br>
                    <strong>残り枚数:</strong> ${currentGameState.debugDetails.wallInfo.remainingTiles}枚<br>
                    <strong>ドラ枚数:</strong> ${currentGameState.debugDetails.wallInfo.doraCount}枚
                ` : ''}
            `;

            // プレイヤー情報表示
            const playersInfo = document.getElementById('playersInfo');
            playersInfo.innerHTML = currentGameState.players.map((player, index) => {
                const isCurrentPlayer = index === currentGameState.currentPlayer;
                const isCurrentUser = index === 0; // 仮に最初のプレイヤーをユーザーとする
                const showHand = debugMode || isCurrentUser;
                
                return `
                    <div class="player-info ${isCurrentPlayer ? 'current-player' : ''}">
                        <h4>${player.name} (${player.wind}風) ${player.isDealer ? '👑' : ''} ${isCurrentPlayer ? '🎯' : ''}</h4>
                        <div><strong>点数:</strong> ${player.score}点</div>
                        <div><strong>手牌:</strong> ${player.hand.tiles.length}枚</div>
                        ${showHand ? `
                            <div class="tiles">
                                ${player.hand.tiles.map(tile => 
                                    `<div class="tile" data-tile-id="${tile.id}" ${isCurrentUser ? `onclick="selectTile(${tile.id}, '${tile.displayName}')"` : ''}>${tile.unicode} ${tile.displayName}</div>`
                                ).join('')}
                            </div>
                        ` : `
                            <div class="tiles">
                                ${Array(player.hand.tiles.length).fill('🀫').join(' ')} (${player.hand.tiles.length}枚)
                            </div>
                        `}
                        ${debugMode ? `
                            <div class="debug-info">
                                <div><strong>🔍 デバッグ情報:</strong></div>
                                <div>手牌詳細: ${player.hand.tiles.map(t => t.displayName).join(', ')}</div>
                                <div>状態: ${player.status}</div>
                                ${currentGameState.debugDetails && currentGameState.debugDetails.playerDetails ? `
                                    <div>牌種類数: ${currentGameState.debugDetails.playerDetails[index].handAnalysis.uniqueTiles}種類</div>
                                    <div>萬子: ${currentGameState.debugDetails.playerDetails[index].handAnalysis.suitDistribution.man}枚</div>
                                    <div>筒子: ${currentGameState.debugDetails.playerDetails[index].handAnalysis.suitDistribution.pin}枚</div>
                                    <div>索子: ${currentGameState.debugDetails.playerDetails[index].handAnalysis.suitDistribution.sou}枚</div>
                                    <div>字牌: ${currentGameState.debugDetails.playerDetails[index].handAnalysis.suitDistribution.honor}枚</div>
                                    <div>聴牌判定: ${currentGameState.debugDetails.playerDetails[index].handAnalysis.isReadyHand ? '可能性あり' : 'なし'}</div>
                                ` : ''}
                                <div class="waiting-tiles">待ち牌: ${getWaitingTiles(player).join(', ') || 'なし'}</div>
                                <div class="possible-melds">可能な鳴き: ${getPossibleMelds(player).join(', ') || 'なし'}</div>
                            </div>
                        ` : ''}
                        ${player.hand.discards.length > 0 ? `
                            <div><strong>捨牌:</strong> ${player.hand.discards.map(tile => tile.unicode).join(' ')}</div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // 捨牌ボタンの状態更新
            const currentPlayer = currentGameState.players[currentGameState.currentPlayer];
            const isUserTurn = currentGameState.currentPlayer === 0;
            document.getElementById('discardBtn').style.display = isUserTurn ? 'inline-block' : 'none';
        }

        // アクティブゲーム一覧取得
        async function loadActiveGames() {
            try {
                const response = await fetch('/api/games');
                const result = await response.json();
                
                if (result.status === 'OK') {
                    const activeGamesDiv = document.getElementById('activeGames');
                    if (result.data.totalSessions === 0) {
                        activeGamesDiv.innerHTML = '<p>アクティブなゲームはありません</p>';
                    } else {
                        activeGamesDiv.innerHTML = result.data.sessions.map(session => `
                            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                <strong>ID:</strong> ${session.gameId}<br>
                                <strong>フェーズ:</strong> ${session.phase}<br>
                                <strong>現在のプレイヤー:</strong> ${session.currentPlayer}<br>
                                <strong>作成時刻:</strong> ${new Date(session.createdAt).toLocaleString()}
                            </div>
                        `).join('');
                    }
                    log(`📋 アクティブゲーム: ${result.data.totalSessions}個`);
                } else {
                    log(`❌ ゲーム一覧取得失敗: ${result.message}`);
                }
            } catch (error) {
                log(`❌ エラー: ${error.message}`);
            }
        }

        // デバッグ用ヘルパー関数
        function getWaitingTiles(player) {
            // 簡易的な待ち牌判定（実際はより複雑な実装が必要）
            const tiles = player.hand.tiles;
            if (tiles.length % 3 !== 1) return [];
            
            // TODO: 実際の待ち牌計算ロジック
            return ['仮実装'];
        }
        
        function getPossibleMelds(player) {
            // 簡易的な鳴き可能判定
            const melds = [];
            
            // TODO: 実際の鳴き判定ロジック
            if (currentGameState && currentGameState.lastDiscard) {
                const lastDiscard = currentGameState.lastDiscard;
                
                // ポン判定（同じ牌が2枚以上）
                const sameCount = player.hand.tiles.filter(t => 
                    t.suit === lastDiscard.suit && t.rank === lastDiscard.rank && t.honor === lastDiscard.honor
                ).length;
                if (sameCount >= 2) {
                    melds.push('ポン');
                }
                
                // チー判定（順子の可能性、簡易版）
                if (lastDiscard.suit && lastDiscard.rank) {
                    const suit = lastDiscard.suit;
                    const rank = lastDiscard.rank;
                    const hasNeighbors = player.hand.tiles.some(t => 
                        t.suit === suit && Math.abs(t.rank - rank) <= 2
                    );
                    if (hasNeighbors) {
                        melds.push('チー');
                    }
                }
            }
            
            return melds;
        }

        // デバッグモード切り替え
        function toggleDebugMode() {
            debugMode = !debugMode;
            document.getElementById('currentMode').textContent = debugMode ? '🔍 デバッグモード' : '通常表示';
            document.getElementById('debugBtn').textContent = debugMode ? '👁️ 通常モード' : '🔍 デバッグモード';
            
            if (debugMode) {
                document.body.classList.add('debug-mode');
                log('🔍 デバッグモード ON - 全プレイヤー情報表示');
            } else {
                document.body.classList.remove('debug-mode');
                log('👁️ 通常モード ON - 自分の手牌のみ表示');
            }
            
            if (currentGameState) {
                updateGameDisplay();
            }
        }

        // 初期化
        log('🎮 麻雀ゲームテストページ初期化完了');
        loadActiveGames();
    </script>
</body>
</html>