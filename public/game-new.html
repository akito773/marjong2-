<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ æœ¬æ ¼éº»é›€ v1.2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a5f2f 0%, #0f4021 50%, #0a2d17 100%);
            color: #212529;
            height: 100vh;
            overflow: auto;
        }
        
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1920Ã—1080å¯¾å¿œ */
        body {
            min-width: 1920px;
            min-height: 1080px;
        }
        
        /* 2560Ã—1440å¯¾å¿œ */
        @media (min-width: 2560px) and (min-height: 1440px) {
            body {
                min-width: 2560px;
                min-height: 1440px;
            }
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            height: 60px;
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffc107;
        }

        .game-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .game-controls {
            display: flex;
            gap: 10px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .mahjong-container {
            width: 1920px;
            height: 1080px;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ï¼ˆä¸­å¤®ã‚¨ãƒªã‚¢ï¼‰ */
        .game-board {
            width: 1880px;
            height: 980px;
            background: linear-gradient(135deg, #2d5a3d 0%, #1a4c2c 100%);
            border-radius: 20px;
            margin: 20px;
            position: relative;
            border: 8px solid #8b4513;
            box-shadow: 0 0 0 4px #ffc107, 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* 2Kå¯¾å¿œ: 2560Ã—1440 */
        @media (min-width: 2560px) and (min-height: 1440px) {
            .mahjong-container {
                width: 2560px;
                height: 1440px;
                transform: scale(1.333); /* 1920â†’2560ã®æ¯”ç‡ */
                transform-origin: top center;
            }
            
            .game-board {
                width: 2520px;
                height: 1320px;
            }
        }

        /* 2Kå¯¾å¿œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é…ç½® */
        .player-area {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            min-width: 280px;
        }

        .player-area.current {
            border-color: #ffc107;
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.6);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä¸Šå´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¯¾é¢ï¼‰ */
        .player-top {
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 280px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å³å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .player-right {
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            width: 240px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å·¦å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .player-left {
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            width: 240px;
        }
        
        /* 2Kå¯¾å¿œ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ */
        @media (min-width: 2560px) and (min-height: 1440px) {
            .player-top {
                top: 40px;
                width: 350px;
            }
            
            .player-left, .player-right {
                width: 300px;
            }
            
            .player-left {
                left: 40px;
            }
            
            .player-right {
                right: 40px;
            }
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± */
        .player-info {
            color: white;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .player-wind {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
        }

        /* æ‰‹ç‰Œè¡¨ç¤º */
        .hand-tiles {
            display: flex;
            gap: 2px;
            flex-wrap: nowrap;
        }

        /* å¯¾æˆ¦ç›¸æ‰‹ã®æ‰‹ç‰Œï¼ˆè£å‘ãï¼‰ */
        .opponent-tiles {
            display: flex;
            gap: 2px;
        }

        .opponent-tile {
            width: 20px;
            height: 28px;
            background: #4a5568;
            border: 1px solid #2d3748;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }

        /* å·¦å³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç¸¦å‘ã */
        .player-left .opponent-tiles, 
        .player-right .opponent-tiles {
            flex-direction: column;
        }

        .player-left .opponent-tile, 
        .player-right .opponent-tile {
            width: 28px;
            height: 20px;
        }

        /* æœ¬æ ¼éº»é›€ã®æ²³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .mahjong-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .rivers-horizontal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
        }

        .river-area {
            display: grid;
            gap: 1px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä¸Šä¸‹ã®æ²³ï¼ˆæ¨ªå‘ã6Ã—3ï¼‰ */
        .river-top, .river-bottom {
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 240px;
            height: 120px;
            margin: 0 auto;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å·¦å³ã®æ²³ï¼ˆç¸¦å‘ã3Ã—6ï¼‰ */
        .river-left, .river-right {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(6, 1fr);
            width: 100px;
            height: 240px;
        }
        
        /* 2Kå¯¾å¿œ: æ²³ã‚¨ãƒªã‚¢ */
        @media (min-width: 2560px) and (min-height: 1440px) {
            .river-top, .river-bottom {
                width: 300px;
                height: 150px;
            }
            
            .river-left, .river-right {
                width: 120px;
                height: 300px;
            }
        }

        /* 2Kå¯¾å¿œæ²³ã®ç‰Œã‚¹ã‚¿ã‚¤ãƒ« */
        .river-tile {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            cursor: default;
            min-width: 40px;
            min-height: 50px;
            max-width: 40px;
            max-height: 50px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .river-tile.red {
            color: #dc3545;
        }
        
        /* é³´ã„ãŸç‰Œï¼ˆãƒãƒ¼ãƒ»ãƒãƒ³ãƒ»ã‚«ãƒ³ã§å‘¼ã°ã‚ŒãŸç‰Œï¼‰ã®è¡¨ç¤º */
        .river-tile.called {
            background: #ffe6cc;
            border-color: #ff9800;
            border-width: 2px;
            box-shadow: 0 0 4px rgba(255, 152, 0, 0.5);
        }

        .river-tile.reach {
            transform: rotate(90deg);
            background: #ffe6e6;
            border-color: #ff9999;
        }

        /* 2Kå¯¾å¿œå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ç‰Œæ–¹å‘ */
        .river-left .river-tile, 
        .river-right .river-tile {
            /* å—ãƒ»åŒ—ã¯æ¨ªå‘ã */
            transform: rotate(0deg);
            width: 50px;
            height: 40px;
            font-size: 14px;
        }

        .river-left .river-tile.reach, 
        .river-right .river-tile.reach {
            transform: rotate(90deg); /* ãƒªãƒ¼ãƒç‰Œã¯ç¸¦å€’ã— */
        }

        .river-top .river-tile {
            /* è¥¿ã¯é€†å‘ã */
            transform: rotate(180deg);
        }

        .river-top .river-tile.reach {
            transform: rotate(90deg); /* ãƒªãƒ¼ãƒç‰Œã¯æ¨ªå€’ã— */
        }

        /* ä¸­å¤®æƒ…å ±ã‚¨ãƒªã‚¢ */
        .center-info {
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            min-width: 120px;
        }

        .round-info {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffc107;
            margin-bottom: 8px;
        }

        .dora-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .remaining-tiles {
            font-size: 0.7rem;
            color: #ccc;
        }

        /* ãƒªãƒ¼ãƒæ£’ã‚¹ã‚¿ã‚¤ãƒ« */
        .riichi-stick {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            border: 2px solid #fff;
        }

        @keyframes riichiPlace {
            0% {
                transform: translateY(-20px) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translateY(-5px) scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* å¹ãå‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« */
        .speech-bubbles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .speech-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #333;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            animation: speechAppear 0.3s ease-out;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®åˆ¥ã®å¹ãå‡ºã—é…ç½® */
        #speechBubble0 { /* ä¸‹ï¼ˆè‡ªåˆ†ï¼‰ */
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
        }
        #speechBubble0::after {
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
        }

        #speechBubble1 { /* å·¦ */
            left: 100px;
            top: 50%;
            transform: translateY(-50%);
        }
        #speechBubble1::after {
            left: -16px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }

        #speechBubble2 { /* ä¸Šï¼ˆå¯¾é¢ï¼‰ */
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
        }
        #speechBubble2::after {
            top: -16px;
            left: 50%;
            transform: translateX(-50%) rotate(180deg);
        }

        #speechBubble3 { /* å³ */
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
        }
        #speechBubble3::after {
            right: -16px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }

        @keyframes speechAppear {
            0% {
                transform: scale(0) translateX(-50%);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) translateX(-50%);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) translateX(-50%);
                opacity: 1;
            }
        }

        /* 2Kå¯¾å¿œãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .meld-area {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-meld-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            min-height: 80px;
            width: 100%;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ãƒ¡ãƒ«ãƒ‰é…ç½® */
        .player-top .meld-area {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
        }

        .player-left .meld-area {
            position: absolute;
            right: -450px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
        }

        .player-right .meld-area {
            position: absolute;
            left: -450px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
        }

        .meld-group {
            display: flex;
            gap: 2px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 4px;
            margin-right: 8px;
            position: relative;
        }

        .meld-group.chi {
            border-color: #28a745;
        }

        .meld-group.pon {
            border-color: #ffc107;
        }

        .meld-group.kan {
            border-color: #dc3545;
        }

        .meld-tile {
            width: 48px;
            height: 64px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #666;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .meld-tile.red {
            color: #dc3545;
        }

        .meld-tile.called {
            transform: rotate(90deg);
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        }

        .meld-label {
            position: absolute;
            top: -8px;
            left: 4px;
            background: #007bff;
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        .meld-group.chi .meld-label {
            background: #28a745;
        }

        .meld-group.pon .meld-label {
            background: #ffc107;
            color: #000;
        }

        .meld-group.kan .meld-label {
            background: #dc3545;
        }

        /* ä¸‹éƒ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ã¯é€†é †é…ç½® */
        .river-bottom {
            direction: rtl;
        }

        .river-bottom .river-tile {
            direction: ltr;
        }
        
        /* æ²³ã®è¡¨ç¤ºæ–¹å‘ä¿®æ­£ */
        .river-bottom {
            direction: ltr; /* å·¦ã‹ã‚‰å³ã¸ */
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ç”¨: è‡ªåˆ†ã®æ²³ã®é…ç½®ç¢ºèª */
        .river-bottom .river-tile {
            position: relative;
        }
        
        .river-bottom .river-tile::before {
            content: attr(data-order);
            position: absolute;
            top: -10px;
            left: 0;
            font-size: 8px;
            color: red;
        }

        /* 2Kå¯¾å¿œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ */
        .player-bottom-area {
            background: rgba(255, 255, 255, 0.95);
            margin: 0 40px 40px 40px;
            border-radius: 15px;
            padding: 25px;
            border: 4px solid #ffc107;
        }

        .player-hand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hand-count {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç‰Œ */
        .player-hand {
            display: flex;
            gap: 4px;
            justify-content: flex-start;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .tile {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background: #f8f9fa;
        }

        .tile.selected {
            background: #fff3cd;
            border-color: #ffc107;
            transform: translateY(-6px);
            box-shadow: 0 6px 12px rgba(255, 193, 7, 0.4);
        }

        .tile.red {
            color: #dc3545;
            font-weight: 800;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ã¦ç‰Œ */
        .player-discards {
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
        }

        .player-discards-title {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .player-discard-tiles {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .player-discard-tiles .tile {
            width: 28px;
            height: 36px;
            font-size: 14px;
            cursor: default;
            background: #e9ecef;
            border-color: #ced4da;
        }

        .player-discard-tiles .tile:hover {
            transform: none;
            background: #e9ecef;
        }

        /* å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å€‹åˆ¥æ¨ç‰Œã‚¨ãƒªã‚¢ */
        .player-discard-area {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin-top: 8px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            min-height: 50px;
            max-width: 150px;
        }

        .player-top .player-discard-area {
            margin-top: 8px;
        }

        .player-left .player-discard-area,
        .player-right .player-discard-area {
            margin-top: 8px;
            max-width: 120px;
        }

        .player-discard-area .discard-tile {
            font-size: 9px;
            padding: 1px;
            min-width: 20px;
            height: 24px;
            cursor: default;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-discard-area .discard-tile:hover {
            transform: none;
            background: #f8f9fa;
        }

        .player-discard-area .discard-tile.red {
            color: #dc3545;
            font-weight: 800;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-panel {
            position: fixed;
            bottom: 40px;
            left: 40px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 500px;
            z-index: 50;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-success { background: #198754; color: white; }
        .btn-info { background: #0dcaf0; color: #212529; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* æƒ…å ±ãƒ‘ãƒãƒ« */
        .info-panel {
            position: fixed;
            bottom: 200px;
            left: 40px;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 50;
            font-size: 1rem;
        }

        .game-status {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #212529;
        }

        .game-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #212529;
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background: #d1edff;
            color: #0c63e4;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
        }

        .notification.warning {
            background: #fff3cd;
            color: #856404;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .game-board {
                margin: 10px;
            }
            
            .info-panel {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin: 10px;
            }
            
            .action-panel {
                position: relative;
                bottom: auto;
                right: auto;
                max-width: none;
                margin: 10px;
                justify-content: center;
            }

            .player-bottom-area {
                margin: 0 10px 10px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="mahjong-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="game-header">
            <a href="/title.html" class="game-title" style="text-decoration: none;">ğŸ€„ æœ¬æ ¼éº»é›€ v1.2.0</a>
            
            <div class="game-info">
                <div id="gameInfo">æ±å ´ 1å±€</div>
                <div>æ®‹ã‚Šç‰Œ: <span id="remainingTiles">69</span></div>
                <div>ç¾åœ¨: <span id="currentPlayerName">ã‚ãªãŸ</span></div>
            </div>

            <div class="game-controls">
                <button class="btn btn-info" onclick="toggleDebug()">ãƒ‡ãƒãƒƒã‚°</button>
                <button id="cpuAutoBtn" class="btn btn-success" onclick="toggleCpuAuto()">CPUè‡ªå‹•é–‹å§‹</button>
                <button id="playerAutoBtn" class="btn btn-secondary" onclick="togglePlayerAuto()">ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Š</button>
                <button class="btn btn-warning" onclick="newGame()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
                <a href="/title.html" class="btn btn-info">ã‚¿ã‚¤ãƒˆãƒ«</a>
            </div>
        </header>

        <!-- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ -->
        <div class="game-board">
            <!-- ä¸Šå´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¯¾é¢ï¼‰ -->
            <div class="player-area player-top" id="player2">
                <div class="player-info">
                    <div class="player-name">CPUè¥¿</div>
                    <div class="player-wind">è¥¿</div>
                    <div class="player-score">
                        <span id="player2Score">25000</span>ç‚¹
                    </div>
                </div>
                <div class="opponent-tiles" id="hand2"></div>
                <div class="meld-area" id="melds2"></div>
            </div>

            <!-- å³å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
            <div class="player-area player-right" id="player3">
                <div class="player-info">
                    <div class="player-name">CPUåŒ—</div>
                    <div class="player-wind">åŒ—</div>
                    <div class="player-score">
                        <span id="player3Score">25000</span>ç‚¹
                    </div>
                </div>
                <div class="opponent-tiles" id="hand3"></div>
                <div class="meld-area" id="melds3"></div>
            </div>

            <!-- å·¦å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
            <div class="player-area player-left" id="player1">
                <div class="player-info">
                    <div class="player-name">CPUå—</div>
                    <div class="player-wind">å—</div>
                    <div class="player-score">
                        <span id="player1Score">25000</span>ç‚¹
                    </div>
                </div>
                <div class="opponent-tiles" id="hand1"></div>
                <div class="meld-area" id="melds1"></div>
            </div>

            <!-- ä¸­å¤®ã®æ²³ã‚¨ãƒªã‚¢ï¼ˆæœ¬æ ¼éº»é›€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
            <div class="mahjong-center">
                <!-- ä¸Šå´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                <div class="river-area river-top" id="river2"></div>
                
                <!-- å·¦å³ã®æ²³ã¨ä¸­å¤®æƒ…å ± -->
                <div class="rivers-horizontal">
                    <!-- å·¦å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                    <div class="river-area river-left" id="river1"></div>
                    
                    <!-- ä¸­å¤®æƒ…å ±ã‚¨ãƒªã‚¢ -->
                    <div class="center-info">
                        <div class="round-info" id="roundInfo">æ±1å±€</div>
                        <div class="dora-info">
                            ãƒ‰ãƒ©: <span id="doraIndicator">ğŸ€«</span>
                        </div>
                        <div class="remaining-tiles">
                            æ®‹ã‚Š: <span id="remainingTilesDisplay">69</span>æš
                        </div>
                        <!-- ãƒªãƒ¼ãƒæ£’ -->
                        <div class="riichi-stick" id="riichiStick" style="display: none;">
                            1000ç‚¹æ£’
                        </div>
                    </div>
                    
                    <!-- å³å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                    <div class="river-area river-right" id="river3"></div>
                </div>
                
                <!-- ä¸‹å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                <div class="river-area river-bottom" id="river0"></div>
            </div>
        </div>

        <!-- å¹ãå‡ºã—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="speech-bubbles">
            <div class="speech-bubble" id="speechBubble0" style="display: none;"></div>
            <div class="speech-bubble" id="speechBubble1" style="display: none;"></div>
            <div class="speech-bubble" id="speechBubble2" style="display: none;"></div>
            <div class="speech-bubble" id="speechBubble3" style="display: none;"></div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div class="player-bottom-area" id="player0">
            <div class="player-hand-header">
                <div class="player-details">
                    <div class="player-name" id="playerName">ã‚ãªãŸ</div>
                    <div class="player-wind" id="playerWind">æ±</div>
                    <div style="color: #6c757d; font-size: 0.9rem;">
                        <span id="playerScore">25000</span>ç‚¹
                    </div>
                </div>
                <div class="hand-count">
                    æ‰‹ç‰Œ: <span id="handCount">13</span>æš
                </div>
            </div>
            
            <div class="player-hand" id="hand0"></div>
            
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼0ã®ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="meld-area player-meld-area" id="melds0"></div>
            
        </div>

        <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="info-panel">
            <div class="game-status" id="gameStatus">ã‚²ãƒ¼ãƒ é–‹å§‹</div>
            <div class="game-stats">
                <div class="stat-item">
                    <div class="stat-label">ç¾åœ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
                    <div class="stat-value" id="currentPlayer">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å±€æ•°</div>
                    <div class="stat-value" id="round">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æœ¬å ´</div>
                    <div class="stat-value" id="honba">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ®‹ã‚Šç‰Œ</div>
                    <div class="stat-value" id="remainingTilesInfo">69</div>
                </div>
            </div>
            <button class="btn btn-success" onclick="requestGameState()" style="width: 100%;">
                çŠ¶æ…‹ã‚’æ›´æ–°
            </button>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« -->
        <div class="action-panel">
            <button class="btn btn-primary" onclick="drawTile()" id="drawBtn">ãƒ„ãƒ¢</button>
            <button class="btn btn-danger" onclick="discardSelected()" id="discardBtn">æ‰“ç‰Œ</button>
            <button class="btn" style="background: #ff6b6b; color: white;" onclick="callRiichi()" id="riichiBtn">ãƒªãƒ¼ãƒ</button>
            <button class="btn btn-warning" onclick="callChi()" id="chiBtn" style="display: inline-block;">ãƒãƒ¼</button>
            <button class="btn btn-warning" onclick="callPon()" id="ponBtn" style="display: inline-block;">ãƒãƒ³</button>
            <button class="btn btn-warning" onclick="callKan()" id="kanBtn" style="display: inline-block;">ã‚«ãƒ³</button>
            <button class="btn btn-success" onclick="callTsumo()" id="tsumoBtn">ãƒ„ãƒ¢</button>
            <button class="btn btn-success" onclick="callRon()" id="ronBtn">ãƒ­ãƒ³</button>
            <button class="btn btn-info" onclick="executeAI()" id="aiBtn">AIå®Ÿè¡Œ</button>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
        <div class="debug-panel" style="position: fixed; bottom: 160px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 10px; border-radius: 8px; font-size: 0.75rem; z-index: 100; max-width: 180px;">
            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ“ä½œ</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="forceCPUTurn()">CPUå¼·åˆ¶å®Ÿè¡Œ</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="showGameLog()">ãƒ­ã‚°è¡¨ç¤º</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="toggleDebugMode()">ãƒ‡ãƒãƒƒã‚°åˆ‡æ›¿</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="skipToNextPlayer()">æ¬¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="showDiscards()">æ¨ã¦ç‰Œç¢ºèª</button>
                <button class="btn" style="background: #17a2b8; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="testDiscardCoordinates()">åº§æ¨™ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" style="background: #28a745; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="testYakuAnalysis()">å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="showErrorLogs()">ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="clearConsole()">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ¶ˆå»</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification"></div>

    <!-- éŸ³åŠ¹åˆ¶å¾¡ãƒ‘ãƒãƒ«ï¼ˆä½ç½®ä¿®æ­£ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã¨é‡è¤‡å›é¿ï¼‰ -->
    <div style="position: fixed; top: 70px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 6px; color: white;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <button onclick="toggleSound()" id="soundToggle" class="btn" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">ğŸ”Š</button>
            <input type="range" id="volumeSlider" min="0" max="100" value="70" onchange="setVolume(this.value)" style="width: 60px;">
        </div>
    </div>

    <script src="/js/SoundManager.js"></script>
    <script>
        let gameId = null;
        let selectedTile = null;
        let gameState = null;
        let debugMode = false;
        let lastDiscardedTile = null;
        let lastDiscardedPlayer = null;
        
        // å¤‰æ•°åˆæœŸåŒ–
        let isConnected = false;
        let currentTenpaiStatus = { isTenpai: false, waitingTiles: [] };
        
        // Socket.IOæ¥ç¶š
        const socket = io();
        
        // Socket.IOã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        socket.on('connect', () => {
            console.log('ğŸ”Œ Socket.IOæ¥ç¶šæˆåŠŸ');
            isConnected = true;
        });
        
        socket.on('disconnect', () => {
            console.log('ğŸ”Œ Socket.IOåˆ‡æ–­');
            isConnected = false;
        });
        
        socket.on('gameUpdate', (newGameState) => {
            console.log('ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°å—ä¿¡');
            gameState = newGameState;
            updateGameDisplay();
        });
        
        socket.on('gameCreated', (data) => {
            console.log('ğŸ® ã‚²ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', data);
            gameId = data.gameId;
            showNotification('ã‚²ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
        
        let gameStartNotified = false;
        
        socket.on('gameState', (newGameState) => {
            // console.log('ğŸ® ã‚²ãƒ¼ãƒ çŠ¶æ…‹å—ä¿¡:', newGameState);
            gameState = newGameState;
            updateGameDisplay();
            
            // åˆå›ã®ã¿ã‚²ãƒ¼ãƒ é–‹å§‹é€šçŸ¥ã‚’è¡¨ç¤º
            if (!gameStartNotified && newGameState.phase === 'playing') {
                showNotification('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
                gameStartNotified = true;
            }
        });

        // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šã®é€šçŸ¥ã‚’å—ä¿¡
        socket.on('meldOpportunities', (data) => {
            const timestamp = new Date().toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ===== ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šå—ä¿¡é–‹å§‹ =====`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ãƒ‡ãƒ¼ã‚¿å…¨ä½“:`, data);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] æ¨ã¦ç‰Œ: ${data.discardedTile?.displayName || data.discardedTile?.unicode}`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] æ¨ã¦ç‰Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${data.discardPlayerId}`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ã‚ªãƒ¼ãƒˆåœæ­¢: ${data.autoPaused}`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] æ©Ÿä¼šãŒã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${data.opportunities?.length || 0}`);
            data.opportunities?.forEach(opp => {
                const types = [];
                if (opp.chi) types.push('ãƒãƒ¼');
                if (opp.pon) types.push('ãƒãƒ³');
                if (opp.kan) types.push('ã‚«ãƒ³');
                console.log(`[${timestamp}] ğŸ€„ [CLIENT] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opp.playerId}(${opp.playerType}): ${types.join('ãƒ»')}`);
            });
            
            // lastDiscardedTileã‚’ç›´æ¥è¨­å®š
            console.log(`ğŸ”§ DEBUG: data.discardedTile exists: ${!!data.discardedTile}`);
            console.log(`ğŸ”§ DEBUG: data.discardPlayerId: ${data.discardPlayerId}`);
            console.log(`ğŸ”§ DEBUG: data.discardPlayerId !== undefined: ${data.discardPlayerId !== undefined}`);
            
            if (data.discardedTile && data.discardPlayerId !== undefined) {
                lastDiscardedTile = data.discardedTile;
                lastDiscardedPlayer = data.discardPlayerId;
                console.log(`ğŸ”§ lastDiscardedTile set from meldOpportunities: ${lastDiscardedTile.displayName} by player ${lastDiscardedPlayer}`);
            } else {
                console.log(`ğŸ”§ Failed to set lastDiscardedTile - condition not met`);
            }
            
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] showMeldOpportunitiesé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™`);
            showMeldOpportunities(data);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ===== ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šå—ä¿¡çµ‚äº† =====`);
        });

        // å’Œäº†çµæœå—ä¿¡
        socket.on('winResult', (data) => {
            console.log('ğŸ¯ å’Œäº†çµæœå—ä¿¡:', data);
            
            if (data.success) {
                showNotification(`${data.message}`, 'success');
                
                if (data.yaku && data.yaku.length > 0) {
                    const yakuNames = data.yaku.map(y => y.name).join('ãƒ»');
                    showNotification(`å½¹: ${yakuNames} (${data.han}ç¿»)`, 'info');
                }
                
                if (data.score) {
                    const score = data.score;
                    let scoreText = '';
                    
                    if (score.isYakuman) {
                        scoreText = `å½¹æº€${score.yakumanCount > 1 ? score.yakumanCount + 'å€' : ''}: ${score.total}ç‚¹`;
                    } else {
                        scoreText = `${score.han}ç¿»${score.fu}ç¬¦: ${score.total}ç‚¹`;
                    }
                    
                    showNotification(scoreText, 'success');
                    
                    // è©³ç´°ãªæ”¯æ‰•ã„æƒ…å ±
                    if (score.isTsumo) {
                        showNotification(`ãƒ„ãƒ¢: å…¨å“¡ã‹ã‚‰${score.payments.winner}ç‚¹`, 'info');
                    } else {
                        showNotification(`ãƒ­ãƒ³: ${score.payments.winner}ç‚¹`, 'info');
                    }
                }
                
                // ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹ã®è¡¨ç¤º
                setTimeout(() => {
                    showNotification('ã‚²ãƒ¼ãƒ çµ‚äº†', 'info');
                }, 3000);
            } else {
                showNotification(`å’Œäº†å¤±æ•—: ${data.error}`, 'error');
            }
        });

        // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šè¡¨ç¤ºé–¢æ•°
        function showMeldOpportunities(data) {
            const { discardedTile, discardPlayerId, opportunities, autoPaused } = data;
            
            // è‡ªåˆ†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼0ï¼‰ã®æ©Ÿä¼šã‚’ãƒã‚§ãƒƒã‚¯
            const myOpportunity = opportunities.find(opp => opp.playerId === 0);
            
            console.log('ğŸ€„ [DEBUG] showMeldOpportunitieså‘¼ã³å‡ºã—');
            console.log('ğŸ€„ [DEBUG] myOpportunity:', myOpportunity);
            
            // ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            console.log('ğŸ€„ [DEBUG] ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«å…¨ä½“:', document.querySelector('.action-panel'));
            console.log('ğŸ€„ [DEBUG] å…¨ã¦ã®ãƒœã‚¿ãƒ³:', document.querySelectorAll('.action-panel button'));
            console.log('ğŸ€„ [DEBUG] chiBtn by class:', document.querySelector('#chiBtn'));
            console.log('ğŸ€„ [DEBUG] ponBtn by class:', document.querySelector('#ponBtn'));
            console.log('ğŸ€„ [DEBUG] kanBtn by class:', document.querySelector('#kanBtn'));
            
            if (myOpportunity) {
                console.log('ğŸ€„ è‡ªåˆ†ã«ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼š:', myOpportunity);
                console.log('ğŸ€„ [DEBUG] chi:', myOpportunity.chi, 'pon:', myOpportunity.pon, 'kan:', myOpportunity.kan);
                
                // ãƒœã‚¿ãƒ³è¦ç´ ã®å­˜åœ¨ç¢ºèª
                const chiBtn = document.getElementById('chiBtn');
                const ponBtn = document.getElementById('ponBtn');
                const kanBtn = document.getElementById('kanBtn');
                
                console.log('ğŸ€„ [DEBUG] chiBtnè¦ç´ :', chiBtn);
                console.log('ğŸ€„ [DEBUG] ponBtnè¦ç´ :', ponBtn);
                console.log('ğŸ€„ [DEBUG] kanBtnè¦ç´ :', kanBtn);
                
                // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶è¡¨ç¤º
                if (chiBtn) {
                    chiBtn.style.display = 'inline-block';
                    chiBtn.style.visibility = 'visible';
                    console.log('ğŸ€„ [DEBUG] ãƒãƒ¼ãƒœã‚¿ãƒ³è¡¨ç¤ºè¨­å®šå®Œäº†');
                }
                if (ponBtn) {
                    ponBtn.style.display = 'inline-block';
                    ponBtn.style.visibility = 'visible';
                    console.log('ğŸ€„ [DEBUG] ãƒãƒ³ãƒœã‚¿ãƒ³è¡¨ç¤ºè¨­å®šå®Œäº†');
                }
                if (kanBtn) {
                    kanBtn.style.display = 'inline-block';
                    kanBtn.style.visibility = 'visible';
                    console.log('ğŸ€„ [DEBUG] ã‚«ãƒ³ãƒœã‚¿ãƒ³è¡¨ç¤ºè¨­å®šå®Œäº†');
                }
                
                console.log('ğŸ€„ [DEBUG] ãƒœã‚¿ãƒ³è¡¨ç¤ºè¨­å®šå®Œäº†');
                
                // é€šçŸ¥è¡¨ç¤º
                const meldTypes = [];
                if (myOpportunity.chi) meldTypes.push('ãƒãƒ¼');
                if (myOpportunity.pon) meldTypes.push('ãƒãƒ³');
                if (myOpportunity.kan) meldTypes.push('ã‚«ãƒ³');
                
                // ã‚ªãƒ¼ãƒˆåœæ­¢ã®é€šçŸ¥
                if (autoPaused) {
                    showNotification(`${meldTypes.join('ãƒ»')}ãŒå¯èƒ½ã§ã™ï¼ï¼ˆã‚ªãƒ¼ãƒˆæ©Ÿèƒ½ã‚’åœæ­¢ã—ã¾ã—ãŸï¼‰`, 'warning');
                } else {
                    showNotification(`${meldTypes.join('ãƒ»')}ãŒå¯èƒ½ã§ã™ï¼`, 'info');
                }
                
                // 10ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºï¼ˆã‚ªãƒ¼ãƒˆåœæ­¢æ™‚ã¯é•·ã‚ã«ï¼‰
                setTimeout(() => {
                    hideMeldButtons();
                }, autoPaused ? 10000 : 5000);
            } else {
                hideMeldButtons();
            }
        }

        // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç„¡åŠ¹åŒ–ï¼‰
        function hideMeldButtons() {
            const chiBtn = document.getElementById('chiBtn');
            const ponBtn = document.getElementById('ponBtn');
            const kanBtn = document.getElementById('kanBtn');
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šéè¡¨ç¤ºã«ã—ãªã„
            // if (chiBtn) chiBtn.style.display = 'none';
            // if (ponBtn) ponBtn.style.display = 'none';
            // if (kanBtn) kanBtn.style.display = 'none';
        }
        
        socket.on('roomJoined', (data) => {
            console.log('ğŸ® ãƒ«ãƒ¼ãƒ å‚åŠ æˆåŠŸ:', data);
            gameId = data.roomId;
            gameState = data.gameState;
            updateGameDisplay();
        });
        
        socket.on('actionResult', (result) => {
            console.log('âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœ:', result);
            if (result.success) {
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
        });
        
        socket.on('error', (error) => {
            console.error('âŒ Socket.IOã‚¨ãƒ©ãƒ¼:', error);
            showNotification(error.message, 'error');
        });
        
        socket.on('roomError', (error) => {
            console.error('âŒ ãƒ«ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼:', error);
            showNotification(error.message, 'error');
        });

        // éŸ³åŠ¹åˆ¶å¾¡é–¢æ•°
        function toggleSound() {
            const isMuted = soundManager.toggleMute();
            const button = document.getElementById('soundToggle');
            button.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            button.style.background = isMuted ? '#dc3545' : '#28a745';
            showNotification(isMuted ? 'éŸ³åŠ¹ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆã—ã¾ã—ãŸ' : 'éŸ³åŠ¹ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ', 'info');
        }

        function setVolume(value) {
            soundManager.setVolume(value / 100);
            showNotification(`éŸ³é‡: ${value}%`, 'info');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ” DEBUG: DOM loaded, initializing...');
            hideMeldButtons(); // åˆæœŸçŠ¶æ…‹ã§ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            try {
                await soundManager.init();
                console.log('ğŸ” DEBUG: SoundManager initialized');
            } catch (error) {
                console.warn('ğŸ” DEBUG: SoundManager init failed:', error);
            }
            
            // æ¨ã¦ç‰Œãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            addDiscardClickTest();
            console.log('ğŸ” DEBUG: Discard click test initialized');
            
            newGame();
            
            try {
                soundManager.playGameStart();
            } catch (error) {
                console.warn('ğŸ” DEBUG: playGameStart failed:', error);
            }
        });

        // æ–°ã—ã„ã‚²ãƒ¼ãƒ ä½œæˆ
        function newGame() {
            if (!isConnected) {
                showNotification('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            showNotification('æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œæˆä¸­...', 'info');
            
            // Socket.IOã§ãƒ«ãƒ¼ãƒ ä½œæˆè¦æ±‚
            socket.emit('createRoom', {
                playerId: 'player_0',
                playerName: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1'
            });
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
        function updateGameDisplay() {
            if (!gameState) {
                console.log('ğŸ” DEBUG: gameState is null or undefined');
                return;
            }

            // console.log('ğŸ” DEBUG: updateGameDisplay called');
            // console.log('ğŸ” DEBUG: gameState:', gameState);
            // console.log('ğŸ” DEBUG: gameState.players:', gameState.players);
            // console.log('ğŸ” DEBUG: gameState.currentPlayer:', gameState.currentPlayer);

            // åŸºæœ¬æƒ…å ±æ›´æ–°
            try {
                document.getElementById('currentPlayer').textContent = gameState.currentPlayer || '0';
                
                const currentPlayerName = gameState.players && gameState.players[gameState.currentPlayer] 
                    ? gameState.players[gameState.currentPlayer].name 
                    : 'Unknown';
                document.getElementById('currentPlayerName').textContent = currentPlayerName;
                console.log('ğŸ” DEBUG: currentPlayerName:', currentPlayerName);
                document.getElementById('remainingTiles').textContent = gameState.remainingTiles || '0';
                document.getElementById('remainingTilesInfo').textContent = gameState.remainingTiles || '0';
                
                if (gameState.round) {
                    document.getElementById('round').textContent = gameState.round.roundNumber || '1';
                    document.getElementById('honba').textContent = gameState.round.honbaCount || '0';
                    document.getElementById('roundInfo').textContent = `æ±${gameState.round.roundNumber || '1'}å±€ ${gameState.round.honbaCount || '0'}æœ¬å ´`;
                    document.getElementById('gameInfo').textContent = `æ±å ´ ${gameState.round.roundNumber || '1'}å±€`;
                }
                
                document.getElementById('doraIndicator').textContent = gameState.doraIndicators?.[0]?.unicode || 'ğŸ€«';
                
                console.log('ğŸ” DEBUG: Basic info updated successfully');
            } catch (error) {
                console.error('ğŸ” DEBUG: Error updating basic info:', error);
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±æ›´æ–°
            try {
                console.log('ğŸ” DEBUG: Starting player info update');
                if (!gameState.players || !Array.isArray(gameState.players)) {
                    console.error('ğŸ” DEBUG: gameState.players is not an array:', gameState.players);
                    return;
                }
                
                gameState.players.forEach((player, index) => {
                    console.log(`ğŸ” DEBUG: Processing player ${index}:`, player);
                    const playerElement = document.getElementById(`player${index}`);
                    if (!playerElement) {
                        console.warn(`ğŸ” DEBUG: Player element not found: player${index}`);
                        return;
                    }

                // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (index === gameState.currentPlayer) {
                    playerElement.classList.add('current');
                } else {
                    playerElement.classList.remove('current');
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±æ›´æ–°
                const nameElement = playerElement.querySelector('.player-name');
                const windElement = playerElement.querySelector('.player-wind');
                
                if (nameElement) nameElement.textContent = player.name;
                if (windElement) windElement.textContent = player.wind;

                    // æ‰‹ç‰Œæ›´æ–°
                    const handElement = document.getElementById(`hand${index}`);
                    console.log(`ğŸ” DEBUG: handElement for player ${index}:`, handElement);
                    console.log(`ğŸ” DEBUG: player.hand for player ${index}:`, player.hand);
                    console.log(`ğŸ” DEBUG: player.hand.tiles for player ${index}:`, player.hand?.tiles);
                    
                    if (handElement && player.hand && player.hand.tiles) {
                        handElement.innerHTML = '';
                        
                        if (index === 0) {
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç‰Œï¼ˆè¡¨ç¤ºï¼‰
                            console.log(`ğŸ” DEBUG: Updating player 0 hand with ${player.hand.tiles.length} tiles`);
                            player.hand.tiles.forEach((tile, tileIndex) => {
                                const tileElement = document.createElement('div');
                                tileElement.className = 'tile';
                                if (tile.isRed) tileElement.classList.add('red');
                                tileElement.textContent = tile.displayName || tile.unicode;
                                tileElement.onclick = () => selectTile(index, tileIndex, tile);
                                handElement.appendChild(tileElement);
                            });
                            
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è©³ç´°æƒ…å ±æ›´æ–°
                            document.getElementById('handCount').textContent = player.hand.tiles.length;
                            document.getElementById('playerName').textContent = player.name;
                            document.getElementById('playerScore').textContent = player.score;
                            document.getElementById('playerWind').textContent = player.wind;
                            console.log(`ğŸ” DEBUG: Player 0 hand updated successfully with ${player.hand.tiles.length} tiles`);
                        } else {
                            // å¯¾æˆ¦ç›¸æ‰‹ã®æ‰‹ç‰Œï¼ˆè£å‘ãï¼‰
                            console.log(`ğŸ” DEBUG: Updating opponent ${index} hand with ${player.hand.tiles.length} hidden tiles`);
                            for (let i = 0; i < player.hand.tiles.length; i++) {
                                const tileElement = document.createElement('div');
                                tileElement.className = 'opponent-tile';
                                tileElement.textContent = 'ğŸ€«';
                                handElement.appendChild(tileElement);
                            }
                            
                            // CPUç‚¹æ•°æ›´æ–°
                            const scoreElement = document.getElementById(`player${index}Score`);
                            if (scoreElement) {
                                scoreElement.textContent = player.score;
                            }
                        }
                    } else {
                        console.warn(`ğŸ” DEBUG: Cannot update hand for player ${index} - missing handElement or tiles`);
                    }
                });
                
                console.log('ğŸ” DEBUG: Player info update completed');
            } catch (error) {
                console.error('ğŸ” DEBUG: Error updating player info:', error);
            }

            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³æ›´æ–°ï¼ˆæœ¬æ ¼éº»é›€ä»•æ§˜ï¼‰
            if (gameState.players) {
                gameState.players.forEach((player, playerIndex) => {
                    const riverElement = document.getElementById(`river${playerIndex}`);
                    if (riverElement && player.hand && player.hand.discards) {
                        riverElement.innerHTML = '';
                        
                        player.hand.discards.forEach((tile, discardIndex) => {
                            const tileElement = document.createElement('div');
                            tileElement.className = 'river-tile';
                            
                            // èµ¤ç‰Œå‡¦ç†
                            if (tile.isRed) tileElement.classList.add('red');
                            
                            // ãƒªãƒ¼ãƒå®£è¨€ç‰Œã¯æ¨ªå‘ã
                            if (player.hand.riichi && player.hand.riichiTile && 
                                isSameTile(tile, player.hand.riichiTile)) {
                                tileElement.classList.add('reach');
                            }
                            
                            // é³´ã„ãŸç‰Œï¼ˆãƒãƒ¼ãƒ»ãƒãƒ³ãƒ»ã‚«ãƒ³ã§å‘¼ã°ã‚ŒãŸç‰Œï¼‰ã®åˆ¤å®š
                            if (isCalledTile(tile, playerIndex, discardIndex)) {
                                tileElement.classList.add('called');
                            }
                            
                            tileElement.textContent = tile.displayName || tile.unicode;
                            
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã«å¿œã˜ãŸç‰Œã®å›è»¢
                            switch (playerIndex) {
                                case 1: // CPUå—ï¼ˆä¸‹å®¶ï¼‰ï¼šå·¦ã«90åº¦å›è»¢
                                    tileElement.style.transform = 'rotate(-90deg)';
                                    break;
                                case 3: // CPUåŒ—ï¼ˆå¯¾é¢ï¼‰ï¼šå·¦ã«90åº¦å›è»¢
                                    tileElement.style.transform = 'rotate(-90deg)';
                                    break;
                                // case 0ï¼ˆè‡ªåˆ†ï¼‰ã¨case 2ï¼ˆCPUè¥¿ï¼‰ã¯ãã®ã¾ã¾
                            }
                            
                            // 6Ã—3ã‚°ãƒªãƒƒãƒ‰ã®é…ç½®é †åº
                            const gridOrder = calculateRiverOrder(playerIndex, discardIndex);
                            tileElement.style.order = gridOrder;
                            
                            // ãƒ‡ãƒãƒƒã‚°ç”¨: orderå€¤ã‚’è¡¨ç¤º
                            if (playerIndex === 0) {
                                tileElement.setAttribute('data-order', gridOrder);
                            }
                            
                            riverElement.appendChild(tileElement);
                        });
                    }
                });
            }

            // æœ€å¾Œã®æ¨ç‰Œæƒ…å ±ã‚’æ›´æ–°ï¼ˆé³´ãåˆ¤å®šç”¨ï¼‰
            updateLastDiscardedTile();
            
            // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateGameStatus();
            
            // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºæ›´æ–°
            updateMeldDisplay();
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            updateTenpaiStatus();
        }

        // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateMeldDisplay() {
            if (!gameState || !gameState.players) return;
            
            gameState.players.forEach((player, playerIndex) => {
                const meldElement = document.getElementById(`melds${playerIndex}`);
                if (!meldElement || !player.hand || !player.hand.melds) return;
                
                meldElement.innerHTML = '';
                
                player.hand.melds.forEach((meld, meldIndex) => {
                    const meldGroup = document.createElement('div');
                    meldGroup.className = 'meld-group';
                    meldGroup.style.display = 'flex';
                    meldGroup.style.gap = '2px';
                    meldGroup.style.margin = '5px';
                    meldGroup.style.padding = '5px';
                    meldGroup.style.background = 'rgba(255, 255, 255, 0.9)';
                    meldGroup.style.border = '2px solid #007bff';
                    meldGroup.style.borderRadius = '8px';
                    
                    // ãƒ¡ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ãƒ©ãƒ™ãƒ«
                    const typeLabel = document.createElement('div');
                    typeLabel.style.fontSize = '10px';
                    typeLabel.style.color = '#007bff';
                    typeLabel.style.fontWeight = 'bold';
                    typeLabel.style.marginRight = '5px';
                    
                    switch (meld.type) {
                        case 'chi':
                            typeLabel.textContent = 'ãƒãƒ¼';
                            break;
                        case 'pon':
                            typeLabel.textContent = 'ãƒãƒ³';
                            break;
                        case 'kan':
                        case 'ankan':
                        case 'minkan':
                            typeLabel.textContent = 'ã‚«ãƒ³';
                            break;
                    }
                    
                    meldGroup.appendChild(typeLabel);
                    
                    // ãƒ¡ãƒ«ãƒ‰ã®ç‰Œã‚’è¡¨ç¤º
                    meld.tiles.forEach((tile, tileIndex) => {
                        const tileElement = document.createElement('div');
                        tileElement.className = 'meld-tile';
                        tileElement.style.width = '20px';
                        tileElement.style.height = '28px';
                        tileElement.style.border = '1px solid #333';
                        tileElement.style.display = 'flex';
                        tileElement.style.alignItems = 'center';
                        tileElement.style.justifyContent = 'center';
                        tileElement.style.fontSize = '10px';
                        tileElement.style.background = 'white';
                        
                        // æš—æ§“ã®å ´åˆã€ç«¯ã®ç‰Œã¯è£å‘ã
                        if (meld.type === 'ankan' && (tileIndex === 0 || tileIndex === 3)) {
                            tileElement.textContent = 'ğŸ€«';
                            tileElement.style.background = '#e9ecef';
                        } else {
                            tileElement.textContent = tile.displayName || tile.unicode;
                            if (tile.isRed) {
                                tileElement.style.color = '#dc3545';
                                tileElement.style.fontWeight = '800';
                            }
                        }
                        
                        meldGroup.appendChild(tileElement);
                    });
                    
                    meldElement.appendChild(meldGroup);
                });
            });
        }

        // æ²³ã®é…ç½®é †åºè¨ˆç®—ï¼ˆæœ¬æ ¼éº»é›€ä»•æ§˜ï¼‰
        function calculateRiverOrder(playerIndex, discardIndex) {
            const row = Math.floor(discardIndex / 6);
            const col = discardIndex % 6;
            
            switch (playerIndex) {
                case 0: // ä¸‹éƒ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆè‡ªåˆ†ï¼‰ï¼šå·¦ã‹ã‚‰å³ã€ä¸Šã‹ã‚‰ä¸‹ã€6æšã§æ”¹è¡Œ
                    return row * 6 + col;
                case 1: // å·¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå—ï¼‰ï¼šä¸Šã‹ã‚‰ä¸‹ã€å³ã‹ã‚‰å·¦ã€3åˆ—6è¡Œï¼ˆæ¨ªå‘ãè¦–ç‚¹ï¼‰
                    const rowSouth = Math.floor(discardIndex / 6);
                    const colSouth = discardIndex % 6;
                    return colSouth * 6 + rowSouth;
                case 2: // ä¸Šéƒ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆè¥¿ï¼‰ï¼šå³ã‹ã‚‰å·¦ã€ä¸‹ã‹ã‚‰ä¸Šï¼ˆå¯¾é¢è¦–ç‚¹ï¼‰
                    return (2 - row) * 6 + (5 - col);
                case 3: // å³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆåŒ—ï¼‰ï¼šä¸‹ã‹ã‚‰ä¸Šã€å·¦ã‹ã‚‰å³ã€3åˆ—6è¡Œï¼ˆæ¨ªå‘ãè¦–ç‚¹ï¼‰
                    const rowNorth = Math.floor(discardIndex / 6);
                    const colNorth = discardIndex % 6;
                    return (5 - colNorth) * 6 + (2 - rowNorth);
                default:
                    return discardIndex;
            }
        }
        
        // ç‰ŒãŒåŒã˜ã‹ãƒã‚§ãƒƒã‚¯
        function isSameTile(tile1, tile2) {
            if (!tile1 || !tile2) return false;
            if (tile1.suit !== tile2.suit) return false;
            if (tile1.suit === 'ji') {
                return tile1.honor === tile2.honor;
            }
            return tile1.rank === tile2.rank;
        }
        
        // é³´ã„ãŸç‰Œã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isCalledTile(tile, playerIndex, discardIndex) {
            if (!gameState || !gameState.gameLog) return false;
            
            // ã‚²ãƒ¼ãƒ ãƒ­ã‚°ã‹ã‚‰é³´ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
            for (let i = 0; i < gameState.gameLog.length; i++) {
                const log = gameState.gameLog[i];
                
                // ãƒãƒ¼ãƒ»ãƒãƒ³ãƒ»ã‚«ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
                if (log.type === 'meld' && log.calledTile) {
                    // é³´ã„ãŸç‰Œã¨æ¨ç‰Œã®ã‚¿ã‚¤ãƒ«ãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (isSameTile(tile, log.calledTile)) {
                        // é³´ã„ãŸå…ƒã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ç¾åœ¨ã®æ¨ç‰Œä½ç½®ãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (log.fromPlayer === playerIndex) {
                            return true;
                        }
                    }
                }
            }
            
            return false;
        }
        
        // æœ€å¾Œã®æ¨ç‰Œæƒ…å ±ã‚’æ›´æ–°
        function updateLastDiscardedTile() {
            if (!gameState) return;
            
            console.log('ğŸ”§ updateLastDiscardedTile called');
            console.log('ğŸ”§ gameState.lastDiscard:', gameState.lastDiscard);
            console.log('ğŸ”§ gameState.lastDiscardPlayer:', gameState.lastDiscardPlayer);
            
            // gameStateã‹ã‚‰ç›´æ¥å–å¾—ã‚’è©¦ã™
            if (gameState.lastDiscard && gameState.lastDiscardPlayer !== undefined && gameState.lastDiscardPlayer !== null) {
                lastDiscardedTile = gameState.lastDiscard;
                lastDiscardedPlayer = gameState.lastDiscardPlayer;
                console.log(`ğŸ”§ Last discard from gameState: ${lastDiscardedTile.displayName} by player ${lastDiscardedPlayer}`);
                return;
            }
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
            // console.log(`ğŸ”§ [DEBUG] gameState.lastDiscard:`, gameState.lastDiscard);
            // console.log(`ğŸ”§ [DEBUG] gameState.lastDiscardPlayer:`, gameState.lastDiscardPlayer);
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚²ãƒ¼ãƒ ãƒ­ã‚°ã‚’é€†é †ã§æ¤œç´¢ã—ã¦æœ€å¾Œã®æ¨ç‰Œã‚’è¦‹ã¤ã‘ã‚‹
            if (gameState.gameLog) {
                for (let i = gameState.gameLog.length - 1; i >= 0; i--) {
                    const log = gameState.gameLog[i];
                    if (log.type === 'discard' && log.data && log.data.tile) {
                        lastDiscardedTile = log.data.tile;
                        lastDiscardedPlayer = parseInt(log.playerId.replace('player_', ''));
                        console.log(`ğŸ”§ Last discard from log: ${log.data.tile.displayName} by player ${lastDiscardedPlayer}`);
                        return;
                    }
                }
            }
            
            // æ¨ç‰ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
            lastDiscardedTile = null;
            lastDiscardedPlayer = null;
            // console.log(`ğŸ”§ No last discard found, reset to null`);
        }

        // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateGameStatus() {
            const statusElement = document.getElementById('gameStatus');
            if (!gameState || !statusElement) return;

            const currentPlayerName = gameState.players[gameState.currentPlayer]?.name;
            const playerHand = gameState.players[0].hand.tiles;
            const handCount = playerHand ? playerHand.length : 0;
            const isMyTurn = gameState.currentPlayer === 0;
            
            let statusText = `${currentPlayerName}ã®ã‚¿ãƒ¼ãƒ³`;
            if (isMyTurn) {
                if (handCount === 13) {
                    statusText = 'ãƒ„ãƒ¢ã—ã¦ãã ã•ã„';
                } else if (handCount === 14) {
                    statusText = 'æ‰“ç‰Œã—ã¦ãã ã•ã„';
                }
            }
            
            statusElement.textContent = statusText;
            statusElement.style.color = isMyTurn ? '#28a745' : '#6c757d';
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            updateActionButtons();
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        function updateActionButtons() {
            if (!gameState) return;
            
            const isMyTurn = gameState.currentPlayer === 0;
            const player = gameState.players?.[0];
            const handCount = player?.hand?.tiles?.length || 0;
            
            // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆlastDiscardedTileãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            const hasMeldOpportunity = lastDiscardedTile && lastDiscardedTile.playerId !== 0;
            
            // åŸºæœ¬ãƒœã‚¿ãƒ³åˆ¶å¾¡
            const drawBtn = document.getElementById('drawBtn');
            const discardBtn = document.getElementById('discardBtn');
            const riichiBtn = document.getElementById('riichiBtn');
            const tsumoBtn = document.getElementById('tsumoBtn');
            
            if (drawBtn) drawBtn.style.display = (isMyTurn && handCount === 13) ? 'inline-block' : 'none';
            if (discardBtn) discardBtn.style.display = (isMyTurn && handCount === 14) ? 'inline-block' : 'none';
            if (riichiBtn) riichiBtn.style.display = (isMyTurn && handCount === 14 && canCallRiichi()) ? 'inline-block' : 'none';
            if (tsumoBtn) tsumoBtn.style.display = (isMyTurn && handCount === 14 && canCallTsumo()) ? 'inline-block' : 'none';
            
            // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã‚‚è¡¨ç¤ºå¯èƒ½
            const chiBtn = document.getElementById('chiBtn');
            const ponBtn = document.getElementById('ponBtn');
            const kanBtn = document.getElementById('kanBtn');
            const ronBtn = document.getElementById('ronBtn');
            
            // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã®æ¡ä»¶è¡¨ç¤ºï¼ˆãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šãŒã‚ã‚‹å ´åˆã¯æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ä¿æŒï¼‰
            // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šãŒãªã„å ´åˆã®ã¿éè¡¨ç¤ºã«ã™ã‚‹
            if (chiBtn && !hasMeldOpportunity) chiBtn.style.display = 'none';  
            if (ponBtn && !hasMeldOpportunity) ponBtn.style.display = 'none';  
            if (kanBtn && !hasMeldOpportunity) kanBtn.style.display = 'none';
            if (ronBtn) ronBtn.style.display = (!isMyTurn && canCallRon()) ? 'inline-block' : 'none';
            
            // æ¨ã¦ç‰Œæ›´æ–°ã‚’è¿½è·¡
            trackDiscardUpdates();
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function canCallRiichi() {
            if (!gameState || !gameState.players[0]) return false;
            const player = gameState.players[0];
            return !player.hand.riichi && player.score >= 1000; // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ãªã„ã€1000ç‚¹ä»¥ä¸Šã‚ã‚‹
        }
        
        function canCallTsumo() {
            if (!gameState || !gameState.players[0]) return false;
            
            const player = gameState.players[0];
            const handCount = player.hand.tiles.length;
            
            // 14æšã§ãªã„ã¨ãƒ„ãƒ¢ã§ããªã„
            if (handCount !== 14) return false;
            
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ãªã„ã¨ãƒ„ãƒ¢ã§ããªã„
            if (gameState.currentPlayer !== 0) return false;
            
            // ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼šå®Ÿéš›ã®åˆ¤å®šã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è¡Œã†
            return true;
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤åˆ¤å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function checkClientTenpai() {
            if (!gameState || !gameState.players[0]) {
                return { isTenpai: false, waitingTiles: [] };
            }
            
            const player = gameState.players[0];
            const handCount = player.hand.tiles.length + (player.hand.melds.length * 3);
            
            // 13æšã®å ´åˆã®ã¿ãƒ†ãƒ³ãƒ‘ã‚¤ãƒã‚§ãƒƒã‚¯
            if (handCount !== 13) {
                return { isTenpai: false, waitingTiles: [] };
            }
            
            // ç°¡æ˜“çš„ãªãƒ†ãƒ³ãƒ‘ã‚¤åˆ¤å®š
            // å®Ÿéš›ã®è©³ç´°åˆ¤å®šã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è¡Œã†
            const tiles = player.hand.tiles;
            
            // åŸºæœ¬çš„ãªå½¢ã®ç¢ºèªï¼ˆéå¸¸ã«ç°¡æ˜“ç‰ˆï¼‰
            // å®Ÿè£…ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã€ã¨ã‚Šã‚ãˆãšæ‰‹ç‰ŒãŒ13æšã§ç‰¹å®šæ¡ä»¶ã‚’æº€ãŸã™å ´åˆã«ãƒ†ãƒ³ãƒ‘ã‚¤ã¨ã™ã‚‹
            
            // ç‰Œã®ç¨®é¡ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const tileCounts = {};
            for (const tile of tiles) {
                const key = tile.honor ? `ji_${tile.honor}` : `${tile.suit}_${tile.rank}`;
                tileCounts[key] = (tileCounts[key] || 0) + 1;
            }
            
            // å¯¾å­ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            let pairCount = 0;
            let tripleCount = 0;
            for (const count of Object.values(tileCounts)) {
                if (count === 2) pairCount++;
                if (count === 3) tripleCount++;
            }
            
            // éå¸¸ã«ç°¡æ˜“çš„ãªåˆ¤å®šï¼šå¯¾å­ãŒè¤‡æ•°ã‚ã‚‹ã‹ã€åˆ»å­ãŒã‚ã‚‹å ´åˆã«ãƒ†ãƒ³ãƒ‘ã‚¤ã®å¯èƒ½æ€§
            const isPossiblyTenpai = pairCount >= 1 || tripleCount >= 1;
            
            if (isPossiblyTenpai) {
                // ç°¡æ˜“çš„ãªå¾…ã¡ç‰Œç”Ÿæˆï¼ˆå®Ÿéš›ã¯ã‚‚ã£ã¨è¤‡é›‘ï¼‰
                const waitingTiles = [
                    { suit: 'man', rank: 1, displayName: '1ä¸‡' },
                    { suit: 'pin', rank: 1, displayName: '1ç­’' },
                    { suit: 'sou', rank: 1, displayName: '1ç´¢' }
                ];
                
                return { isTenpai: true, waitingTiles };
            }
            
            return { isTenpai: false, waitingTiles: [] };
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹ã‚’æ›´æ–°ãƒ»è¡¨ç¤º
        function updateTenpaiStatus() {
            if (!gameState || !gameState.players[0]) return;
            
            const newTenpaiStatus = checkClientTenpai();
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿æ›´æ–°
            if (newTenpaiStatus.isTenpai !== currentTenpaiStatus.isTenpai) {
                currentTenpaiStatus = newTenpaiStatus;
                
                if (currentTenpaiStatus.isTenpai) {
                    const waitingText = currentTenpaiStatus.waitingTiles.map(t => t.displayName).join('ãƒ»');
                    showNotification(`ãƒ†ãƒ³ãƒ‘ã‚¤ï¼ å¾…ã¡: ${waitingText}`, 'info');
                    console.log('ğŸ¯ ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹:', currentTenpaiStatus);
                } else {
                    console.log('ğŸ¯ ãƒ†ãƒ³ãƒ‘ã‚¤è§£é™¤');
                }
            }
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã®æ›´æ–°
            displayTenpaiStatus();
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤º
        function displayTenpaiStatus() {
            // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
            let tenpaiDisplay = document.getElementById('tenpaiDisplay');
            if (!tenpaiDisplay) {
                tenpaiDisplay = document.createElement('div');
                tenpaiDisplay.id = 'tenpaiDisplay';
                tenpaiDisplay.style.cssText = `
                    position: fixed;
                    top: 120px;
                    right: 20px;
                    background: rgba(255, 193, 7, 0.9);
                    color: #212529;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-weight: bold;
                    font-size: 0.9rem;
                    z-index: 1000;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    border: 2px solid #ffc107;
                `;
                document.body.appendChild(tenpaiDisplay);
            }
            
            if (currentTenpaiStatus.isTenpai) {
                const waitingText = currentTenpaiStatus.waitingTiles.map(t => t.displayName).join('ãƒ»');
                tenpaiDisplay.innerHTML = `
                    ğŸ¯ ãƒ†ãƒ³ãƒ‘ã‚¤<br>
                    <small>å¾…ã¡: ${waitingText}</small>
                `;
                tenpaiDisplay.style.display = 'block';
            } else {
                tenpaiDisplay.style.display = 'none';
            }
        }
        
        function canCallChi() {
            if (!gameState || !gameState.players[0] || !lastDiscardedTile) return false;
            
            // ãƒãƒ¼ã¯å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã®ã¿å¯èƒ½
            const prevPlayer = (gameState.currentPlayer + 3) % 4;
            if (lastDiscardedPlayer !== prevPlayer) return false;
            
            // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹å ´åˆã¯é³´ã‘ãªã„
            if (gameState.players[0].hand.riichi) return false;
            
            // ç°¡æ˜“åˆ¤å®š: åŒã˜ã‚¹ãƒ¼ãƒˆï¼ˆjiä»¥å¤–ï¼‰ã§é€£ç¶šã™ã‚‹ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const discardedTile = lastDiscardedTile;
            if (discardedTile.suit === 'ji') return false; // å­—ç‰Œã¯ãƒãƒ¼ä¸å¯
            
            const myTiles = gameState.players[0].hand.tiles;
            const targetRank = discardedTile.rank;
            
            // é€£ç¶šã™ã‚‹ç‰Œã®çµ„ã¿åˆã‚ã›ã‚’ãƒã‚§ãƒƒã‚¯
            const hasSequence = myTiles.some((tile1, i) => 
                myTiles.some((tile2, j) => {
                    if (i >= j) return false;
                    if (tile1.suit !== discardedTile.suit || tile2.suit !== discardedTile.suit) return false;
                    
                    // 3ã¤ã®æ•°å­—ã®çµ„ã¿åˆã‚ã›ã‚’ãƒã‚§ãƒƒã‚¯
                    const ranks = [tile1.rank, tile2.rank, targetRank].sort((a, b) => a - b);
                    return ranks[0] + 1 === ranks[1] && ranks[1] + 1 === ranks[2];
                })
            );
            
            return hasSequence;
        }
        
        function canCallPon() {
            if (!gameState || !gameState.players[0] || !lastDiscardedTile) return false;
            
            // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹å ´åˆã¯é³´ã‘ãªã„
            if (gameState.players[0].hand.riichi) return false;
            
            // åŒã˜ç‰ŒãŒ2æšä»¥ä¸Šæ‰‹ç‰Œã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const discardedTile = lastDiscardedTile;
            const myTiles = gameState.players[0].hand.tiles;
            
            let matchCount = 0;
            for (const tile of myTiles) {
                if (isSameTile(tile, discardedTile)) {
                    matchCount++;
                    if (matchCount >= 2) return true;
                }
            }
            
            return false;
        }
        
        function canCallKan() {
            if (!gameState || !gameState.players[0]) return false;
            
            // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹å ´åˆã¯é³´ã‘ãªã„ï¼ˆæš—æ§“ã¯ä¾‹å¤–ã ãŒç°¡ç•¥åŒ–ï¼‰
            if (gameState.players[0].hand.riichi) return false;
            
            const myTiles = gameState.players[0].hand.tiles;
            
            // åŒã˜ç‰ŒãŒ4æšã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæš—æ§“ï¼‰
            const tileCounts = {};
            for (const tile of myTiles) {
                const key = `${tile.suit}_${tile.rank}_${tile.honor}`;
                tileCounts[key] = (tileCounts[key] || 0) + 1;
                if (tileCounts[key] >= 4) return true;
            }
            
            // æ˜æ§“ã®å ´åˆï¼ˆç›¸æ‰‹ã®æ¨ç‰Œ+æ‰‹ç‰Œ3æšï¼‰
            if (lastDiscardedTile) {
                let matchCount = 0;
                for (const tile of myTiles) {
                    if (isSameTile(tile, lastDiscardedTile)) {
                        matchCount++;
                        if (matchCount >= 3) return true;
                    }
                }
            }
            
            return false;
        }
        
        function canCallRon() {
            if (!gameState || !gameState.players[0] || !lastDiscardedTile) return false;
            
            const player = gameState.players[0];
            const handCount = player.hand.tiles.length;
            
            // 13æšã§ãªã„ã¨ãƒ­ãƒ³ã§ããªã„
            if (handCount !== 13) return false;
            
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã¯ãƒ­ãƒ³ã§ããªã„
            if (gameState.currentPlayer === 0) return false;
            
            // ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼šå®Ÿéš›ã®åˆ¤å®šã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è¡Œã†
            return true;
        }

        // ç‰Œé¸æŠ
        function selectTile(playerIndex, tileIndex, tile) {
            if (playerIndex !== 0) {
                showNotification('è‡ªåˆ†ã®ç‰Œã®ã¿é¸æŠã§ãã¾ã™', 'warning');
                return;
            }
            
            if (gameState && gameState.currentPlayer !== 0) {
                showNotification('ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            // é¸æŠè§£é™¤
            document.querySelectorAll('.tile.selected').forEach(t => t.classList.remove('selected'));

            // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ç‰Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯æ‰“ç‰Œ
            if (selectedTile && selectedTile.tileIndex === tileIndex && selectedTile.tile.id === tile.id) {
                discardSelected();
                return;
            }

            // æ–°ã—ã„ç‰Œã‚’é¸æŠ
            selectedTile = { playerIndex, tileIndex, tile };
            document.getElementById('hand0').children[tileIndex].classList.add('selected');
            soundManager.playSound('tileSelect');
            showNotification(`${tile.displayName || tile.unicode} ã‚’é¸æŠï¼ˆå†ã‚¯ãƒªãƒƒã‚¯ã§æ‰“ç‰Œï¼‰`, 'info');
        }

        // æ‰“ç‰Œå‡¦ç†
        function discardSelected() {
            if (!selectedTile || !gameId || !isConnected) {
                showNotification('ç‰Œã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            console.log('ğŸ¯ æ‰“ç‰Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡:', selectedTile.tile);
            socket.emit('playerAction', {
                type: 'discard',
                playerId: 'player_0',
                tileId: selectedTile.tile.id,
                priority: 1,
                timestamp: Date.now()
            });
            
            selectedTile = null;
            soundManager.playSound('tilePlace');
        }

        // ãƒ„ãƒ¢å‡¦ç†
        function drawTile() {
            if (!gameId || !isConnected) {
                showNotification('ã‚²ãƒ¼ãƒ ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('ğŸ¯ ãƒ„ãƒ¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'draw',
                playerId: 'player_0',
                priority: 1,
                timestamp: Date.now()
            });
            
            soundManager.playSound('tilePlace');
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹å–å¾—
        function requestGameState() {
            if (!gameId || !isConnected) {
                showNotification('ã‚²ãƒ¼ãƒ ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('ğŸ”„ ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ');
            socket.emit('requestGameState');
        }

        // AIå®Ÿè¡Œ
        async function executeAI() {
            if (!gameId) return;
            
            try {
                const response = await fetch(`/api/game/${gameId}/ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.status === 'OK') {
                    gameState = result.data.gameState;
                    updateGameDisplay();
                    soundManager.playSound('tilePlace');
                    showNotification(result.message || 'AI ãŒè¡Œå‹•ã—ã¾ã—ãŸ', 'success');
                } else {
                    showNotification(result.message || 'AIå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('AI error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // é³´ãé–¢æ•°
        // ãƒãƒ¼
        async function callChi() {
            console.log('ğŸ¯ callChi() called');
            console.log('ğŸ¯ gameState:', !!gameState);
            console.log('ğŸ¯ lastDiscardedTile:', lastDiscardedTile);
            console.log('ğŸ¯ lastDiscardedPlayer:', lastDiscardedPlayer);
            
            if (!gameState || !lastDiscardedTile) {
                console.log('ğŸ¯ Chi early return - missing gameState or lastDiscardedTile');
                showNotification('ãƒãƒ¼ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // æ‰‹ç‰Œã‹ã‚‰ãƒãƒ¼ã«ä½¿ç”¨ã™ã‚‹ç‰Œã‚’è¦‹ã¤ã‘ã‚‹
                const myTiles = gameState.players[0].hand.tiles;
                const targetRank = lastDiscardedTile.rank;
                
                // é€£ç¶šã™ã‚‹ç‰Œã®çµ„ã¿åˆã‚ã›ã‚’æ¢ã™
                let chiTiles = null;
                for (let i = 0; i < myTiles.length - 1; i++) {
                    for (let j = i + 1; j < myTiles.length; j++) {
                        const tile1 = myTiles[i];
                        const tile2 = myTiles[j];
                        
                        if (tile1.suit !== lastDiscardedTile.suit || tile2.suit !== lastDiscardedTile.suit) continue;
                        if (tile1.suit === 'ji') continue; // å­—ç‰Œã¯ãƒãƒ¼ä¸å¯
                        
                        const ranks = [tile1.rank, tile2.rank, targetRank].sort((a, b) => a - b);
                        if (ranks[0] + 1 === ranks[1] && ranks[1] + 1 === ranks[2]) {
                            chiTiles = [tile1, tile2];
                            break;
                        }
                    }
                    if (chiTiles) break;
                }
                
                if (!chiTiles) {
                    showNotification('ãƒãƒ¼ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const meld = {
                    id: `chi_${Date.now()}_player0`,
                    type: 'chi',
                    tiles: [...chiTiles, lastDiscardedTile],
                    fromPlayer: lastDiscardedPlayer,
                    isConcealed: false,
                    calledTile: lastDiscardedTile
                };

                console.log('ğŸ¯ ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
                socket.emit('playerAction', {
                    type: 'chi',
                    playerId: 'player_0',
                    meld: meld,
                    tile: lastDiscardedTile,
                    priority: 2,
                    timestamp: Date.now()
                });
                
                soundManager.playSound('meld');
            } catch (error) {
                console.error('Chi error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒãƒ³
        async function callPon() {
            console.log('ğŸ¯ callPon() called');
            console.log('ğŸ¯ gameState:', !!gameState);
            console.log('ğŸ¯ lastDiscardedTile:', lastDiscardedTile);
            console.log('ğŸ¯ lastDiscardedPlayer:', lastDiscardedPlayer);
            
            if (!gameState || !lastDiscardedTile) {
                console.log('ğŸ¯ Pon early return - missing gameState or lastDiscardedTile');
                showNotification('ãƒãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // æ‰‹ç‰Œã‹ã‚‰åŒã˜ç‰Œã‚’2æšæ¢ã™
                const myTiles = gameState.players[0].hand.tiles;
                const matchingTiles = [];
                
                for (const tile of myTiles) {
                    if (isSameTile(tile, lastDiscardedTile)) {
                        matchingTiles.push(tile);
                        if (matchingTiles.length >= 2) break;
                    }
                }
                
                if (matchingTiles.length < 2) {
                    showNotification('ãƒãƒ³ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const meld = {
                    id: `pon_${Date.now()}_player0`,
                    type: 'pon',
                    tiles: [...matchingTiles, lastDiscardedTile],
                    fromPlayer: lastDiscardedPlayer,
                    isConcealed: false,
                    calledTile: lastDiscardedTile
                };

                console.log('ğŸ¯ ãƒãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
                console.log('ğŸ€„ [PON DEBUG] lastDiscardedTile:', lastDiscardedTile);
                console.log('ğŸ€„ [PON DEBUG] matchingTiles:', matchingTiles);
                console.log('ğŸ€„ [PON DEBUG] meld:', meld);
                console.log('ğŸ€„ [PON DEBUG] currentPlayer:', gameState.currentPlayer);
                console.log('ğŸ€„ [PON DEBUG] lastDiscardedPlayer:', lastDiscardedPlayer);
                
                socket.emit('playerAction', {
                    type: 'pon',
                    playerId: 'player_0',
                    meld: meld,
                    tile: lastDiscardedTile,
                    priority: 2,
                    timestamp: Date.now()
                });
                
                soundManager.playSound('meld');
            } catch (error) {
                console.error('Pon error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚«ãƒ³
        async function callKan() {
            if (!gameState) {
                showNotification('ã‚«ãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const myTiles = gameState.players[0].hand.tiles;
                let kanTiles = [];
                let kanType = null;
                
                // æ˜æ§“ã®å ´åˆï¼ˆç›¸æ‰‹ã®æ¨ç‰Œ+æ‰‹ç‰Œ3æšï¼‰
                if (lastDiscardedTile) {
                    const matchingTiles = [];
                    for (const tile of myTiles) {
                        if (isSameTile(tile, lastDiscardedTile)) {
                            matchingTiles.push(tile);
                            if (matchingTiles.length >= 3) break;
                        }
                    }
                    
                    if (matchingTiles.length >= 3) {
                        kanTiles = [...matchingTiles, lastDiscardedTile];
                        kanType = 'kan';
                    }
                }
                
                // æš—æ§“ã®å ´åˆï¼ˆæ‰‹ç‰Œ4æšï¼‰
                if (kanTiles.length === 0) {
                    const tileCounts = {};
                    for (const tile of myTiles) {
                        const key = `${tile.suit}_${tile.rank}_${tile.honor}`;
                        if (!tileCounts[key]) tileCounts[key] = [];
                        tileCounts[key].push(tile);
                    }
                    
                    for (const [key, tiles] of Object.entries(tileCounts)) {
                        if (tiles.length >= 4) {
                            kanTiles = tiles.slice(0, 4);
                            kanType = 'ankan';
                            break;
                        }
                    }
                }
                
                if (kanTiles.length === 0) {
                    showNotification('ã‚«ãƒ³ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const meld = {
                    id: `kan_${Date.now()}_player0`,
                    type: kanType,
                    tiles: kanTiles,
                    fromPlayer: kanType === 'ankan' ? 0 : lastDiscardedPlayer,
                    isConcealed: kanType === 'ankan',
                    calledTile: kanType === 'ankan' ? null : lastDiscardedTile
                };

                console.log('ğŸ¯ ã‚«ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
                socket.emit('playerAction', {
                    type: kanType,
                    playerId: 'player_0',
                    meld: meld,
                    tile: kanType === 'ankan' ? kanTiles[0] : lastDiscardedTile,
                    priority: 3,
                    timestamp: Date.now()
                });
                
                soundManager.playSound('meld');
            } catch (error) {
                console.error('Kan error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ„ãƒ¢å’Œäº†
        function callTsumo() {
            if (!gameState || gameState.currentPlayer !== 0) {
                showNotification('ãƒ„ãƒ¢ã§ãã¾ã›ã‚“ï¼ˆã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            console.log('ğŸ¯ ãƒ„ãƒ¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'tsumo',
                playerId: 'player_0',
                priority: 5,
                timestamp: Date.now()
            });
            
            soundManager.playSound('tilePlace');
        }

        // ãƒ­ãƒ³å’Œäº†
        function callRon() {
            if (!gameState || gameState.currentPlayer === 0) {
                showNotification('ãƒ­ãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('ğŸ¯ ãƒ­ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'ron',
                playerId: 'player_0',
                priority: 5,
                timestamp: Date.now()
            });
            
            soundManager.playSound('tilePlace');
        }

        // ãƒªãƒ¼ãƒ
        function callRiichi() {
            if (!gameState || gameState.currentPlayer !== 0) {
                showNotification('ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“ï¼ˆã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            if (!canCallRiichi()) {
                showNotification('ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“ï¼ˆæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            // ãƒªãƒ¼ãƒæ£’æ¼”å‡º
            showRiichiStick();
            
            performAction('riichi', {}, (result) => {
                if (result.success) {
                    showNotification('ãƒªãƒ¼ãƒï¼', 'success');
                    requestGameState();
                } else {
                    showNotification(`ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“: ${result.error}`, 'error');
                    hideRiichiStick(); // å¤±æ•—æ™‚ã¯æ£’ã‚’éš ã™
                }
            });
        }
        
        // ãƒªãƒ¼ãƒæ£’æ¼”å‡º
        function showRiichiStick() {
            const riichiStick = document.getElementById('riichiStick');
            if (riichiStick) {
                riichiStick.style.display = 'block';
                riichiStick.style.animation = 'riichiPlace 0.5s ease-out';
                riichiStick.textContent = '1000ç‚¹æ£’';
            }
        }
        
        function hideRiichiStick() {
            const riichiStick = document.getElementById('riichiStick');
            if (riichiStick) {
                riichiStick.style.display = 'none';
            }
        }
        
        // å¹ãå‡ºã—è¡¨ç¤ºæ©Ÿèƒ½
        function showSpeechBubble(playerIndex, message, duration = 2000) {
            const bubble = document.getElementById(`speechBubble${playerIndex}`);
            if (bubble) {
                bubble.textContent = message;
                bubble.style.display = 'block';
                bubble.style.animation = 'speechAppear 0.3s ease-out';
                
                // ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•éè¡¨ç¤º
                setTimeout(() => {
                    bubble.style.display = 'none';
                }, duration);
            }
        }
        
        // ãƒ¡ãƒ«ãƒ‰å®£è¨€ç”¨ã®å¹ãå‡ºã—
        function showMeldAnnouncement(playerIndex, meldType, tiles) {
            let message = '';
            switch (meldType) {
                case 'chi':
                    message = 'ãƒãƒ¼ï¼';
                    break;
                case 'pon':
                    message = 'ãƒãƒ³ï¼';
                    break;
                case 'kan':
                    message = 'ã‚«ãƒ³ï¼';
                    break;
                case 'riichi':
                    message = 'ãƒªãƒ¼ãƒï¼';
                    break;
                case 'tsumo':
                    message = 'ãƒ„ãƒ¢ï¼';
                    break;
                case 'ron':
                    message = 'ãƒ­ãƒ³ï¼';
                    break;
                default:
                    message = meldType;
            }
            showSpeechBubble(playerIndex, message, 3000);
        }
        
        // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½
        function updateMeldDisplay() {
            if (!gameState || !gameState.players) return;
            
            gameState.players.forEach((player, playerIndex) => {
                const meldArea = document.getElementById(`melds${playerIndex}`);
                if (!meldArea) return;
                
                meldArea.innerHTML = '';
                
                if (player.hand && player.hand.melds) {
                    player.hand.melds.forEach((meld, meldIndex) => {
                        const meldGroup = createMeldDisplay(meld);
                        meldArea.appendChild(meldGroup);
                    });
                }
            });
        }
        
        function createMeldDisplay(meld) {
            const meldGroup = document.createElement('div');
            meldGroup.className = `meld-group ${meld.type}`;
            
            // ãƒ¡ãƒ«ãƒ‰ãƒ©ãƒ™ãƒ«
            const label = document.createElement('div');
            label.className = 'meld-label';
            label.textContent = meld.type.toUpperCase();
            meldGroup.appendChild(label);
            
            // ãƒ¡ãƒ«ãƒ‰ã®ç‰Œè¡¨ç¤º
            meld.tiles.forEach((tile, tileIndex) => {
                const tileElement = document.createElement('div');
                tileElement.className = 'meld-tile';
                
                if (tile.isRed) tileElement.classList.add('red');
                
                // é³´ã„ãŸç‰Œã¯æ¨ªå‘ãï¼ˆãƒãƒ¼ãƒ»ãƒãƒ³ã®å ´åˆã€æœ€å¾Œã®ç‰Œï¼‰
                if (meld.type !== 'kan' && tileIndex === meld.tiles.length - 1) {
                    tileElement.classList.add('called');
                }
                
                tileElement.textContent = tile.displayName || tile.unicode;
                meldGroup.appendChild(tileElement);
            });
            
            return meldGroup;
        }

        function toggleDebug() {
            debugMode = !debugMode;
            showNotification(debugMode ? 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ON' : 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰OFF', 'info');
        }

        // CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        let cpuAutoMode = false;
        function toggleCpuAuto() {
            if (!gameId) {
                showNotification('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            cpuAutoMode = !cpuAutoMode;
            const btn = document.getElementById('cpuAutoBtn');
            
            if (cpuAutoMode) {
                btn.textContent = 'CPUè‡ªå‹•åœæ­¢';
                btn.className = 'btn btn-danger';
                showNotification('ğŸ¤– CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«CPUè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/cpu-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: true,
                        speed: 400
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        console.log('âœ… CPUè‡ªå‹•å¯¾æˆ¦é–‹å§‹:', data.message);
                        // å®šæœŸçš„ã«ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
                        startCpuAutoMonitoring();
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('âŒ CPUè‡ªå‹•å¯¾æˆ¦é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('CPUè‡ªå‹•å¯¾æˆ¦é–‹å§‹å¤±æ•—: ' + error.message, 'error');
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    cpuAutoMode = false;
                    btn.textContent = 'CPUè‡ªå‹•é–‹å§‹';
                    btn.className = 'btn btn-success';
                });
            } else {
                btn.textContent = 'CPUè‡ªå‹•é–‹å§‹';
                btn.className = 'btn btn-success';
                showNotification('ğŸ›‘ CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰åœæ­¢', 'warning');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«CPUè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰åœæ­¢ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/cpu-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: false
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ›‘ CPUè‡ªå‹•å¯¾æˆ¦åœæ­¢:', data.message);
                    stopCpuAutoMonitoring();
                })
                .catch(error => {
                    console.error('âŒ CPUè‡ªå‹•å¯¾æˆ¦åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                });
            }
        }

        // CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ç›£è¦–
        let cpuAutoInterval = null;
        function startCpuAutoMonitoring() {
            if (cpuAutoInterval) clearInterval(cpuAutoInterval);
            
            cpuAutoInterval = setInterval(() => {
                if (cpuAutoMode && gameId) {
                    requestGameState();
                }
            }, 2000); // 2ç§’ã”ã¨ã«çŠ¶æ…‹ç¢ºèª
        }

        function stopCpuAutoMonitoring() {
            if (cpuAutoInterval) {
                clearInterval(cpuAutoInterval);
                cpuAutoInterval = null;
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        let playerAutoMode = false;
        function togglePlayerAuto() {
            if (!gameId) {
                showNotification('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            playerAutoMode = !playerAutoMode;
            const btn = document.getElementById('playerAutoBtn');
            
            if (playerAutoMode) {
                btn.textContent = 'ã‚ªãƒ¼ãƒˆåˆ‡OFF';
                btn.className = 'btn btn-primary';
                showNotification('ğŸ¯ ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/player-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        console.log('âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šé–‹å§‹:', data.message);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šé–‹å§‹å¤±æ•—: ' + error.message, 'error');
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    playerAutoMode = false;
                    btn.textContent = 'ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Š';
                    btn.className = 'btn btn-secondary';
                });
            } else {
                btn.textContent = 'ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Š';
                btn.className = 'btn btn-secondary';
                showNotification('ğŸ›‘ ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šãƒ¢ãƒ¼ãƒ‰åœæ­¢', 'warning');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰åœæ­¢ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/player-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: false
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ›‘ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šåœæ­¢:', data.message);
                })
                .catch(error => {
                    console.error('âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šåœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                });
            }
        }

        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°ç¾¤
        function forceCPUTurn() {
            if (!gameState) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            const currentPlayer = gameState.players[gameState.currentPlayer];
            if (currentPlayer && currentPlayer.name.includes('CPU')) {
                executeAI();
                showNotification(`${currentPlayer.name}ã®ã‚¿ãƒ¼ãƒ³ã‚’å¼·åˆ¶å®Ÿè¡Œ`, 'info');
            } else {
                showNotification('ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯CPUã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
        }

        function showGameLog() {
            if (!gameState || !gameState.gameLog) {
                console.log('ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ­ã‚°: ãªã—');
                showNotification('ã‚²ãƒ¼ãƒ ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            console.log('ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ­ã‚°:', gameState.gameLog);
            console.log('ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ­ã‚°è©³ç´°:');
            gameState.gameLog.forEach((log, index) => {
                console.log(`  ${index + 1}. [${log.type}] ${log.description}`, log);
            });
            showNotification(`ã‚²ãƒ¼ãƒ ãƒ­ã‚°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º (${gameState.gameLog.length}ä»¶)`, 'info');
        }

        function toggleDebugMode() {
            debugMode = !debugMode;
            showNotification(debugMode ? 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ON' : 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰OFF', 'info');
        }

        function skipToNextPlayer() {
            if (!gameState) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            const nextPlayer = (gameState.currentPlayer + 1) % 4;
            console.log(`â­ï¸ æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¼·åˆ¶ç§»è¡Œ: ${gameState.currentPlayer} â†’ ${nextPlayer}`);
            showNotification(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${nextPlayer}ã®ã‚¿ãƒ¼ãƒ³ã«ç§»è¡Œ`, 'info');
        }

        function showDiscards() {
            if (!gameState) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            console.log('ğŸ—‚ï¸ æ¨ã¦ç‰Œæƒ…å ±:');
            gameState.players.forEach((player, index) => {
                console.log(`  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${index} (${player.name}): `, player.hand.discards);
            });
            if (gameState.gameLog) {
                const discardLogs = gameState.gameLog.filter(log => log.type === 'discard');
                console.log(`ğŸ—‚ï¸ ã‚²ãƒ¼ãƒ ãƒ­ã‚°å†…ã®æ¨ã¦ç‰Œ: ${discardLogs.length}ä»¶`, discardLogs);
            }
            showNotification('æ¨ã¦ç‰Œæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º', 'info');
        }
        
        // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤º
        async function showErrorLogs() {
            try {
                const response = await fetch('/api/logs/error');
                const result = await response.json();
                
                if (result.status === 'OK') {
                    console.log('ğŸ“‹ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° (æœ€æ–°50è¡Œ):');
                    console.log('=' .repeat(60));
                    console.log(result.logs || 'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“');
                    console.log('=' .repeat(60));
                    showNotification('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã—ã¾ã—ãŸ', 'info');
                } else {
                    console.error('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å–å¾—å¤±æ•—:', result.message);
                    showNotification('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function clearConsole() {
            console.clear();
            showNotification('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // æ¨ã¦ç‰Œåº§æ¨™ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        function testDiscardCoordinates() {
            console.log('ğŸ¯ æ¨ã¦ç‰Œåº§æ¨™ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            if (!gameState || !gameState.players) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒç„¡åŠ¹ã§ã™', 'error');
                return;
            }
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ã®åº§æ¨™ã‚’ç¢ºèª
            for (let i = 0; i < 4; i++) {
                const discardElement = document.getElementById(`discards${i}`);
                if (discardElement) {
                    const rect = discardElement.getBoundingClientRect();
                    const style = window.getComputedStyle(discardElement);
                    
                    console.log(`ğŸ“ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i} æ¨ã¦ç‰Œã‚¨ãƒªã‚¢åº§æ¨™:`);
                    console.log(`  - ä½ç½®: x=${rect.left.toFixed(1)}, y=${rect.top.toFixed(1)}`);
                    console.log(`  - ã‚µã‚¤ã‚º: width=${rect.width.toFixed(1)}, height=${rect.height.toFixed(1)}`);
                    console.log(`  - CSS: position=${style.position}, transform=${style.transform}`);
                    console.log(`  - æ¨ã¦ç‰Œæ•°: ${gameState.players[i].hand.discards.length}æš`);
                    
                    // æ¨ã¦ç‰Œã®é…ç½®æ–¹å‘ã‚’ãƒ†ã‚¹ãƒˆ
                    const discards = discardElement.children;
                    if (discards.length > 0) {
                        console.log(`  - æœ€åˆã®ç‰Œä½ç½®: x=${discards[0].getBoundingClientRect().left.toFixed(1)}`);
                        if (discards.length > 1) {
                            console.log(`  - æœ€å¾Œã®ç‰Œä½ç½®: x=${discards[discards.length-1].getBoundingClientRect().left.toFixed(1)}`);
                            console.log(`  - é…ç½®æ–¹å‘: ${discards[0].getBoundingClientRect().left < discards[discards.length-1].getBoundingClientRect().left ? 'å·¦â†’å³' : 'å³â†’å·¦'}`);
                        }
                    }
                    
                    // è¦–è¦šçš„ãƒ†ã‚¹ãƒˆç”¨ã®ä¸€æ™‚çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    discardElement.style.border = '3px solid red';
                    setTimeout(() => {
                        discardElement.style.border = '';
                    }, 2000);
                }
            }
            
            // æ¨ã¦ç‰Œã®å‘ãã¨é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
            testDiscardRotations();
            showNotification('æ¨ã¦ç‰Œåº§æ¨™ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ', 'info');
        }
        
        // æ¨ã¦ç‰Œã®å›è»¢ã¨é…ç½®ãƒ†ã‚¹ãƒˆ
        function testDiscardRotations() {
            console.log('ğŸ”„ æ¨ã¦ç‰Œå›è»¢ãƒ†ã‚¹ãƒˆ:');
            
            for (let i = 0; i < 4; i++) {
                const playerName = ['ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', 'CPUå—', 'CPUè¥¿', 'CPUåŒ—'][i];
                const expectedRotation = [0, 0, 180, 0][i]; // æœŸå¾…ã•ã‚Œã‚‹å›è»¢è§’åº¦
                const expectedDirection = ['å·¦â†’å³', 'ä¸Šâ†’ä¸‹', 'å³â†’å·¦', 'ä¸‹â†’ä¸Š'][i]; // æœŸå¾…ã•ã‚Œã‚‹é…ç½®æ–¹å‘
                
                console.log(`  ${playerName} (ä½ç½®${i}):`);
                console.log(`    - æœŸå¾…å›è»¢: ${expectedRotation}åº¦`);
                console.log(`    - æœŸå¾…é…ç½®: ${expectedDirection}`);
                
                const discardElement = document.getElementById(`discards${i}`);
                if (discardElement && discardElement.children.length > 0) {
                    const firstTile = discardElement.children[0];
                    const style = window.getComputedStyle(firstTile);
                    console.log(`    - å®Ÿéš›CSS: transform=${style.transform}`);
                }
            }
        }
        
        // æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãƒ†ã‚¹ãƒˆ
        function addDiscardClickTest() {
            for (let i = 0; i < 4; i++) {
                const discardElement = document.getElementById(`discards${i}`);
                if (discardElement) {
                    discardElement.addEventListener('click', function() {
                        console.log(`ğŸ–±ï¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ`);
                        showNotification(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®æ¨ã¦ç‰Œã‚¨ãƒªã‚¢`, 'info');
                        
                        // è©³ç´°ãªæ¨ã¦ç‰Œæƒ…å ±ã‚’è¡¨ç¤º
                        showDiscardDetails(i);
                    });
                }
            }
        }
        
        // æŒ‡å®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ã¦ç‰Œè©³ç´°è¡¨ç¤º
        function showDiscardDetails(playerIndex) {
            if (!gameState || !gameState.players[playerIndex]) return;
            
            const player = gameState.players[playerIndex];
            const discards = player.hand.discards;
            
            console.log(`ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${playerIndex} æ¨ã¦ç‰Œè©³ç´°:`);
            console.log(`  - ç·æ•°: ${discards.length}æš`);
            
            discards.forEach((tile, index) => {
                console.log(`  ${index + 1}. ${tile.displayName || tile.unicode} (ID: ${tile.id})`);
            });
            
            if (gameState.lastDiscard && gameState.lastDiscardPlayer === playerIndex) {
                console.log(`  â­ æœ€æ–°æ¨ã¦ç‰Œ: ${gameState.lastDiscard.displayName || gameState.lastDiscard.unicode}`);
            }
        }
        
        // æ¨ã¦ç‰Œæ›´æ–°ã®ç›£è¦–ï¼ˆupdateGameDisplayã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
        function trackDiscardUpdates() {
            if (!gameState) return;
            
            const currentDiscardCounts = gameState.players.map(p => p.hand.discards.length);
            
            // å‰å›ã¨æ¯”è¼ƒã—ã¦å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ
            if (window.lastDiscardCounts) {
                for (let i = 0; i < 4; i++) {
                    if (currentDiscardCounts[i] !== window.lastDiscardCounts[i]) {
                        const change = currentDiscardCounts[i] - window.lastDiscardCounts[i];
                        // console.log(`ğŸ”„ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i} æ¨ã¦ç‰Œå¤‰æ›´: ${window.lastDiscardCounts[i]}æš â†’ ${currentDiscardCounts[i]}æš (${change > 0 ? '+' : ''}${change})`);
                        
                        if (change > 0 && gameState.players[i].hand.discards.length > 0) {
                            const latestDiscard = gameState.players[i].hand.discards[gameState.players[i].hand.discards.length - 1];
                            // console.log(`  æ–°ã—ã„æ¨ã¦ç‰Œ: ${latestDiscard.displayName || latestDiscard.unicode}`);
                        }
                    }
                }
            }
            
            window.lastDiscardCounts = [...currentDiscardCounts];
        }

        // å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        function testYakuAnalysis() {
            console.log('ğŸ° å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            if (!gameState || !gameState.players) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒç„¡åŠ¹ã§ã™', 'error');
                return;
            }
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç‰Œã‚’åˆ†æ
            gameState.players.forEach((player, index) => {
                console.log(`ğŸ° ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${index} (${player.name}) æ‰‹ç‰Œåˆ†æ:`);
                console.log(`  æ‰‹ç‰Œ: ${player.hand.tiles.length}æš`);
                console.log(`  ãƒ¡ãƒ«ãƒ‰: ${player.hand.melds.length}å€‹`);
                console.log(`  ãƒªãƒ¼ãƒ: ${player.hand.riichi ? 'Yes' : 'No'}`);
                console.log(`  æ¨ã¦ç‰Œ: ${player.hand.discards.length}æš`);
                
                // æ‰‹ç‰Œã®å†…å®¹ã‚’è¡¨ç¤º
                if (index === 0) { // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®æ‰‹ç‰Œã¯è¦‹ãˆã‚‹
                    console.log(`  æ‰‹ç‰Œè©³ç´°: ${player.hand.tiles.map(t => t.displayName || t.unicode).join(' ')}`);
                    
                    // å’Œäº†å½¢ã‹ãƒã‚§ãƒƒã‚¯
                    testWinningHand(player.hand.tiles, player.hand.melds, index);
                    
                    // ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ã‚’ãƒ†ã‚¹ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ç°¡æ˜“è¨ˆç®—ï¼‰
                    const shanten = calculateSimpleShanten(player.hand.tiles, player.hand.melds);
                    console.log(`  æ¨å®šã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°: ${shanten}`);
                    
                    // å¾…ã¡ç‰Œã®å¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆ
                    if (shanten <= 1) {
                        testWaitingTiles(player.hand.tiles);
                    }
                } else {
                    console.log(`  æ‰‹ç‰Œè©³ç´°: [éè¡¨ç¤º] ${player.hand.tiles.length}æš`);
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã®è©³ç´°
                if (player.hand.melds.length > 0) {
                    console.log(`  ãƒ¡ãƒ«ãƒ‰è©³ç´°:`);
                    player.hand.melds.forEach((meld, meldIndex) => {
                        console.log(`    ${meldIndex + 1}. ${meld.type}: ${meld.tiles.map(t => t.displayName || t.unicode).join(' ')}`);
                    });
                }
                
                console.log(''); // ç©ºè¡Œ
            });
            
            showNotification('å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸ', 'info');
        }
        
        // å’Œäº†å½¢ãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function testWinningHand(tiles, melds, playerIndex) {
            if (tiles.length + melds.length * 3 !== 14 && tiles.length + melds.length * 3 !== 13) {
                console.log(`  âš ï¸ ç‰Œæ•°ç•°å¸¸: ${tiles.length + melds.length * 3}æš`);
                return;
            }
            
            // ä¸ƒå¯¾å­ãƒã‚§ãƒƒã‚¯
            const isChiitoi = checkChiitoi(tiles);
            if (isChiitoi && tiles.length === 14) {
                console.log(`  ğŸ‰ ä¸ƒå¯¾å­å½¢: å’Œäº†å¯èƒ½`);
                simulateYaku(tiles, melds, playerIndex, 'ä¸ƒå¯¾å­');
                return;
            }
            
            // å›½å£«ç„¡åŒãƒã‚§ãƒƒã‚¯
            const isKokushi = checkKokushi(tiles);
            if (isKokushi && tiles.length === 14) {
                console.log(`  ğŸ‰ å›½å£«ç„¡åŒå½¢: å½¹æº€ï¼`);
                simulateYaku(tiles, melds, playerIndex, 'å›½å£«ç„¡åŒ');
                return;
            }
            
            // æ¨™æº–å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ï¼‰
            const isStandard = checkStandardForm(tiles, melds);
            if (isStandard) {
                console.log(`  ğŸ‰ æ¨™æº–å½¢: å’Œäº†å¯èƒ½`);
                simulateYaku(tiles, melds, playerIndex, 'æ¨™æº–å½¢');
                return;
            }
            
            console.log(`  âŒ å’Œäº†å½¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
        }
        
        // å½¹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function simulateYaku(tiles, melds, playerIndex, formType) {
            console.log(`  ğŸ“Š ${formType}ã®å½¹åˆ†æ:`);
            
            const allTiles = [...tiles, ...melds.flatMap(m => m.tiles)];
            const isMenzen = melds.every(m => m.type === 'ankan' || m.isConcealed);
            
            // åŸºæœ¬å½¹ãƒã‚§ãƒƒã‚¯
            const yakuList = [];
            
            // ã‚¿ãƒ³ãƒ¤ã‚ª
            if (allTiles.every(t => !t.honor && t.rank >= 2 && t.rank <= 8)) {
                yakuList.push('ã‚¿ãƒ³ãƒ¤ã‚ª(1ç¿»)');
            }
            
            // ãƒªãƒ¼ãƒ
            if (gameState.players[playerIndex].hand.riichi && isMenzen) {
                yakuList.push('ãƒªãƒ¼ãƒ(1ç¿»)');
            }
            
            // å½¹ç‰Œï¼ˆç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼‰
            const honors = ['white', 'green', 'red', 'east', 'south', 'west', 'north'];
            honors.forEach(honor => {
                const count = allTiles.filter(t => t.honor === honor).length;
                if (count >= 3) {
                    const names = {
                        white: 'ç™½', green: 'ç™¼', red: 'ä¸­',
                        east: 'æ±', south: 'å—', west: 'è¥¿', north: 'åŒ—'
                    };
                    yakuList.push(`${names[honor]}(1ç¿»)`);
                }
            });
            
            // ç‰¹æ®Šå½¢ã®å½¹
            if (formType === 'ä¸ƒå¯¾å­') {
                yakuList.push('ä¸ƒå¯¾å­(2ç¿»)');
            } else if (formType === 'å›½å£«ç„¡åŒ') {
                yakuList.push('å›½å£«ç„¡åŒ(å½¹æº€)');
            }
            
            if (yakuList.length > 0) {
                console.log(`    å½¹: ${yakuList.join(', ')}`);
                const totalHan = yakuList.reduce((sum, yaku) => {
                    if (yaku.includes('å½¹æº€')) return sum + 13;
                    const match = yaku.match(/(\d+)ç¿»/);
                    return sum + (match ? parseInt(match[1]) : 0);
                }, 0);
                console.log(`    åˆè¨ˆ: ${totalHan >= 13 ? 'å½¹æº€' : totalHan + 'ç¿»'}`);
            } else {
                console.log(`    å½¹: ãªã—ï¼ˆå½¹ãªã—ï¼‰`);
            }
        }
        
        // ç°¡æ˜“ã‚·ãƒ£ãƒ³ãƒ†ãƒ³è¨ˆç®—
        function calculateSimpleShanten(tiles, melds) {
            if (tiles.length + melds.length * 3 === 14) return -1; // å’Œäº†å½¢
            if (tiles.length + melds.length * 3 !== 13) return 8; // ç•°å¸¸
            
            // è¶…ç°¡æ˜“è¨ˆç®—ï¼ˆå®Ÿéš›ã®è¨ˆç®—ã¯è¤‡é›‘ï¼‰
            const tileCounts = {};
            tiles.forEach(tile => {
                const key = tile.honor || `${tile.suit}_${tile.rank}`;
                tileCounts[key] = (tileCounts[key] || 0) + 1;
            });
            
            let pairs = 0;
            let sets = 0;
            
            Object.values(tileCounts).forEach(count => {
                if (count >= 3) sets++;
                else if (count === 2) pairs++;
            });
            
            // éå¸¸ã«ç°¡æ˜“çš„ãªæ¨å®š
            const currentSets = sets + melds.length;
            const neededSets = 4;
            const neededPairs = 1;
            
            return Math.max(0, (neededSets - currentSets) * 2 + Math.max(0, neededPairs - pairs));
        }
        
        // å¾…ã¡ç‰Œãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function testWaitingTiles(tiles) {
            console.log(`  ğŸ¯ å¯èƒ½æ€§ã®ã‚ã‚‹å¾…ã¡ç‰Œ:`);
            
            // è¶…ç°¡æ˜“çš„ãªå¾…ã¡ç‰Œæ¨å®š
            const suits = ['man', 'pin', 'sou'];
            const possibleWaits = [];
            
            suits.forEach(suit => {
                for (let rank = 1; rank <= 9; rank++) {
                    // ã“ã®ç‰Œã‚’åŠ ãˆã¦å’Œäº†ã«ãªã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆè¶…ç°¡æ˜“ï¼‰
                    const testTile = { suit, rank, unicode: '', displayName: `${suit}${rank}`, id: 0, isRed: false };
                    possibleWaits.push(`${suit}${rank}`);
                }
            });
            
            // å­—ç‰Œ
            ['æ±', 'å—', 'è¥¿', 'åŒ—', 'ç™½', 'ç™¼', 'ä¸­'].forEach(honor => {
                possibleWaits.push(honor);
            });
            
            console.log(`    æ¨å®šå¾…ã¡: ${possibleWaits.slice(0, 5).join(', ')}... (ç°¡æ˜“æ¨å®š)`);
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function checkChiitoi(tiles) {
            if (tiles.length !== 14) return false;
            const counts = {};
            tiles.forEach(tile => {
                const key = tile.honor || `${tile.suit}_${tile.rank}`;
                counts[key] = (counts[key] || 0) + 1;
            });
            
            const values = Object.values(counts);
            return values.length === 7 && values.every(count => count === 2);
        }
        
        function checkKokushi(tiles) {
            if (tiles.length !== 14) return false;
            // ç°¡æ˜“å›½å£«åˆ¤å®šï¼ˆå®Ÿéš›ã¯ã‚ˆã‚Šè¤‡é›‘ï¼‰
            const yaochuCount = tiles.filter(t => 
                t.honor || t.rank === 1 || t.rank === 9
            ).length;
            return yaochuCount >= 12;
        }
        
        function checkStandardForm(tiles, melds) {
            // è¶…ç°¡æ˜“æ¨™æº–å½¢åˆ¤å®š
            const totalTiles = tiles.length + melds.length * 3;
            return totalTiles === 14 || totalTiles === 13;
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') drawTile();
            if (e.key === 's' || e.key === 'S') discardSelected();
            if (e.key === 'a' || e.key === 'A') executeAI();
            if (e.key === 'r' || e.key === 'R') requestGameState();
            if (e.key === 'n' || e.key === 'N') newGame();
            if (e.key === 'q' || e.key === 'Q') toggleDebug();
        });

        // Socket.IOã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°ã¯ä¸è¦
        // ãŸã ã—ã€æ¥ç¶šç¢ºèªã®ãŸã‚ã«60ç§’ã”ã¨ã«pingã‚’é€ä¿¡
        setInterval(() => {
            if (isConnected) {
                socket.emit('ping');
            }
        }, 60000);
    </script>
</body>
</html>