<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ æœ¬æ ¼éº»é›€ v1.2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @keyframes tenpai-pulse {
            0% { 
                opacity: 1; 
                transform: scale(1); 
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            50% { 
                opacity: 0.9; 
                transform: scale(1.05); 
                box-shadow: 0 6px 12px rgba(0,0,0,0.5), 0 0 0 4px rgba(255, 107, 107, 0.3);
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a5f2f 0%, #0f4021 50%, #0a2d17 100%);
            color: #212529;
            height: 100vh;
            overflow: auto;
            transition: all 0.3s ease;
        }
        
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1920Ã—1080å¯¾å¿œ */
        body {
            min-width: 1920px;
            min-height: 1080px;
        }
        
        /* 2560Ã—1440å¯¾å¿œ */
        @media (min-width: 2560px) and (min-height: 1440px) {
            body {
                min-width: 2560px;
                min-height: 1440px;
            }
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            height: 60px;
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffc107;
        }

        .game-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .game-controls {
            display: flex;
            gap: 10px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .mahjong-container {
            width: 1920px;
            height: 1080px;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ï¼ˆä¸­å¤®ã‚¨ãƒªã‚¢ï¼‰ */
        .game-board {
            width: 1880px;
            height: 980px;
            background: linear-gradient(135deg, #2d5a3d 0%, #1a4c2c 100%);
            border-radius: 20px;
            margin: 20px;
            position: relative;
            border: 8px solid #8b4513;
            box-shadow: 0 0 0 4px #ffc107, 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* 2Kå¯¾å¿œ: 2560Ã—1440 */
        @media (min-width: 2560px) and (min-height: 1440px) {
            .mahjong-container {
                width: 2560px;
                height: 1440px;
                transform: scale(1.333); /* 1920â†’2560ã®æ¯”ç‡ */
                transform-origin: top center;
            }
            
            .game-board {
                width: 2520px;
                height: 1320px;
            }
        }

        /* 2Kå¯¾å¿œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é…ç½® */
        .player-area {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            min-width: 280px;
        }

        .player-area.current {
            border-color: #ffc107;
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.6);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä¸Šå´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¯¾é¢ï¼‰ */
        .player-top {
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 280px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å³å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .player-right {
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            width: 240px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å·¦å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .player-left {
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            width: 240px;
        }
        
        /* 2Kå¯¾å¿œ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ */
        @media (min-width: 2560px) and (min-height: 1440px) {
            .player-top {
                top: 40px;
                width: 350px;
            }
            
            .player-left, .player-right {
                width: 300px;
            }
            
            .player-left {
                left: 40px;
            }
            
            .player-right {
                right: 40px;
            }
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± */
        .player-info {
            color: white;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .player-wind {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
        }

        /* æ‰‹ç‰Œè¡¨ç¤º */
        .hand-tiles {
            display: flex;
            gap: 2px;
            flex-wrap: nowrap;
        }

        /* å¯¾æˆ¦ç›¸æ‰‹ã®æ‰‹ç‰Œï¼ˆè£å‘ãï¼‰ */
        .opponent-tiles {
            display: flex;
            gap: 2px;
        }

        .opponent-tile {
            width: 20px;
            height: 28px;
            background: #4a5568;
            border: 1px solid #2d3748;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }

        /* å·¦å³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç¸¦å‘ã */
        .player-left .opponent-tiles, 
        .player-right .opponent-tiles {
            flex-direction: column;
        }

        .player-left .opponent-tile, 
        .player-right .opponent-tile {
            width: 28px;
            height: 20px;
        }

        /* æœ¬æ ¼éº»é›€ã®æ²³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .mahjong-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .rivers-horizontal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
        }

        .river-area {
            display: grid;
            gap: 1px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä¸Šä¸‹ã®æ²³ï¼ˆæ¨ªå‘ã6Ã—3ï¼‰ */
        .river-top, .river-bottom {
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 230px; /* å°ã•ãªæ²³ç‰Œã«åˆã‚ã›ã¦èª¿æ•´ */
            height: 130px; /* å°ã•ãªæ²³ç‰Œã«åˆã‚ã›ã¦èª¿æ•´ */
            margin: 0 auto;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å·¦å³ã®æ²³ï¼ˆæ¨ªå‘ã6Ã—3ï¼‰ */
        .river-left, .river-right {
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 230px; /* å°ã•ãªæ²³ç‰Œã«åˆã‚ã›ã¦èª¿æ•´ */
            height: 130px; /* å°ã•ãªæ²³ç‰Œã«åˆã‚ã›ã¦èª¿æ•´ */
            transform: rotate(90deg);
        }
        
        /* 2Kå¯¾å¿œ: æ²³ã‚¨ãƒªã‚¢ */
        @media (min-width: 2560px) and (min-height: 1440px) {
            .river-top, .river-bottom {
                width: 280px; /* 2Kç”¨ã«èª¿æ•´ */
                height: 160px; /* 2Kç”¨ã«èª¿æ•´ */
            }
            
            .river-left, .river-right {
                width: 280px; /* 2Kç”¨ã«èª¿æ•´ */
                height: 160px; /* 2Kç”¨ã«èª¿æ•´ */
            }
        }

        /* 2Kå¯¾å¿œæ²³ã®ç‰Œã‚¹ã‚¿ã‚¤ãƒ« */
        .river-tile {
            background: #f8f9fa;
            border: 1px solid #dee2e6; /* ãƒœãƒ¼ãƒ€ãƒ¼ã‚’ç´°ã */
            border-radius: 2px; /* è§’ä¸¸ã‚’å°ã•ã */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: normal;
            cursor: default;
            min-width: 36px; /* æ–‡å­—ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
            min-height: 42px; /* æ–‡å­—ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
            max-width: 36px;
            max-height: 42px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', monospace;
            line-height: 1;
            overflow: visible;
            padding: 0;
            margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚‚0ã« */
        }

        .river-tile.red {
            color: #dc3545;
        }
        
        /* é³´ã„ãŸç‰Œï¼ˆãƒãƒ¼ãƒ»ãƒãƒ³ãƒ»ã‚«ãƒ³ã§å‘¼ã°ã‚ŒãŸç‰Œï¼‰ã®è¡¨ç¤º */
        .river-tile.called {
            background: #ffe6cc;
            border-color: #ff9800;
            border-width: 2px;
            box-shadow: 0 0 4px rgba(255, 152, 0, 0.5);
        }

        .river-tile.reach {
            transform: rotate(90deg);
            background: #ffe6e6;
            border-color: #ff9999;
        }

        /* 2Kå¯¾å¿œå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ç‰Œæ–¹å‘ */
        .river-left .river-tile {
            /* æ²³ã‚¨ãƒªã‚¢ãŒ90åº¦å›è»¢ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ç‰Œã¯-75åº¦å›è»¢ï¼ˆ15åº¦å‚¾æ–œï¼‰ */
            transform: rotate(-75deg);
            width: 50px;
            height: 40px;
            font-size: 14px;
        }
        
        .river-right .river-tile {
            /* æ²³ã‚¨ãƒªã‚¢ãŒ90åº¦å›è»¢ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ç‰Œã¯-45åº¦å›è»¢ï¼ˆ45åº¦æ™‚è¨ˆå›ã‚Šå‚¾æ–œï¼‰ */
            transform: rotate(-45deg);
            width: 50px;
            height: 40px;
            font-size: 14px;
        }

        .river-left .river-tile.reach {
            transform: rotate(15deg); /* ãƒªãƒ¼ãƒç‰Œã¯15åº¦å‚¾æ–œ */
        }
        
        .river-right .river-tile.reach {
            transform: rotate(45deg); /* ãƒªãƒ¼ãƒç‰Œã¯45åº¦æ™‚è¨ˆå›ã‚Šå‚¾æ–œ */
        }

        .river-top .river-tile {
            /* è¥¿ã¯é€†å‘ã */
            transform: rotate(180deg);
        }

        .river-top .river-tile.reach {
            transform: rotate(90deg); /* ãƒªãƒ¼ãƒç‰Œã¯æ¨ªå€’ã— */
        }

        /* ä¸­å¤®æƒ…å ±ã‚¨ãƒªã‚¢ */
        .center-info {
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            min-width: 120px;
        }

        .round-info {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffc107;
            margin-bottom: 8px;
        }

        .dora-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .remaining-tiles {
            font-size: 0.7rem;
            color: #ccc;
        }

        /* ãƒªãƒ¼ãƒæ£’ã‚¹ã‚¿ã‚¤ãƒ« */
        .riichi-stick {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            border: 2px solid #fff;
        }

        @keyframes riichiPlace {
            0% {
                transform: translateY(-20px) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translateY(-5px) scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* å¹ãå‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« */
        .speech-bubbles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .speech-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #333;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            animation: speechAppear 0.3s ease-out;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®åˆ¥ã®å¹ãå‡ºã—é…ç½® */
        #speechBubble0 { /* ä¸‹ï¼ˆè‡ªåˆ†ï¼‰ */
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
        }
        #speechBubble0::after {
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
        }

        #speechBubble1 { /* å·¦ */
            left: 100px;
            top: 50%;
            transform: translateY(-50%);
        }
        #speechBubble1::after {
            left: -16px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }

        #speechBubble2 { /* ä¸Šï¼ˆå¯¾é¢ï¼‰ */
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
        }
        #speechBubble2::after {
            top: -16px;
            left: 50%;
            transform: translateX(-50%) rotate(180deg);
        }

        #speechBubble3 { /* å³ */
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
        }
        #speechBubble3::after {
            right: -16px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }

        @keyframes speechAppear {
            0% {
                transform: scale(0) translateX(-50%);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) translateX(-50%);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) translateX(-50%);
                opacity: 1;
            }
        }

        /* 2Kå¯¾å¿œãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .meld-area {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-meld-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            min-height: 80px;
            width: 100%;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ãƒ¡ãƒ«ãƒ‰é…ç½® */
        .player-top .meld-area {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
        }

        .player-left .meld-area {
            position: absolute;
            right: -450px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
        }

        .player-right .meld-area {
            position: absolute;
            left: -450px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
        }

        .meld-group {
            display: flex;
            gap: 2px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 4px;
            margin-right: 8px;
            position: relative;
        }

        .meld-group.chi {
            border-color: #28a745;
        }

        .meld-group.pon {
            border-color: #ffc107;
        }

        .meld-group.kan {
            border-color: #dc3545;
        }

        .meld-tile {
            width: 50px;
            height: 65px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #666;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            font-family: 'Noto Sans JP', serif;
            line-height: 0.9;
            white-space: pre-line;
            text-align: center;
        }

        .meld-tile.red {
            color: #dc3545;
        }

        .meld-tile.called {
            transform: rotate(90deg);
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        }

        .meld-label {
            position: absolute;
            top: -8px;
            left: 4px;
            background: #007bff;
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        .meld-group.chi .meld-label {
            background: #28a745;
        }

        .meld-group.pon .meld-label {
            background: #ffc107;
            color: #000;
        }

        .meld-group.kan .meld-label {
            background: #dc3545;
        }

        /* ä¸‹éƒ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ã¯é€†é †é…ç½® */
        .river-bottom {
            direction: rtl;
        }

        .river-bottom .river-tile {
            direction: ltr;
        }
        
        /* æ²³ã®è¡¨ç¤ºæ–¹å‘ä¿®æ­£ */
        .river-bottom {
            direction: ltr; /* å·¦ã‹ã‚‰å³ã¸ */
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ç”¨: è‡ªåˆ†ã®æ²³ã®é…ç½®ç¢ºèª */
        .river-bottom .river-tile {
            position: relative;
        }
        
        .river-bottom .river-tile::before {
            content: attr(data-order);
            position: absolute;
            top: -10px;
            left: 0;
            font-size: 8px;
            color: red;
        }

        /* 2Kå¯¾å¿œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ */
        .player-bottom-area {
            background: rgba(255, 255, 255, 0.95);
            margin: 0 40px 40px 40px;
            border-radius: 15px;
            padding: 25px;
            border: 4px solid #ffc107;
        }

        .player-hand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hand-count {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç‰Œ */
        .player-hand {
            display: flex;
            gap: 4px;
            justify-content: flex-start;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .tile {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #dee2e6; /* ãƒœãƒ¼ãƒ€ãƒ¼ã‚’ç´°ã */
            border-radius: 4px; /* è§’ä¸¸ã‚’å°ã•ã */
            padding: 0;
            margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚‚0ã« */
            font-size: 52px;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 52px; /* æ–‡å­—ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
            height: 60px; /* æ–‡å­—ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', monospace;
            user-select: none;
            position: relative;
            overflow: visible;
            line-height: 1; /* ãƒ©ã‚¤ãƒ³é«˜ã•ã‚’1ã« */
            text-align: center;
        }

        .tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.5s;
        }

        .tile:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(145deg, #ffffff 0%, #e3f2fd 100%);
            border-color: #2196f3;
            z-index: 10;
        }

        .tile:hover::before {
            left: 100%;
        }

        .tile.selected {
            background: linear-gradient(145deg, #fff8e1 0%, #ffecb3 100%);
            border-color: #ff9800;
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(255, 152, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            animation: selectedPulse 1.5s ease-in-out infinite;
            z-index: 15;
        }

        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 12px 20px rgba(255, 152, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.9); }
            50% { box-shadow: 0 12px 20px rgba(255, 152, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.9); }
        }

        .tile.red {
            color: #d32f2f;
            font-weight: 800;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* ç‰Œã®è‰²åˆ†ã‘ */
        .tile.man {
            color: #d32f2f; /* è¬å­ã¯èµ¤ */
            font-weight: 700;
        }
        
        .tile.pin {
            color: #333333; /* ç­’å­ã¯é»’ */
            font-weight: 700;
        }
        
        .tile.sou {
            color: #2e7d32; /* ç´¢å­ã¯ç·‘ */
            font-weight: 700;
        }
        
        /* ãƒ„ãƒ¢ç‰Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tile.tsumo {
            margin-left: 8px; /* ä»–ã®ç‰Œã¨ã®é–“éš” */
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ã¦ç‰Œ */
        .player-discards {
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
        }

        .player-discards-title {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .player-discard-tiles {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .player-discard-tiles .tile {
            width: 35px;
            height: 45px;
            font-size: 14px;
            font-weight: 600;
            cursor: default;
            background: #e9ecef;
            border-color: #ced4da;
            flex-direction: column;
            line-height: 0.8;
            white-space: pre-line;
            text-align: center;
        }

        .player-discard-tiles .tile:hover {
            transform: none;
            background: #e9ecef;
        }

        /* å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å€‹åˆ¥æ¨ç‰Œã‚¨ãƒªã‚¢ */
        .player-discard-area {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin-top: 8px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            min-height: 50px;
            max-width: 150px;
        }

        .player-top .player-discard-area {
            margin-top: 8px;
        }

        .player-left .player-discard-area,
        .player-right .player-discard-area {
            margin-top: 8px;
            max-width: 120px;
        }

        .player-discard-area .discard-tile {
            font-size: 9px;
            padding: 1px;
            min-width: 20px;
            height: 24px;
            cursor: default;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-discard-area .discard-tile:hover {
            transform: none;
            background: #f8f9fa;
        }

        .player-discard-area .discard-tile.red {
            color: #dc3545;
            font-weight: 800;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-panel {
            position: fixed;
            bottom: 40px;
            left: 40px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 500px;
            z-index: 50;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary { 
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); 
            color: white; 
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #dc3545 0%, #a71e2a 100%); 
            color: white; 
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        .btn-warning { 
            background: linear-gradient(135deg, #ffc107 0%, #d39e00 100%); 
            color: #212529; 
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .btn-success { 
            background: linear-gradient(135deg, #198754 0%, #0f5132 100%); 
            color: white; 
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }
        .btn-info { 
            background: linear-gradient(135deg, #0dcaf0 0%, #087990 100%); 
            color: #212529; 
            box-shadow: 0 4px 12px rgba(13, 202, 240, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
            transition: all 0.1s;
        }

        /* æƒ…å ±ãƒ‘ãƒãƒ« */
        .info-panel {
            position: fixed;
            bottom: 200px;
            left: 40px;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 50;
            font-size: 1rem;
        }

        .game-status {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #212529;
        }

        .game-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #212529;
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 16px 28px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 200px;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            animation: notificationSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(209, 237, 255, 0.95) 0%, rgba(184, 230, 255, 0.95) 100%);
            color: #0c63e4;
            border-color: rgba(12, 99, 228, 0.3);
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(248, 215, 218, 0.95) 0%, rgba(245, 183, 191, 0.95) 100%);
            color: #721c24;
            border-color: rgba(114, 28, 36, 0.3);
        }

        .notification.warning {
            background: linear-gradient(135deg, rgba(255, 243, 205, 0.95) 0%, rgba(255, 235, 156, 0.95) 100%);
            color: #856404;
            border-color: rgba(133, 100, 4, 0.3);
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(209, 236, 241, 0.95) 0%, rgba(178, 222, 235, 0.95) 100%);
            color: #0c5460;
            border-color: rgba(12, 84, 96, 0.3);
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(-50%) translateY(-100px) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* ç‰¹åˆ¥ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes winCelebration {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.2) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes riichiGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }

        .win-celebration {
            animation: winCelebration 0.8s ease-in-out;
        }

        .riichi-glow {
            animation: riichiGlow 2s ease-in-out infinite;
        }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti 3s linear infinite;
        }

        .confetti:nth-child(2n) { background: #4ecdc4; }
        .confetti:nth-child(3n) { background: #45b7d1; }
        .confetti:nth-child(4n) { background: #96ceb4; }
        .confetti:nth-child(5n) { background: #feca57; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .game-board {
                margin: 10px;
            }
            
            .info-panel {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin: 10px;
            }
            
            .action-panel {
                position: relative;
                bottom: auto;
                right: auto;
                max-width: none;
                margin: 10px;
                justify-content: center;
            }

            .player-bottom-area {
                margin: 0 10px 10px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="mahjong-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="game-header">
            <a href="/title.html" class="game-title" style="text-decoration: none;">ğŸ€„ æœ¬æ ¼éº»é›€ v1.2.0</a>
            
            <div class="game-info">
                <div id="gameInfo">æ±å ´ 1å±€</div>
                <div>æ®‹ã‚Šç‰Œ: <span id="remainingTiles">69</span></div>
                <div>ç¾åœ¨: <span id="currentPlayerName">ã‚ãªãŸ</span></div>
                <div id="doraInfo">ãƒ‰ãƒ©: <span id="doraDisplay">?</span></div>
            </div>

            <div class="game-controls">
                <button class="btn btn-info" onclick="toggleDebug()">ãƒ‡ãƒãƒƒã‚°</button>
                <button class="btn btn-secondary" onclick="checkUISync()" style="font-size: 0.8rem;">UIåŒæœŸ</button>
                <button class="btn btn-warning" onclick="forceClearMelds()" style="font-size: 0.8rem;">æ™’ã—ã‚¯ãƒªã‚¢</button>
                <button id="cpuAutoBtn" class="btn btn-success" onclick="toggleCpuAuto()">CPUè‡ªå‹•é–‹å§‹</button>
                <button id="playerAutoBtn" class="btn btn-secondary" onclick="togglePlayerAuto()">ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Š</button>
                <button class="btn btn-warning" onclick="newGame()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
                <a href="/title.html" class="btn btn-info">ã‚¿ã‚¤ãƒˆãƒ«</a>
            </div>
        </header>

        <!-- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ -->
        <div class="game-board">
            <!-- ä¸Šå´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¯¾é¢ï¼‰ -->
            <div class="player-area player-top" id="player2">
                <div class="player-info">
                    <div class="player-name">CPUè¥¿</div>
                    <div class="player-wind">è¥¿</div>
                    <div class="player-score">
                        <span id="player2Score">25000</span>ç‚¹
                    </div>
                </div>
                <div class="opponent-tiles" id="hand2"></div>
                <div class="meld-area" id="melds2"></div>
            </div>

            <!-- å³å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
            <div class="player-area player-right" id="player3">
                <div class="player-info">
                    <div class="player-name">CPUåŒ—</div>
                    <div class="player-wind">åŒ—</div>
                    <div class="player-score">
                        <span id="player3Score">25000</span>ç‚¹
                    </div>
                </div>
                <div class="opponent-tiles" id="hand3"></div>
                <div class="meld-area" id="melds3"></div>
            </div>

            <!-- å·¦å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
            <div class="player-area player-left" id="player1">
                <div class="player-info">
                    <div class="player-name">CPUå—</div>
                    <div class="player-wind">å—</div>
                    <div class="player-score">
                        <span id="player1Score">25000</span>ç‚¹
                    </div>
                </div>
                <div class="opponent-tiles" id="hand1"></div>
                <div class="meld-area" id="melds1"></div>
            </div>

            <!-- ä¸­å¤®ã®æ²³ã‚¨ãƒªã‚¢ï¼ˆæœ¬æ ¼éº»é›€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
            <div class="mahjong-center">
                <!-- ä¸Šå´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                <div class="river-area river-top" id="river2"></div>
                
                <!-- å·¦å³ã®æ²³ã¨ä¸­å¤®æƒ…å ± -->
                <div class="rivers-horizontal">
                    <!-- å·¦å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                    <div class="river-area river-left" id="river1"></div>
                    
                    <!-- ä¸­å¤®æƒ…å ±ã‚¨ãƒªã‚¢ -->
                    <div class="center-info">
                        <div class="round-info" id="roundInfo">æ±1å±€</div>
                        <div class="dora-info">
                            ãƒ‰ãƒ©: <span id="doraIndicator">ğŸ€«</span>
                        </div>
                        <div class="remaining-tiles">
                            æ®‹ã‚Š: <span id="remainingTilesDisplay">69</span>æš
                        </div>
                        <!-- ãƒªãƒ¼ãƒæ£’ -->
                        <div class="riichi-stick" id="riichiStick" style="display: none;">
                            1000ç‚¹æ£’
                        </div>
                    </div>
                    
                    <!-- å³å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                    <div class="river-area river-right" id="river3"></div>
                </div>
                
                <!-- ä¸‹å´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ -->
                <div class="river-area river-bottom" id="river0"></div>
            </div>
        </div>

        <!-- å¹ãå‡ºã—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="speech-bubbles">
            <div class="speech-bubble" id="speechBubble0" style="display: none;"></div>
            <div class="speech-bubble" id="speechBubble1" style="display: none;"></div>
            <div class="speech-bubble" id="speechBubble2" style="display: none;"></div>
            <div class="speech-bubble" id="speechBubble3" style="display: none;"></div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div class="player-bottom-area" id="player0">
            <div class="player-hand-header">
                <div class="player-details">
                    <div class="player-name" id="playerName">ã‚ãªãŸ</div>
                    <div class="player-wind" id="playerWind">æ±</div>
                    <div style="color: #6c757d; font-size: 0.9rem;">
                        <span id="playerScore">25000</span>ç‚¹
                    </div>
                </div>
                <div class="hand-count">
                    æ‰‹ç‰Œ: <span id="handCount">13</span>æš
                </div>
            </div>
            
            <div class="player-hand" id="hand0"></div>
            
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼0ã®ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="meld-area player-meld-area" id="melds0"></div>
            
        </div>

        <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="info-panel">
            <div class="game-status" id="gameStatus">ã‚²ãƒ¼ãƒ é–‹å§‹</div>
            <div class="game-stats">
                <div class="stat-item">
                    <div class="stat-label">ç¾åœ¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
                    <div class="stat-value" id="currentPlayer">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å±€æ•°</div>
                    <div class="stat-value" id="round">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æœ¬å ´</div>
                    <div class="stat-value" id="honba">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ®‹ã‚Šç‰Œ</div>
                    <div class="stat-value" id="remainingTilesInfo">69</div>
                </div>
            </div>
            <button class="btn btn-success" onclick="requestGameState()" style="width: 100%;">
                çŠ¶æ…‹ã‚’æ›´æ–°
            </button>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« -->
        <div class="action-panel">
            <button class="btn btn-primary" onclick="drawTile()" id="drawBtn">ãƒ„ãƒ¢</button>
            <button class="btn btn-danger" onclick="discardSelected()" id="discardBtn">æ‰“ç‰Œ</button>
            <button class="btn" style="background: #ff6b6b; color: white;" onclick="callRiichi()" id="riichiBtn">ãƒªãƒ¼ãƒ</button>
            <button class="btn btn-warning" onclick="callChi()" id="chiBtn" style="display: inline-block;">ãƒãƒ¼</button>
            <button class="btn btn-warning" onclick="callPon()" id="ponBtn" style="display: inline-block;">ãƒãƒ³</button>
            <button class="btn btn-warning" onclick="callKan()" id="kanBtn" style="display: inline-block;">ã‚«ãƒ³</button>
            <button class="btn btn-secondary" onclick="passMeld()" id="passBtn" style="display: none;">ãƒ‘ã‚¹</button>
            <button class="btn" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white;" onclick="callMeld()" id="meldBtn" style="display: none;">ã‚¹ãƒãƒ¼ãƒˆãƒ¡ãƒ«ãƒ‰</button>
            <button class="btn btn-success" onclick="callTsumo()" id="tsumoBtn">ãƒ„ãƒ¢</button>
            <button class="btn btn-success" onclick="callRon()" id="ronBtn">ãƒ­ãƒ³</button>
            <button class="btn btn-info" onclick="executeAI()" id="aiBtn">AIå®Ÿè¡Œ</button>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
        <div class="debug-panel" style="position: fixed; bottom: 160px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 10px; border-radius: 8px; font-size: 0.75rem; z-index: 100; max-width: 180px;">
            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ“ä½œ</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="forceCPUTurn()">CPUå¼·åˆ¶å®Ÿè¡Œ</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="showGameLog()">ãƒ­ã‚°è¡¨ç¤º</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="toggleDebugMode()">ãƒ‡ãƒãƒƒã‚°åˆ‡æ›¿</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="skipToNextPlayer()">æ¬¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="showDiscards()">æ¨ã¦ç‰Œç¢ºèª</button>
                <button class="btn" style="background: #17a2b8; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="testDiscardCoordinates()">åº§æ¨™ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" style="background: #28a745; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="testYakuAnalysis()">å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" style="background: #17a2b8; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="testScoreCalculation()">ç‚¹æ•°è¨ˆç®—ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="showErrorLogs()">ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</button>
                <button class="btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;" onclick="clearConsole()">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ¶ˆå»</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification"></div>

    <!-- éŸ³åŠ¹åˆ¶å¾¡ãƒ‘ãƒãƒ«ï¼ˆä½ç½®ä¿®æ­£ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã¨é‡è¤‡å›é¿ï¼‰ -->
    <div style="position: fixed; top: 70px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 6px; color: white;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <button onclick="toggleSound()" id="soundToggle" class="btn" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">ğŸ”Š</button>
            <input type="range" id="volumeSlider" min="0" max="100" value="70" onchange="setVolume(this.value)" style="width: 60px;">
        </div>
    </div>

    <script src="/js/SoundManager.js"></script>
    <script>
        let gameId = null;
        let selectedTile = null;
        let gameState = null;
        let debugMode = false;
        let lastDiscardedTile = null;
        let lastDiscardedPlayer = null;
        
        // é¢¨è¨­å®šï¼ˆå¼·åŒ–ç‰ˆéº»é›€ãƒ­ã‚¸ãƒƒã‚¯ç”¨ï¼‰
        let gameSettings = {
            gameWind: 'east',   // å ´é¢¨
            playerWind: 'east', // è‡ªé¢¨
            round: 1            // å±€æ•°
        };
        
        // å‰¯éœ²ãƒ‡ãƒ¼ã‚¿ï¼ˆå¼·åŒ–ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ç”¨ï¼‰
        let melds = [];
        
        // å¤‰æ•°åˆæœŸåŒ–
        let isConnected = false;
        let currentTenpaiStatus = { isTenpai: false, waitingTiles: [] };
        let myPlayerId = 0; // è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ä¿¡ã—ã¦æ›´æ–°ï¼‰
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: gameIdçŠ¶æ…‹ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯
        setInterval(() => {
            console.log('ğŸ” [STATUS CHECK] gameId:', gameId, 'isConnected:', isConnected, 'roomId from URL:', roomId);
        }, 5000);
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’è¦–è¦šä½ç½®ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function getVisualPosition(actualPlayerId, myPlayerId) {
            // è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’åŸºæº–ã«ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
            // myPlayerIdã¯å¸¸ã«è¦–è¦šä½ç½®0ï¼ˆä¸‹ï¼‰ã«ãªã‚‹
            const offset = myPlayerId;
            return (actualPlayerId - offset + 4) % 4;
        }
        
        // è¦–è¦šä½ç½®ã‹ã‚‰å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getActualPlayerId(visualPosition, myPlayerId) {
            return (visualPosition + myPlayerId) % 4;
        }
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰éƒ¨å±‹æƒ…å ±ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        const playerName = urlParams.get('playerName');
        const isOnlineGame = roomId && playerName;
        
        console.log('ğŸ” URL Parameters:', { roomId, playerName, isOnlineGame });
        
        // Socket.IOæ¥ç¶š
        const socket = io();
        
        // Socket.IOã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        socket.on('connect', () => {
            console.log('ğŸ”Œ Socket.IOæ¥ç¶šæˆåŠŸ');
            isConnected = true;
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éº»é›€ã®å ´åˆã€æ—¢å­˜ã®éƒ¨å±‹ã«æ¥ç¶š
            if (isOnlineGame) {
                console.log('ğŸ® ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éº»é›€: æ—¢å­˜éƒ¨å±‹ã«æ¥ç¶šä¸­...', roomId);
                socket.gameId = roomId;
                gameId = roomId; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®gameIdå¤‰æ•°ã‚‚è¨­å®š
                console.log('ğŸ” gameId set to:', gameId);
                socket.emit('joinRoom', {
                    roomId: roomId,
                    playerName: playerName
                });
            }
        });
        
        socket.on('disconnect', () => {
            console.log('ğŸ”Œ Socket.IOåˆ‡æ–­');
            isConnected = false;
            
            if (isOnlineGame) {
                showNotification('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'error');
            }
        });
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éº»é›€å°‚ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        socket.on('roomJoined', (data) => {
            console.log('ğŸ  éƒ¨å±‹æ¥ç¶šæˆåŠŸ:', data);
            showNotification('ã‚²ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã—ãŸ', 'success');
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã¯ { room: roomObject } ã®å½¢å¼ã§é€ä¿¡ã•ã‚Œã‚‹
            if (data.room && data.room.id) {
                gameId = data.room.id;
                console.log('ğŸ” gameId set from data.room.id:', gameId);
                
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚‚å–å¾—
                if (data.room.gameState) {
                    console.log('ğŸ® é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã«å‚åŠ ');
                    gameState = data.room.gameState;
                    updateGameDisplay();
                }
            } else if (data.roomId) {
                // æ—§å½¢å¼ã¸ã®å¯¾å¿œ
                gameId = data.roomId;
                console.log('ğŸ” gameId set from data.roomId:', gameId);
                
                if (data.gameState) {
                    gameState = data.gameState;
                    updateGameDisplay();
                }
            }
        });
        
        socket.on('joinError', (data) => {
            console.log('âŒ éƒ¨å±‹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', data);
            showNotification(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${data.message}`, 'error');
            
            // 3ç§’å¾Œã«ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
            setTimeout(() => {
                window.location.href = '/lobby.html';
            }, 3000);
        });
        
        socket.on('gameUpdate', (newGameState) => {
            console.log('ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°å—ä¿¡');
            
            // ãƒ„ãƒ¢ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¿½è·¡
            if (gameState && newGameState && gameState.players && newGameState.players) {
                const oldHandSize = gameState.players[myPlayerId]?.hand?.tiles?.length || 0;
                const newHandSize = newGameState.players[myPlayerId]?.hand?.tiles?.length || 0;
                const oldCurrentPlayer = gameState.currentPlayer;
                const newCurrentPlayer = newGameState.currentPlayer;
                
                console.log('ğŸ” Hand size change:', oldHandSize, 'â†’', newHandSize);
                console.log('ğŸ” Current player change:', oldCurrentPlayer, 'â†’', newCurrentPlayer);
                
                if (newHandSize > oldHandSize && newCurrentPlayer === myPlayerId) {
                    console.log('ğŸ¯ TSUMO DETECTED: I drew a tile');
                    console.log('ğŸ” My new tiles:', newGameState.players[myPlayerId].hand.tiles.map((t, i) => `${i}: ${t.suit}${t.rank} (id:${t.id})`));
                }
            }
            
            gameState = newGameState;
            updateGameDisplay();
        });
        
        socket.on('roomCreated', (data) => {
            console.log('ğŸ® ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', data);
            gameId = data.room.id;
            console.log('ğŸ” gameId set from roomCreated:', gameId);
            showNotification('ã‚²ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼', 'success');
            
            // ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚²ãƒ¼ãƒ ã®å ´åˆã€è‡ªå‹•ã§æº–å‚™å®Œäº†ã«ã™ã‚‹
            setTimeout(() => {
                socket.emit('playerReady', {
                    roomId: gameId,
                    ready: true
                });
                console.log('ğŸ”„ è‡ªå‹•æº–å‚™å®Œäº†ã‚’é€ä¿¡');
            }, 500);
        });
        
        let gameStartNotified = false;
        
        socket.on('gameState', (newGameState) => {
            console.log('ğŸ® ã‚²ãƒ¼ãƒ çŠ¶æ…‹å—ä¿¡:', newGameState);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’è¨­å®šï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸå ´åˆï¼‰
            if (newGameState.myPlayerId !== undefined) {
                myPlayerId = newGameState.myPlayerId;
                console.log(`ğŸ‘¤ [MY PLAYER ID] è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ID: ${myPlayerId} (${newGameState.playerName})`);
            }
            
            // ãƒ„ãƒ¢ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¿½è·¡ï¼ˆgameStateã‚¤ãƒ™ãƒ³ãƒˆï¼‰
            if (gameState && newGameState && gameState.players && newGameState.players) {
                const myCurrentHandSize = gameState.players[myPlayerId]?.hand?.tiles?.length || 0;
                const myNewHandSize = newGameState.players[myPlayerId]?.hand?.tiles?.length || 0;
                
                if (myNewHandSize > myCurrentHandSize) {
                    console.log('ğŸ¯ TSUMO DETECTED (gameState): I drew a tile');
                    console.log('ğŸ” My new tiles:', newGameState.players[myPlayerId].hand.tiles.map((t, i) => `${i}: ${t.suit}${t.rank} (id:${t.id})`));
                }
            }
            
            gameState = newGameState;
            updateGameDisplay();
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã‚’æ›´æ–°
            updateTenpaiDisplay(newGameState);
            
            // åˆå›ã®ã¿ã‚²ãƒ¼ãƒ é–‹å§‹é€šçŸ¥ã‚’è¡¨ç¤º
            if (!gameStartNotified && newGameState.phase === 'playing') {
                showNotification('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼', 'success');
                gameStartNotified = true;
            }
        });

        // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šã®é€šçŸ¥ã‚’å—ä¿¡
        socket.on('meldOpportunities', (data) => {
            const timestamp = new Date().toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ===== ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šå—ä¿¡é–‹å§‹ =====`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ãƒ‡ãƒ¼ã‚¿å…¨ä½“:`, data);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] æ¨ã¦ç‰Œ: ${data.discardedTile?.displayName || data.discardedTile?.unicode}`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] æ¨ã¦ç‰Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${data.discardPlayerId}`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ã‚ªãƒ¼ãƒˆåœæ­¢: ${data.autoPaused}`);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] æ©Ÿä¼šãŒã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${data.opportunities?.length || 0}`);
            data.opportunities?.forEach(opp => {
                const types = [];
                if (opp.chi) types.push('ãƒãƒ¼');
                if (opp.pon) types.push('ãƒãƒ³');
                if (opp.kan) types.push('ã‚«ãƒ³');
                console.log(`[${timestamp}] ğŸ€„ [CLIENT] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opp.playerId}(${opp.playerType}): ${types.join('ãƒ»')}`);
            });
            
            // lastDiscardedTileã‚’ç›´æ¥è¨­å®š
            console.log(`ğŸ”§ DEBUG: data.discardedTile exists: ${!!data.discardedTile}`);
            console.log(`ğŸ”§ DEBUG: data.discardPlayerId: ${data.discardPlayerId}`);
            console.log(`ğŸ”§ DEBUG: data.discardPlayerId !== undefined: ${data.discardPlayerId !== undefined}`);
            
            if (data.discardedTile && data.discardPlayerId !== undefined) {
                lastDiscardedTile = data.discardedTile;
                lastDiscardedPlayer = data.discardPlayerId;
                console.log(`ğŸ”§ lastDiscardedTile set from meldOpportunities: ${lastDiscardedTile.displayName} by player ${lastDiscardedPlayer}`);
            } else {
                console.log(`ğŸ”§ Failed to set lastDiscardedTile - condition not met`);
            }
            
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] showMeldOpportunitiesé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™`);
            showMeldOpportunities(data);
            console.log(`[${timestamp}] ğŸ€„ [CLIENT] ===== ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šå—ä¿¡çµ‚äº† =====`);
        });

        // å’Œäº†çµæœå—ä¿¡
        socket.on('winResult', (data) => {
            console.log('ğŸ¯ å’Œäº†çµæœå—ä¿¡:', data);
            
            if (data.success) {
                // è©³ç´°ãªå’Œäº†è¡¨ç¤ºã‚’ä½œæˆ
                displayWinResult(data);
                
                // å‹åˆ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å®Ÿè¡Œ
                triggerWinCelebration(data);
                
                // åŸºæœ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                showNotification(`${data.message}`, 'success');
                
                // ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹ã®è¡¨ç¤º
                setTimeout(() => {
                    showNotification('æ¬¡å±€æº–å‚™ä¸­...', 'info');
                }, 5000);
            } else {
                showNotification(`å’Œäº†å¤±æ•—: ${data.error}`, 'error');
            }
        });
        
        // è©³ç´°ãªå’Œäº†çµæœè¡¨ç¤º
        function displayWinResult(data) {
            // æ—¢å­˜ã®å’Œäº†è¡¨ç¤ºãŒã‚ã‚Œã°å‰Šé™¤
            const existingDisplay = document.querySelector('.win-result-modal');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'win-result-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 20, 0.95) 100%);
                border: 3px solid #ffc107;
                border-radius: 15px;
                padding: 30px;
                z-index: 10001;
                color: white;
                font-family: 'Noto Sans JP', sans-serif;
                max-width: 600px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0,0,0,0.7);
                backdrop-filter: blur(10px);
            `;
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #ffc107; margin: 0 0 10px 0; font-size: 2rem;">
                        ${data.winType === 'tsumo' ? 'ğŸŠ ãƒ„ãƒ¢ï¼' : 'ğŸ¯ ãƒ­ãƒ³ï¼'}
                    </h2>
                    <div style="font-size: 1.2rem; color: #fff;">
                        ${data.winnerName || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'} ã®å‹åˆ©ï¼
                    </div>
                </div>
            `;
            
            // å½¹è¡¨ç¤º
            if (data.yaku && data.yaku.length > 0) {
                content += `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <h3 style="color: #4CAF50; margin: 0 0 10px 0;">ğŸ´ å½¹</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                `;
                
                data.yaku.forEach(yaku => {
                    const hanText = yaku.han >= 13 ? 'å½¹æº€' : `${yaku.han}ç¿»`;
                    content += `
                        <span style="
                            background: linear-gradient(45deg, #2196F3, #1976D2);
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 0.9rem;
                            white-space: nowrap;
                        ">
                            ${yaku.name} (${hanText})
                        </span>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // ç‚¹æ•°è¡¨ç¤º
            if (data.score) {
                const score = data.score;
                content += `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,193,7,0.2); border-radius: 8px;">
                        <h3 style="color: #ffc107; margin: 0 0 10px 0;">ğŸ’° å¾—ç‚¹</h3>
                `;
                
                if (score.isYakuman) {
                    content += `
                        <div style="font-size: 1.5rem; font-weight: bold; color: #ff4444;">
                            å½¹æº€${score.yakumanCount > 1 ? score.yakumanCount + 'å€' : ''}
                        </div>
                        <div style="font-size: 1.3rem; margin-top: 5px;">
                            ${score.total.toLocaleString()}ç‚¹
                        </div>
                    `;
                } else {
                    content += `
                        <div style="font-size: 1.2rem;">
                            ${score.han}ç¿» ${score.fu}ç¬¦
                        </div>
                        <div style="font-size: 1.4rem; font-weight: bold; margin-top: 5px;">
                            ${score.total.toLocaleString()}ç‚¹
                        </div>
                    `;
                }
                
                // æ”¯æ‰•ã„è©³ç´°
                if (score.payments) {
                    content += `
                        <div style="margin-top: 15px; font-size: 0.95rem; opacity: 0.9;">
                    `;
                    
                    if (score.isTsumo) {
                        content += `
                            <div>ãƒ„ãƒ¢: å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ ${score.payments.each?.toLocaleString() || '---'}ç‚¹</div>
                        `;
                    } else {
                        content += `
                            <div>ãƒ­ãƒ³: ${score.payments.winner?.toLocaleString() || '---'}ç‚¹</div>
                        `;
                    }
                    
                    content += `</div>`;
                }
                
                content += `</div>`;
            }
            
            // å’Œäº†è€…ã®æ‰‹ç‰Œè¡¨ç¤º
            if (data.winnerHand) {
                content += `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(76,175,80,0.2); border-radius: 8px;">
                        <h3 style="color: #4CAF50; margin: 0 0 10px 0;">ğŸ€„ ${data.winnerName}ã®æ‰‹ç‰Œ</h3>
                `;
                
                // ãƒ¡ãƒ«ãƒ‰ï¼ˆé³´ãï¼‰è¡¨ç¤º
                if (data.winnerHand.melds && data.winnerHand.melds.length > 0) {
                    content += `<div style="margin-bottom: 10px;">`;
                    content += `<strong>é³´ã:</strong> `;
                    data.winnerHand.melds.forEach(meld => {
                        const meldTiles = meld.tiles.map(tile => tile.unicode || getTileDisplayName(tile) || 'ğŸ€«').join('');
                        content += `[${meldTiles}] `;
                    });
                    content += `</div>`;
                }
                
                // æ‰‹ç‰Œè¡¨ç¤º
                content += `
                    <div>
                        <strong>æ‰‹ç‰Œ:</strong>
                        <div style="font-family: monospace; font-size: 1.1rem; margin-top: 5px;">
                            ${data.winnerHand.tiles.map(tile => tile.unicode || getTileDisplayName(tile) || 'ğŸ€«').join(' ')}
                `;
                
                // ãƒ­ãƒ³ã®å ´åˆã¯å’Œäº†ç‰Œã‚’è¡¨ç¤º
                if (data.winType === 'ron' && data.winnerHand.winningTile) {
                    content += ` + ${data.winnerHand.winningTile.unicode || getTileDisplayName(data.winnerHand.winningTile) || 'ğŸ€«'}`;
                }
                
                content += `
                        </div>
                    </div>
                    </div>
                `;
            }
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            content += `
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: linear-gradient(45deg, #4CAF50, #45a049);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        OK
                    </button>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
            
            // 10ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    modal.remove();
                }
            }, 10000);
        }

        // ãƒªãƒ¼ãƒå®£è¨€å—ä¿¡
        socket.on('riichiDeclared', (data) => {
            console.log('ğŸ”¥ ãƒªãƒ¼ãƒå®£è¨€å—ä¿¡:', data);
            
            if (data.success) {
                // ãƒªãƒ¼ãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å®Ÿè¡Œ
                triggerRiichiEffect(data.playerId);
                
                showNotification(`${data.playerName}ãŒãƒªãƒ¼ãƒï¼`, 'warning');
                
                // ä¾›è¨—æƒ…å ±è¡¨ç¤º
                if (data.kyotaku > 0) {
                    showNotification(`ä¾›è¨—: ${data.kyotaku}æœ¬`, 'info');
                }
            }
        });

        // æ–°ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹å—ä¿¡
        socket.on('newRound', (data) => {
            console.log('ğŸ†• æ–°ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹:', data);
            
            showNotification(`${data.wind}${data.roundNumber}å±€ ${data.honba}æœ¬å ´é–‹å§‹`, 'info');
            
            // é…ç‰Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦å®Ÿè¡Œï¼‰
            setTimeout(() => {
                animateTileDistribution();
            }, 500);
        });

        // ã‚²ãƒ¼ãƒ çµ‚äº†å—ä¿¡
        socket.on('gameEnd', (data) => {
            console.log('ğŸŠ ã‚²ãƒ¼ãƒ çµ‚äº†:', data);
            
            // ä¸‰å®¶å’Œã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
            if (data.type === 'triple_ron') {
                let tripleRonText = 'ğŸ”¥ ä¸‰å®¶å’Œï¼ˆã•ã‚“ã¡ã‚ƒã»ãƒ¼ï¼‰\n\n';
                tripleRonText += 'ãƒ­ãƒ³å’Œäº†è€…:\n';
                data.ronPlayers.forEach(player => {
                    tripleRonText += `ãƒ»${player.name} (${player.score}ç‚¹)\n`;
                });
                tripleRonText += `\næŒ¯ã‚Šè¾¼ã¿: ${data.discardPlayer.name} (${data.discardPlayer.score}ç‚¹)`;
                
                if (data.kyotaku > 0) {
                    tripleRonText += `\nä¾›è¨—${data.kyotaku}æœ¬ã¯æ¬¡å±€ã«æŒã¡è¶Šã—`;
                }
                
                showNotification(tripleRonText, 'warning');
                
                // ä¸‰å®¶å’Œã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                setTimeout(() => {
                    flashBackground('#FF5722', 2000);
                    createFireworks();
                }, 1000);
                return;
            }
            
            // é€šå¸¸ã®æœ€çµ‚é †ä½è¡¨ç¤º
            let rankingText = 'ğŸ† æœ€çµ‚çµæœ ğŸ†\n';
            data.finalRanking.forEach(player => {
                rankingText += `${player.rank}ä½: ${player.name} (${player.score}ç‚¹)\n`;
            });
            
            showNotification('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼', 'success');
            
            // ç‰¹åˆ¥ãªçµ‚äº†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            setTimeout(() => {
                flashBackground('#4CAF50', 2000);
                createConfetti();
            }, 1000);
        });

        // æµã—æº€è²«çµæœå—ä¿¡
        socket.on('nagashiMangan', (data) => {
            console.log('ğŸŒŠ æµã—æº€è²«:', data);
            
            let nagashiText = 'ğŸŒŠ æµã—æº€è²«\n\n';
            nagashiText += 'æˆç«‹è€…:\n';
            data.nagashiPlayers.forEach(player => {
                nagashiText += `ãƒ»${player.name} (${player.score}ç‚¹)\n`;
                nagashiText += `  æ¨ã¦ç‰Œ: ${player.discards.join(' ')}\n`;
            });
            
            showNotification(nagashiText, 'success');
            
            // æµã—æº€è²«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            setTimeout(() => {
                flashBackground('#4CAF50', 2000);
                createWaveEffect();
            }, 1000);
        });

        // æµå±€çµæœå—ä¿¡
        socket.on('drawResult', (data) => {
            console.log('ğŸ”„ æµå±€çµæœ:', data);
            
            // è©³ç´°ãªæµå±€çµæœè¡¨ç¤º
            displayDrawResult(data);
            
            // æµå±€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            setTimeout(() => {
                flashBackground('#FF9800', 1500);
            }, 1000);
        });
        
        // æµå±€çµæœè¡¨ç¤ºé–¢æ•°
        function displayDrawResult(data) {
            // æ—¢å­˜ã®è¡¨ç¤ºãŒã‚ã‚Œã°å‰Šé™¤
            const existingDisplay = document.querySelector('.draw-result-modal');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'draw-result-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(40, 40, 40, 0.95) 0%, rgba(60, 60, 60, 0.95) 100%);
                border: 3px solid #FF9800;
                border-radius: 15px;
                padding: 30px;
                z-index: 10001;
                color: white;
                font-family: 'Noto Sans JP', sans-serif;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.7);
                backdrop-filter: blur(10px);
            `;
            
            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #FF9800; margin: 0 0 10px 0; font-size: 2rem;">
                        ğŸ”„ æµå±€
                    </h2>
                </div>
            `;
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤è€…ã®æ‰‹ç‰Œå…¬é–‹
            const tenpaiPlayers = data.tenpaiResults.filter(result => result.isTenpai);
            if (tenpaiPlayers.length > 0) {
                content += `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(76,175,80,0.2); border-radius: 8px;">
                        <h3 style="color: #4CAF50; margin: 0 0 15px 0;">ğŸ€„ ãƒ†ãƒ³ãƒ‘ã‚¤è€…ã®æ‰‹ç‰Œ</h3>
                `;
                
                tenpaiPlayers.forEach(player => {
                    if (player.revealedHand) {
                        content += `
                            <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                                <strong>${player.name}:</strong>
                        `;
                        
                        // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤º
                        if (player.revealedHand.melds && player.revealedHand.melds.length > 0) {
                            content += `<div style="margin: 5px 0;">é³´ã: `;
                            player.revealedHand.melds.forEach(meld => {
                                const meldTiles = meld.tiles.map(tile => tile.unicode || getTileDisplayName(tile) || 'ğŸ€«').join('');
                                content += `[${meldTiles}] `;
                            });
                            content += `</div>`;
                        }
                        
                        // æ‰‹ç‰Œè¡¨ç¤º
                        content += `
                            <div style="font-family: monospace; font-size: 1rem; margin: 5px 0;">
                                æ‰‹ç‰Œ: ${player.revealedHand.tiles.map(tile => tile.unicode || getTileDisplayName(tile) || 'ğŸ€«').join(' ')}
                            </div>
                        `;
                        
                        // å¾…ã¡ç‰Œè¡¨ç¤º
                        if (player.revealedHand.waitingTiles && player.revealedHand.waitingTiles.length > 0) {
                            content += `
                                <div style="color: #ffc107; font-size: 0.9rem;">
                                    å¾…ã¡: ${player.revealedHand.waitingTiles.map(tile => tile.unicode || getTileDisplayName(tile) || 'ğŸ€«').join(' ')}
                                </div>
                            `;
                        }
                        
                        content += `</div>`;
                    }
                });
                
                content += `</div>`;
            }
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤ãƒ»ãƒãƒ¼ãƒ†ãƒ³çµæœ
            content += `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <h3 style="color: #ffc107; margin: 0 0 10px 0;">ğŸ“Š çµæœ</h3>
            `;
            
            data.tenpaiResults.forEach(result => {
                const status = result.isTenpai ? 'ãƒ†ãƒ³ãƒ‘ã‚¤' : 'ãƒãƒ¼ãƒ†ãƒ³';
                const statusColor = result.isTenpai ? '#4CAF50' : '#f44336';
                content += `
                    <div style="margin: 5px 0;">
                        ${result.name}: <span style="color: ${statusColor}; font-weight: bold;">${status}</span>
                    </div>
                `;
            });
            
            // ç‚¹æ•°ç§»å‹•
            if (data.pointMovement.some(m => m.points !== 0)) {
                content += `<div style="margin-top: 15px; font-size: 0.95rem;">`;
                content += `<strong>ç‚¹æ•°ç§»å‹•:</strong><br>`;
                data.pointMovement.forEach(movement => {
                    if (movement.points !== 0) {
                        const sign = movement.points > 0 ? '+' : '';
                        const color = movement.points > 0 ? '#4CAF50' : '#f44336';
                        content += `
                            <div style="margin: 3px 0;">
                                ${data.tenpaiResults[movement.playerId].name}: 
                                <span style="color: ${color}; font-weight: bold;">${sign}${movement.points}ç‚¹</span>
                            </div>
                        `;
                    }
                });
                content += `</div>`;
            } else {
                content += `<div style="margin-top: 10px; opacity: 0.8;">ç‚¹æ•°ç§»å‹•ãªã—</div>`;
            }
            
            content += `</div>`;
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            content += `
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: linear-gradient(45deg, #FF9800, #f57c00);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        OK
                    </button>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        // ç‰¹æ®Šæµå±€çµæœå—ä¿¡
        socket.on('specialDrawResult', (data) => {
            console.log('ğŸ”„ ç‰¹æ®Šæµå±€çµæœ:', data);
            
            let drawText = `ğŸ”„ ${data.drawName}\n\n`;
            
            switch (data.drawType) {
                case 'four_winds':
                    drawText += 'åŒã˜é¢¨ç‰ŒãŒ4äººé€£ç¶šã§æ¨ã¦ã‚‰ã‚Œã¾ã—ãŸã€‚\n';
                    break;
                case 'nine_terminals':
                    drawText += 'è¦ªã®ç¬¬ä¸€ãƒ„ãƒ¢ã§å­—ç‰Œãƒ»ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç‰ŒãŒ9ç¨®é¡ä»¥ä¸Šã§ã™ã€‚\n';
                    break;
                case 'four_kans':
                    drawText += '4å›ã®ã‚«ãƒ³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n';
                    break;
            }
            
            drawText += 'é€£è˜ã¨ãªã‚Šã¾ã™ã€‚';
            
            showNotification(drawText, 'warning');
            
            // ç‰¹æ®Šæµå±€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            setTimeout(() => {
                flashBackground('#9C27B0', 2000); // ç´«è‰²ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
            }, 1000);
        });

        // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šè¡¨ç¤ºé–¢æ•°
        function showMeldOpportunities(data) {
            const { discardedTile, discardPlayerId, opportunities, autoPaused } = data;
            
            // è‡ªåˆ†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼0ï¼‰ã®æ©Ÿä¼šã‚’ãƒã‚§ãƒƒã‚¯
            const myOpportunity = opportunities.find(opp => opp.playerId === 0);
            
            console.log('ğŸ€„ [DEBUG] showMeldOpportunitieså‘¼ã³å‡ºã—');
            console.log('ğŸ€„ [DEBUG] myOpportunity:', myOpportunity);
            
            if (myOpportunity) {
                console.log('ğŸ€„ è‡ªåˆ†ã«ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼š:', myOpportunity);
                console.log('ğŸ€„ [DEBUG] chi:', myOpportunity.chi, 'pon:', myOpportunity.pon, 'kan:', myOpportunity.kan);
                
                // æ”¹å–„ã•ã‚ŒãŸãƒ¡ãƒ«ãƒ‰é¸æŠUIã‚’è‡ªå‹•è¡¨ç¤º
                if (gameState && gameState.players && gameState.players[myPlayerId]) {
                    const myTiles = gameState.players[myPlayerId].hand.tiles;
                    const discarded = lastDiscardedTile || discardedTile;
                    
                    if (discarded && myTiles) {
                        // å…¨ã¦ã®å¯èƒ½ãªãƒ¡ãƒ«ãƒ‰ã‚’è‡ªå‹•æ¤œç´¢ã—ã¦é¸æŠUIã‚’è¡¨ç¤º
                        const chiCombinations = findChiCombinations(myTiles, discarded);
                        const ponTiles = findPonTiles(myTiles, discarded);
                        const kanTiles = findKanTiles(myTiles, discarded);
                        
                        const allOptions = [];
                        
                        // å®Ÿéš›ã«å¯èƒ½ãªãƒ¡ãƒ«ãƒ‰ã®ã¿ã‚’è¿½åŠ 
                        if (myOpportunity.chi && chiCombinations.length > 0) {
                            chiCombinations.forEach((combo, index) => {
                                allOptions.push({
                                    type: 'chi',
                                    displayName: `ãƒãƒ¼: ${combo.map(t => getTileDisplayName(t)).join('')}`,
                                    tiles: combo,
                                    discardedTile: discarded
                                });
                            });
                        }
                        
                        if (myOpportunity.pon && ponTiles.length >= 2) {
                            allOptions.push({
                                type: 'pon',
                                displayName: `ãƒãƒ³: ${getTileDisplayName(discarded)}${getTileDisplayName(discarded)}${getTileDisplayName(discarded)}`,
                                tiles: ponTiles,
                                discardedTile: discarded
                            });
                        }
                        
                        if (myOpportunity.kan && kanTiles.length >= 3) {
                            allOptions.push({
                                type: 'kan',
                                displayName: `ã‚«ãƒ³: ${getTileDisplayName(discarded)}${getTileDisplayName(discarded)}${getTileDisplayName(discarded)}${getTileDisplayName(discarded)}`,
                                tiles: kanTiles,
                                discardedTile: discarded
                            });
                        }
                        
                        if (allOptions.length > 0) {
                            // æ”¹å–„ã•ã‚ŒãŸé¸æŠUIã‚’è¡¨ç¤º
                            showMeldSelectionUI(allOptions);
                        }
                    }
                }
                
                // ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const passBtn = document.getElementById('passBtn');
                if (passBtn) {
                    passBtn.style.display = 'inline-block';
                }
                
                // å¾“æ¥ã®ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚‚ç¶­æŒï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
                const chiBtn = document.getElementById('chiBtn');
                const ponBtn = document.getElementById('ponBtn');
                const kanBtn = document.getElementById('kanBtn');
                
                if (chiBtn && myOpportunity.chi) {
                    chiBtn.style.display = 'inline-block';
                    chiBtn.style.visibility = 'visible';
                }
                if (ponBtn && myOpportunity.pon) {
                    ponBtn.style.display = 'inline-block';
                    ponBtn.style.visibility = 'visible';
                }
                if (kanBtn && myOpportunity.kan) {
                    kanBtn.style.display = 'inline-block';
                    kanBtn.style.visibility = 'visible';
                }
                
                // ãƒ­ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šæ™‚ã‚‚å’Œäº†å„ªå…ˆï¼‰
                const ronBtn = document.getElementById('ronBtn');
                if (ronBtn && canCallRon()) {
                    ronBtn.style.display = 'inline-block';
                    ronBtn.style.visibility = 'visible';
                    console.log('ğŸ¯ ãƒ­ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šã¨åŒæ™‚ï¼‰');
                }
                
                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³å…¨ä½“ã‚’æ›´æ–°ï¼ˆãƒ­ãƒ³ãƒœã‚¿ãƒ³ã‚‚å«ã‚ã¦ï¼‰
                updateActionButtons();
                
                // é€šçŸ¥è¡¨ç¤º
                const meldTypes = [];
                if (myOpportunity.chi) meldTypes.push('ãƒãƒ¼');
                if (myOpportunity.pon) meldTypes.push('ãƒãƒ³');
                if (myOpportunity.kan) meldTypes.push('ã‚«ãƒ³');
                
                // ã‚ªãƒ¼ãƒˆåœæ­¢ã®é€šçŸ¥
                if (autoPaused) {
                    showNotification(`${meldTypes.join('ãƒ»')}ãŒå¯èƒ½ã§ã™ï¼ï¼ˆã‚ªãƒ¼ãƒˆæ©Ÿèƒ½ã‚’åœæ­¢ã—ã¾ã—ãŸï¼‰`, 'warning');
                } else {
                    showNotification(`${meldTypes.join('ãƒ»')}ãŒå¯èƒ½ã§ã™ï¼`, 'info');
                }
                
                // 10ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºï¼ˆã‚ªãƒ¼ãƒˆåœæ­¢æ™‚ã¯é•·ã‚ã«ï¼‰
                setTimeout(() => {
                    hideMeldButtons();
                }, autoPaused ? 15000 : 8000);
            } else {
                hideMeldButtons();
            }
        }

        // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç„¡åŠ¹åŒ–ï¼‰
        function hideMeldButtons() {
            const chiBtn = document.getElementById('chiBtn');
            const ponBtn = document.getElementById('ponBtn');
            const kanBtn = document.getElementById('kanBtn');
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šéè¡¨ç¤ºã«ã—ãªã„
            // if (chiBtn) chiBtn.style.display = 'none';
            // if (ponBtn) ponBtn.style.display = 'none';
            // if (kanBtn) kanBtn.style.display = 'none';
        }
        
        // é‡è¤‡ã—ãŸroomJoinedãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‰Šé™¤
        
        socket.on('actionResult', (result) => {
            console.log('âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœ:', result);
            if (result.success) {
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
        });
        
        socket.on('error', (error) => {
            console.error('âŒ Socket.IOã‚¨ãƒ©ãƒ¼:', error);
            showNotification(error.message, 'error');
        });
        
        socket.on('roomError', (error) => {
            console.error('âŒ ãƒ«ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼:', error);
            showNotification(error.message, 'error');
        });

        // éŸ³åŠ¹åˆ¶å¾¡é–¢æ•°
        function toggleSound() {
            const isMuted = soundManager.toggleMute();
            const button = document.getElementById('soundToggle');
            button.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            button.style.background = isMuted ? '#dc3545' : '#28a745';
            showNotification(isMuted ? 'éŸ³åŠ¹ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆã—ã¾ã—ãŸ' : 'éŸ³åŠ¹ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ', 'info');
        }

        function setVolume(value) {
            soundManager.setVolume(value / 100);
            showNotification(`éŸ³é‡: ${value}%`, 'info');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ” DEBUG: DOM loaded, initializing...');
            console.log('ğŸ” DEBUG: Initial gameId:', gameId);
            console.log('ğŸ” DEBUG: URL roomId:', roomId);
            console.log('ğŸ” DEBUG: isOnlineGame:', isOnlineGame);
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã®å ´åˆã¯gameIdã‚’å³åº§ã«è¨­å®š
            if (isOnlineGame && roomId) {
                gameId = roomId;
                console.log('ğŸ” DEBUG: gameId set from URL roomId:', gameId);
            }
            
            hideMeldButtons(); // åˆæœŸçŠ¶æ…‹ã§ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            try {
                await soundManager.init();
                console.log('ğŸ” DEBUG: SoundManager initialized');
            } catch (error) {
                console.warn('ğŸ” DEBUG: SoundManager init failed:', error);
            }
            
            // æ¨ã¦ç‰Œãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            addDiscardClickTest();
            console.log('ğŸ” DEBUG: Discard click test initialized');
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã§ãªã„å ´åˆã®ã¿newGame()ã‚’å‘¼ã¶
            if (!isOnlineGame) {
                newGame();
            }
            
            try {
                soundManager.playGameStart();
            } catch (error) {
                console.warn('ğŸ” DEBUG: playGameStart failed:', error);
            }
        });

        // æ–°ã—ã„ã‚²ãƒ¼ãƒ ä½œæˆ
        function newGame() {
            if (!isConnected) {
                showNotification('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éº»é›€ã®å ´åˆã¯æ–°ã‚²ãƒ¼ãƒ ä½œæˆã‚’ç„¡åŠ¹åŒ–
            if (isOnlineGame) {
                showNotification('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³éº»é›€ã§ã¯æ–°ã‚²ãƒ¼ãƒ ä½œæˆã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            showNotification('æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œæˆä¸­...', 'info');
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetGameState();
            
            // Socket.IOã§ãƒ«ãƒ¼ãƒ ä½œæˆè¦æ±‚
            socket.emit('createRoom', {
                roomName: 'ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æˆ¦',
                playerName: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1'
            });
        }
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆé–¢æ•°
        function resetGameState() {
            // å¼·åŒ–ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ç”¨ã®å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            melds = [];
            gameSettings = {
                gameWind: 'east',
                playerWind: 'east',
                round: 1
            };
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedTile = null;
            lastDiscardedTile = null;
            lastDiscardedPlayer = null;
            gameStartNotified = false;
            currentTenpaiStatus = { isTenpai: false, waitingTiles: [] };
            
            // UIè¦ç´ ã‚’ã‚¯ãƒªã‚¢
            clearMeldDisplays();
            clearTenpaiDisplays();
            clearActionButtons();
            
            console.log('ğŸ”„ ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ');
        }
        
        // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        function clearMeldDisplays() {
            for (let i = 0; i < 4; i++) {
                const meldArea = document.getElementById(`melds${i}`);
                if (meldArea) {
                    meldArea.innerHTML = '';
                }
            }
        }
        
        // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        function clearTenpaiDisplays() {
            document.querySelectorAll('.tenpai-indicator').forEach(indicator => {
                indicator.remove();
            });
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢
        function clearActionButtons() {
            const actionButtons = document.querySelector('.action-buttons');
            if (actionButtons) {
                actionButtons.style.display = 'none';
            }
            
            // ãƒ¡ãƒ«ãƒ‰é¸æŠUIã‚‚éè¡¨ç¤º
            const meldSelection = document.querySelector('.meld-selection');
            if (meldSelection) {
                meldSelection.style.display = 'none';
            }
        }
        
        // å±€å¤‰æ›´æ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        function resetRoundState() {
            console.log('ğŸ”„ å±€å¤‰æ›´æ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ');
            
            // å¼·åŒ–ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ç”¨ã®å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆä¸€éƒ¨ã®ã¿ï¼‰
            melds = [];
            lastDiscardedTile = null;
            lastDiscardedPlayer = null;
            selectedTile = null;
            
            // UIè¦ç´ ã‚’ã‚¯ãƒªã‚¢
            clearMeldDisplays();
            clearTenpaiDisplays();
            clearActionButtons();
            clearRoundSpecificUI();
            
            // é¢¨è¨­å®šã‚’æ›´æ–°ï¼ˆå±€ã«å¿œã˜ã¦ï¼‰
            if (gameState && gameState.round) {
                gameSettings.round = gameState.round.roundNumber || 1;
                // è‡ªé¢¨ã¯é€šå¸¸æ±â†’å—â†’è¥¿â†’åŒ—ã®é †ã§å¤‰ã‚ã‚‹
                const windOrder = ['east', 'south', 'west', 'north'];
                gameSettings.playerWind = windOrder[(gameState.round.roundNumber - 1) % 4] || 'east';
            }
            
            console.log('ğŸ”„ å±€ãƒªã‚»ãƒƒãƒˆå®Œäº† - æ–°ã—ã„é¢¨è¨­å®š:', gameSettings);
        }
        
        // å±€å›ºæœ‰ã®UIè¦ç´ ã‚’ã‚¯ãƒªã‚¢
        function clearRoundSpecificUI() {
            // ãƒ¡ãƒ«ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
            const existingModals = document.querySelectorAll('.meld-selection-modal');
            existingModals.forEach(modal => modal.remove());
            
            // å‹åˆ©è¡¨ç¤ºã‚’å‰Šé™¤
            const winDisplays = document.querySelectorAll('.win-celebration, .win-display, .win-result-modal');
            winDisplays.forEach(display => display.remove());
            
            // ãƒªãƒ¼ãƒæ£’è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            const riichiStick = document.getElementById('riichiStick');
            if (riichiStick) {
                riichiStick.style.display = 'none';
            }
            
            // ç´™å¹é›ªã‚„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
            const confettiContainers = document.querySelectorAll('.confetti-container');
            confettiContainers.forEach(container => container.remove());
            
            // æ²³ï¼ˆæ¨ã¦ç‰Œã‚¨ãƒªã‚¢ï¼‰ã‚’ã‚¯ãƒªã‚¢
            clearDiscardAreas();
        }
        
        // æ²³ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
        function clearDiscardAreas() {
            for (let i = 0; i < 4; i++) {
                const riverArea = document.getElementById(`river${i}`);
                if (riverArea) {
                    riverArea.innerHTML = '';
                }
            }
        }
        
        // UIåŒæœŸãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function checkUISync() {
            console.log('ğŸ” UIåŒæœŸãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
            
            const report = {
                gameState: !!gameState,
                currentRound: currentRoundNumber,
                currentHonba: currentHonbaCount,
                melds: melds.length,
                selectedTile: !!selectedTile,
                lastDiscarded: !!lastDiscardedTile,
                tenpaiStatus: currentTenpaiStatus.isTenpai,
                visibleModals: document.querySelectorAll('.meld-selection-modal, .win-result-modal').length,
                visibleTenpaiIndicators: document.querySelectorAll('.tenpai-indicator').length,
                displayedMelds: Array.from({length: 4}, (_, i) => {
                    const meldElement = document.getElementById(`melds${i}`);
                    return meldElement ? meldElement.children.length : 0;
                })
            };
            
            console.log('ğŸ“Š UIçŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ:', report);
            
            // ç•°å¸¸ãŒã‚ã‚‹å ´åˆã®è‡ªå‹•ä¿®æ­£
            if (report.visibleModals > 1) {
                console.warn('âš ï¸ è¤‡æ•°ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚');
                clearRoundSpecificUI();
            }
            
            // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã®å¼·åˆ¶ãƒã‚§ãƒƒã‚¯
            if (gameState && gameState.players) {
                let hasStaleDisplays = false;
                gameState.players.forEach((player, i) => {
                    const actualMelds = player.hand?.melds?.length || 0;
                    const displayedMelds = report.displayedMelds[i];
                    if (actualMelds === 0 && displayedMelds > 0) {
                        console.warn(`âš ï¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºãŒå¤ã„çŠ¶æ…‹ã§ã™ã€‚ã‚¯ãƒªã‚¢ä¸­...`);
                        const meldElement = document.getElementById(`melds${i}`);
                        if (meldElement) {
                            meldElement.innerHTML = '';
                        }
                        hasStaleDisplays = true;
                    }
                });
                
                if (hasStaleDisplays) {
                    console.log('ğŸ”„ å¤ã„ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                }
            }
            
            return report;
        }
        
        // å¼·åˆ¶ãƒ¡ãƒ«ãƒ‰ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function forceClearMelds() {
            console.log('ğŸ§¹ å¼·åˆ¶ãƒ¡ãƒ«ãƒ‰ã‚¯ãƒªã‚¢å®Ÿè¡Œ');
            clearMeldDisplays();
            melds = [];
            console.log('âœ… ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¤‰æ•°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // ç¾åœ¨ã®å±€ç•ªå·ã‚’è¿½è·¡ï¼ˆæ–°å±€æ¤œå‡ºç”¨ï¼‰
        let currentRoundNumber = 1;
        let currentHonbaCount = 0;

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
        function updateGameDisplay() {
            if (!gameState) {
                console.log('ğŸ” DEBUG: gameState is null or undefined');
                return;
            }

            // æ–°ã—ã„å±€ã®é–‹å§‹ã‚’æ¤œå‡º
            const newRoundNumber = gameState.round?.roundNumber || 1;
            const newHonbaCount = gameState.round?.honbaCount || 0;
            
            // ã‚ˆã‚Šç¢ºå®Ÿãªæ–°å±€æ¤œå‡ºï¼ˆæ®‹ã‚Šç‰Œæ•°ã¨æ‰‹ç‰Œæšæ•°ã‚‚ãƒã‚§ãƒƒã‚¯ï¼‰
            const isNewRound = (newRoundNumber !== currentRoundNumber || newHonbaCount !== currentHonbaCount) ||
                              (gameState.remainingTiles >= 65 && gameState.players?.some(p => p.hand?.tiles?.length === 13));
            
            if (newRoundNumber !== currentRoundNumber || newHonbaCount !== currentHonbaCount) {
                console.log(`ğŸ”„ æ–°ã—ã„å±€ã‚’æ¤œå‡º: ${currentRoundNumber}å±€â†’${newRoundNumber}å±€, ${currentHonbaCount}æœ¬å ´â†’${newHonbaCount}æœ¬å ´`);
                
                // å±€å¤‰æ›´æ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
                resetRoundState();
                
                currentRoundNumber = newRoundNumber;
                currentHonbaCount = newHonbaCount;
            }
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œã®åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¡ãƒ«ãƒ‰ãŒç©ºã®å ´åˆï¼‰
            if (gameState.remainingTiles >= 65 && gameState.players?.every(p => p.hand?.melds?.length === 0)) {
                console.log('ğŸ”„ ã‚²ãƒ¼ãƒ é–‹å§‹/æ–°å±€ã‚’æ¤œå‡º - ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢');
                clearMeldDisplays();
            }

            // console.log('ğŸ” DEBUG: updateGameDisplay called');
            // console.log('ğŸ” DEBUG: gameState:', gameState);
            // console.log('ğŸ” DEBUG: gameState.players:', gameState.players);
            // console.log('ğŸ” DEBUG: gameState.currentPlayer:', gameState.currentPlayer);

            // åŸºæœ¬æƒ…å ±æ›´æ–°
            try {
                document.getElementById('currentPlayer').textContent = gameState.currentPlayer || '0';
                
                const currentPlayerName = gameState.players && gameState.players[gameState.currentPlayer] 
                    ? gameState.players[gameState.currentPlayer].name 
                    : 'Unknown';
                document.getElementById('currentPlayerName').textContent = currentPlayerName;
                console.log('ğŸ” DEBUG: currentPlayerName:', currentPlayerName);
                document.getElementById('remainingTiles').textContent = gameState.remainingTiles || '0';
                document.getElementById('remainingTilesInfo').textContent = gameState.remainingTiles || '0';
                
                if (gameState.round) {
                    document.getElementById('round').textContent = gameState.round.roundNumber || '1';
                    document.getElementById('honba').textContent = gameState.round.honbaCount || '0';
                    document.getElementById('roundInfo').textContent = `æ±${gameState.round.roundNumber || '1'}å±€ ${gameState.round.honbaCount || '0'}æœ¬å ´`;
                    document.getElementById('gameInfo').textContent = `æ±å ´ ${gameState.round.roundNumber || '1'}å±€`;
                }
                
                document.getElementById('doraIndicator').textContent = gameState.doraIndicators?.[0]?.unicode || 'ğŸ€«';
                
                console.log('ğŸ” DEBUG: Basic info updated successfully');
            } catch (error) {
                console.error('ğŸ” DEBUG: Error updating basic info:', error);
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±æ›´æ–°
            try {
                console.log('ğŸ” DEBUG: Starting player info update');
                if (!gameState.players || !Array.isArray(gameState.players)) {
                    console.error('ğŸ” DEBUG: gameState.players is not an array:', gameState.players);
                    return;
                }
                
                gameState.players.forEach((player, index) => {
                    console.log(`ğŸ” DEBUG: Processing player ${index}:`, player);
                    
                    // è¦–è¦šä½ç½®ã‚’è¨ˆç®—
                    const visualPos = getVisualPosition(index, myPlayerId);
                    const playerElement = document.getElementById(`player${visualPos}`);
                    
                    console.log(`ğŸ” DEBUG: Player ${index} -> Visual position ${visualPos}`);
                    
                    if (!playerElement) {
                        console.warn(`ğŸ” DEBUG: Player element not found: player${visualPos}`);
                        return;
                    }

                // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (index === gameState.currentPlayer) {
                    playerElement.classList.add('current');
                } else {
                    playerElement.classList.remove('current');
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±æ›´æ–°
                const nameElement = playerElement.querySelector('.player-name');
                const windElement = playerElement.querySelector('.player-wind');
                
                if (nameElement) nameElement.textContent = player.name;
                if (windElement) windElement.textContent = player.wind;
                
                // ãƒªãƒ¼ãƒè¡¨ç¤ºã®æ›´æ–°
                updateRiichiDisplay(playerElement, player, index);

                    // æ‰‹ç‰Œæ›´æ–°
                    const handElement = document.getElementById(`hand${visualPos}`);
                    console.log(`ğŸ” DEBUG: handElement for player ${index} (visual ${visualPos}):`, handElement);
                    console.log(`ğŸ” DEBUG: player.hand for player ${index}:`, player.hand);
                    console.log(`ğŸ” DEBUG: player.hand.tiles for player ${index}:`, player.hand?.tiles);
                    
                    if (handElement && player.hand && player.hand.tiles) {
                        handElement.innerHTML = '';
                        
                        if (index === myPlayerId) {
                            // è‡ªåˆ†ã®æ‰‹ç‰Œï¼ˆè©³ç´°è¡¨ç¤ºï¼‰
                            // ç·ç‰Œæ•°ã‚’è¨ˆç®—
                            const totalTiles = player.hand.tiles.length + (player.hand.melds?.length || 0) * 3;
                            
                            console.log(`ğŸ” DEBUG: Updating my hand (player ${myPlayerId}) with ${player.hand.tiles.length} tiles`);
                            console.log(`ğŸ” DEBUG: Tile order:`, player.hand.tiles.map((t, i) => `${i}: ${t.suit}${t.rank || ''} (id:${t.id})`));
                            console.log(`ğŸ” DEBUG: Current player:`, gameState.currentPlayer, 'Total tiles:', totalTiles);
                            
                            // ã‚µãƒ¼ãƒãƒ¼å´ã§ç‰Œé †ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€ãã®ã¾ã¾è¡¨ç¤º
                            let displayTiles = [...player.hand.tiles];
                            
                            try {
                                displayTiles.forEach((tile, tileIndex) => {
                                    if (!tile) {
                                        console.warn('ğŸ” Skipping null/undefined tile at index', tileIndex);
                                        return;
                                    }
                                    
                                    const tileElement = document.createElement('div');
                                    tileElement.className = 'tile';
                                    if (tile.isRed) tileElement.classList.add('red');
                                    if (tile.suit) tileElement.classList.add(tile.suit); // è‰²åˆ†ã‘ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
                                    
                                    // æœ€å¾Œã®ç‰Œï¼ˆ14æšç›®ï¼‰ã‚’ãƒ„ãƒ¢ç‰Œã¨ã—ã¦æ‰±ã†
                                    if (totalTiles === 14 && tileIndex === displayTiles.length - 1) {
                                        tileElement.classList.add('tsumo');
                                        console.log(`ğŸ” DEBUG: Tsumo tile detected at index ${tileIndex}`);
                                    }
                                    
                                    tileElement.textContent = getTileDisplayName(tile);
                                    
                                    // å…ƒã®é…åˆ—ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¦selectTileã«æ¸¡ã™
                                    const originalIndex = player.hand.tiles.findIndex(t => t && t.id === tile.id);
                                    tileElement.onclick = () => selectTile(visualPos, originalIndex >= 0 ? originalIndex : tileIndex, tile);
                                    handElement.appendChild(tileElement);
                                });
                                
                                console.log(`ğŸ” DEBUG: Successfully rendered ${displayTiles.length} tiles`);
                            } catch (error) {
                                console.error('ğŸ” Error rendering tiles:', error);
                                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…ƒã®é…åˆ—ã‚’ãã®ã¾ã¾è¡¨ç¤º
                                player.hand.tiles.forEach((tile, tileIndex) => {
                                    if (!tile) return;
                                    
                                    const tileElement = document.createElement('div');
                                    tileElement.className = 'tile';
                                    if (tile.isRed) tileElement.classList.add('red');
                                    if (tile.suit) tileElement.classList.add(tile.suit);
                                    
                                    tileElement.textContent = getTileDisplayName(tile);
                                    tileElement.onclick = () => selectTile(visualPos, tileIndex, tile);
                                    handElement.appendChild(tileElement);
                                });
                            }
                            
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è©³ç´°æƒ…å ±æ›´æ–°
                            document.getElementById('handCount').textContent = player.hand.tiles.length;
                            document.getElementById('playerName').textContent = player.name;
                            document.getElementById('playerScore').textContent = player.score;
                            document.getElementById('playerWind').textContent = player.wind;
                            console.log(`ğŸ” DEBUG: Player 0 hand updated successfully with ${player.hand.tiles.length} tiles`);
                        } else {
                            // å¯¾æˆ¦ç›¸æ‰‹ã®æ‰‹ç‰Œï¼ˆè£å‘ãï¼‰
                            console.log(`ğŸ” DEBUG: Updating opponent ${index} hand with ${player.hand.tiles.length} hidden tiles`);
                            for (let i = 0; i < player.hand.tiles.length; i++) {
                                const tileElement = document.createElement('div');
                                tileElement.className = 'opponent-tile';
                                tileElement.textContent = 'ğŸ€«';
                                handElement.appendChild(tileElement);
                            }
                            
                            // CPUç‚¹æ•°æ›´æ–°
                            const scoreElement = document.getElementById(`player${visualPos}Score`);
                            if (scoreElement) {
                                scoreElement.textContent = player.score;
                            }
                        }
                    } else {
                        console.warn(`ğŸ” DEBUG: Cannot update hand for player ${index} - missing handElement or tiles`);
                    }
                });
                
                console.log('ğŸ” DEBUG: Player info update completed');
            } catch (error) {
                console.error('ğŸ” DEBUG: Error updating player info:', error);
            }

            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³æ›´æ–°ï¼ˆæœ¬æ ¼éº»é›€ä»•æ§˜ï¼‰
            if (gameState.players) {
                gameState.players.forEach((player, playerIndex) => {
                    const visualPos = getVisualPosition(playerIndex, myPlayerId);
                    const riverElement = document.getElementById(`river${visualPos}`);
                    if (riverElement && player.hand && player.hand.discards) {
                        riverElement.innerHTML = '';
                        
                        player.hand.discards.forEach((tile, discardIndex) => {
                            const tileElement = document.createElement('div');
                            tileElement.className = 'river-tile';
                            
                            // èµ¤ç‰Œå‡¦ç†
                            if (tile.isRed) tileElement.classList.add('red');
                            if (tile.suit) tileElement.classList.add(tile.suit); // è‰²åˆ†ã‘ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
                            
                            // ãƒªãƒ¼ãƒå®£è¨€ç‰Œã¯æ¨ªå‘ã
                            if (player.hand.riichi && player.hand.riichiTile && 
                                isSameTile(tile, player.hand.riichiTile)) {
                                tileElement.classList.add('reach');
                            }
                            
                            // é³´ã„ãŸç‰Œï¼ˆãƒãƒ¼ãƒ»ãƒãƒ³ãƒ»ã‚«ãƒ³ã§å‘¼ã°ã‚ŒãŸç‰Œï¼‰ã®åˆ¤å®š
                            if (isCalledTile(tile, playerIndex, discardIndex)) {
                                tileElement.classList.add('called');
                            }
                            
                            tileElement.textContent = getTileDisplayName(tile);
                            
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã«å¿œã˜ãŸç‰Œã®å›è»¢
                            switch (visualPos) {
                                case 1: // CPUå—ï¼ˆä¸‹å®¶ï¼‰ï¼šå·¦ã«90åº¦å›è»¢
                                    tileElement.style.transform = 'rotate(-90deg)';
                                    break;
                                case 3: // CPUåŒ—ï¼ˆå¯¾é¢ï¼‰ï¼šå·¦ã«90åº¦å›è»¢
                                    tileElement.style.transform = 'rotate(-90deg)';
                                    break;
                                // case 0ï¼ˆè‡ªåˆ†ï¼‰ã¨case 2ï¼ˆCPUè¥¿ï¼‰ã¯ãã®ã¾ã¾
                            }
                            
                            // 6Ã—3ã‚°ãƒªãƒƒãƒ‰ã®é…ç½®é †åº
                            const gridOrder = calculateRiverOrder(visualPos, discardIndex);
                            tileElement.style.order = gridOrder;
                            
                            // ãƒ‡ãƒãƒƒã‚°ç”¨: orderå€¤ã‚’è¡¨ç¤º
                            if (visualPos === 0) {
                                tileElement.setAttribute('data-order', gridOrder);
                            }
                            
                            riverElement.appendChild(tileElement);
                        });
                    }
                });
            }

            // æœ€å¾Œã®æ¨ç‰Œæƒ…å ±ã‚’æ›´æ–°ï¼ˆé³´ãåˆ¤å®šç”¨ï¼‰
            updateLastDiscardedTile();
            
            // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateGameStatus();
            
            // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºæ›´æ–°
            updateMeldDisplay();
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            updateTenpaiStatus();
        }

        // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateMeldDisplay() {
            if (!gameState || !gameState.players) return;
            
            gameState.players.forEach((player, playerIndex) => {
                const visualPos = getVisualPosition(playerIndex, myPlayerId);
                const meldElement = document.getElementById(`melds${visualPos}`);
                if (!meldElement) return;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãƒ¡ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                if (!player.hand || !player.hand.melds || player.hand.melds.length === 0) {
                    meldElement.innerHTML = '';
                    return;
                }
                
                meldElement.innerHTML = '';
                
                player.hand.melds.forEach((meld, meldIndex) => {
                    const meldGroup = document.createElement('div');
                    meldGroup.className = 'meld-group';
                    meldGroup.style.display = 'flex';
                    meldGroup.style.gap = '2px';
                    meldGroup.style.margin = '5px';
                    meldGroup.style.padding = '5px';
                    meldGroup.style.background = 'rgba(255, 255, 255, 0.9)';
                    meldGroup.style.border = '2px solid #007bff';
                    meldGroup.style.borderRadius = '8px';
                    
                    // ãƒ¡ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ãƒ©ãƒ™ãƒ«
                    const typeLabel = document.createElement('div');
                    typeLabel.style.fontSize = '10px';
                    typeLabel.style.color = '#007bff';
                    typeLabel.style.fontWeight = 'bold';
                    typeLabel.style.marginRight = '5px';
                    
                    switch (meld.type) {
                        case 'chi':
                            typeLabel.textContent = 'ãƒãƒ¼';
                            break;
                        case 'pon':
                            typeLabel.textContent = 'ãƒãƒ³';
                            break;
                        case 'kan':
                        case 'ankan':
                        case 'minkan':
                            typeLabel.textContent = 'ã‚«ãƒ³';
                            break;
                    }
                    
                    meldGroup.appendChild(typeLabel);
                    
                    // ãƒ¡ãƒ«ãƒ‰ã®ç‰Œã‚’è¡¨ç¤º
                    meld.tiles.forEach((tile, tileIndex) => {
                        const tileElement = document.createElement('div');
                        tileElement.className = 'meld-tile';
                        tileElement.style.width = '20px';
                        tileElement.style.height = '28px';
                        tileElement.style.border = '1px solid #333';
                        tileElement.style.display = 'flex';
                        tileElement.style.alignItems = 'center';
                        tileElement.style.justifyContent = 'center';
                        tileElement.style.fontSize = '10px';
                        tileElement.style.background = 'white';
                        
                        // æš—æ§“ã®å ´åˆã€ç«¯ã®ç‰Œã¯è£å‘ã
                        if (meld.type === 'ankan' && (tileIndex === 0 || tileIndex === 3)) {
                            tileElement.textContent = 'ğŸ€«';
                            tileElement.style.background = '#e9ecef';
                        } else {
                            tileElement.textContent = getTileDisplayName(tile);
                            if (tile.suit) tileElement.classList.add(tile.suit); // è‰²åˆ†ã‘ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
                            if (tile.isRed) {
                                tileElement.style.color = '#dc3545';
                                tileElement.style.fontWeight = '800';
                            }
                        }
                        
                        meldGroup.appendChild(tileElement);
                    });
                    
                    meldElement.appendChild(meldGroup);
                });
            });
        }

        // æ²³ã®é…ç½®é †åºè¨ˆç®—ï¼ˆæœ¬æ ¼éº»é›€ä»•æ§˜ï¼‰
        function calculateRiverOrder(playerIndex, discardIndex) {
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šå›ºå®šä½ç½®ã§ãƒ†ã‚¹ãƒˆ
            if (discardIndex === 0) {
                // 1æšç›®ã®å›ºå®šä½ç½®
                switch (playerIndex) {
                    case 0: return 0;  // å·¦ä¸Š
                    case 1: return 8;  // ä¸‹ã®ä¸­å¤®
                    case 2: return 15; // å³ä¸Š  
                    case 3: return 3;  // ä¸Šã®å³
                }
            }
            
            // 2æšç›®ä»¥é™ã¯é †ç•ªã«
            const row = Math.floor(discardIndex / 6);
            const col = discardIndex % 6;
            return row * 6 + col;
        }
        
        // ç‰ŒãŒåŒã˜ã‹ãƒã‚§ãƒƒã‚¯
        function isSameTile(tile1, tile2) {
            if (!tile1 || !tile2) return false;
            if (tile1.suit !== tile2.suit) return false;
            if (tile1.suit === 'ji') {
                return tile1.honor === tile2.honor;
            }
            return tile1.rank === tile2.rank;
        }
        
        // é³´ã„ãŸç‰Œã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isCalledTile(tile, playerIndex, discardIndex) {
            if (!gameState || !gameState.gameLog) return false;
            
            // ã‚²ãƒ¼ãƒ ãƒ­ã‚°ã‹ã‚‰é³´ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
            for (let i = 0; i < gameState.gameLog.length; i++) {
                const log = gameState.gameLog[i];
                
                // ãƒãƒ¼ãƒ»ãƒãƒ³ãƒ»ã‚«ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
                if (log.type === 'meld' && log.calledTile) {
                    // é³´ã„ãŸç‰Œã¨æ¨ç‰Œã®ã‚¿ã‚¤ãƒ«ãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (isSameTile(tile, log.calledTile)) {
                        // é³´ã„ãŸå…ƒã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ç¾åœ¨ã®æ¨ç‰Œä½ç½®ãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (log.fromPlayer === playerIndex) {
                            return true;
                        }
                    }
                }
            }
            
            return false;
        }
        
        // æœ€å¾Œã®æ¨ç‰Œæƒ…å ±ã‚’æ›´æ–°
        function updateLastDiscardedTile() {
            if (!gameState) return;
            
            console.log('ğŸ”§ updateLastDiscardedTile called');
            console.log('ğŸ”§ gameState.lastDiscard:', gameState.lastDiscard);
            console.log('ğŸ”§ gameState.lastDiscardPlayer:', gameState.lastDiscardPlayer);
            
            // gameStateã‹ã‚‰ç›´æ¥å–å¾—ã‚’è©¦ã™
            if (gameState.lastDiscard && gameState.lastDiscardPlayer !== undefined && gameState.lastDiscardPlayer !== null) {
                lastDiscardedTile = gameState.lastDiscard;
                lastDiscardedPlayer = gameState.lastDiscardPlayer;
                console.log(`ğŸ”§ Last discard from gameState: ${lastDiscardedTile.displayName || lastDiscardedTile.suit + lastDiscardedTile.rank} by player ${lastDiscardedPlayer}`);
                console.log('ğŸ”§ lastDiscardedTile object:', lastDiscardedTile);
                return;
            }
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
            // console.log(`ğŸ”§ [DEBUG] gameState.lastDiscard:`, gameState.lastDiscard);
            // console.log(`ğŸ”§ [DEBUG] gameState.lastDiscardPlayer:`, gameState.lastDiscardPlayer);
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚²ãƒ¼ãƒ ãƒ­ã‚°ã‚’é€†é †ã§æ¤œç´¢ã—ã¦æœ€å¾Œã®æ¨ç‰Œã‚’è¦‹ã¤ã‘ã‚‹
            if (gameState.gameLog) {
                for (let i = gameState.gameLog.length - 1; i >= 0; i--) {
                    const log = gameState.gameLog[i];
                    if (log.type === 'discard' && log.data && log.data.tile) {
                        lastDiscardedTile = log.data.tile;
                        lastDiscardedPlayer = parseInt(log.playerId.replace('player_', ''));
                        console.log(`ğŸ”§ Last discard from log: ${log.data.tile.displayName} by player ${lastDiscardedPlayer}`);
                        return;
                    }
                }
            }
            
            // æ¨ç‰ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
            lastDiscardedTile = null;
            lastDiscardedPlayer = null;
            // console.log(`ğŸ”§ No last discard found, reset to null`);
        }

        // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateGameStatus() {
            const statusElement = document.getElementById('gameStatus');
            if (!gameState || !statusElement) return;

            const currentPlayerName = gameState.players[gameState.currentPlayer]?.name;
            const playerHand = gameState.players[myPlayerId].hand.tiles;
            const handCount = playerHand ? playerHand.length : 0;
            const isMyTurn = gameState.currentPlayer === myPlayerId;
            
            let statusText = `${currentPlayerName}ã®ã‚¿ãƒ¼ãƒ³`;
            if (isMyTurn) {
                if (handCount === 13) {
                    statusText = 'ãƒ„ãƒ¢ã—ã¦ãã ã•ã„';
                } else if (handCount === 14) {
                    statusText = 'æ‰“ç‰Œã—ã¦ãã ã•ã„';
                }
            }
            
            statusElement.textContent = statusText;
            statusElement.style.color = isMyTurn ? '#28a745' : '#6c757d';
            
            // ãƒ‰ãƒ©è¡¨ç¤ºã®æ›´æ–°
            updateDoraDisplay();
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            updateActionButtons();
        }
        
        function updateDoraDisplay() {
            const doraElement = document.getElementById('doraDisplay');
            if (!gameState || !doraElement) return;
            
            let doraText = '?';
            if (gameState.doraIndicators && gameState.doraIndicators.length > 0) {
                // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‰ãƒ©è¡¨ç¤ºç‰Œã‚’è¡¨ç¤º
                const doraIndicators = gameState.doraIndicators.map(tile => 
                    tile.displayName || tile.unicode || '?'
                ).join(' ');
                doraText = doraIndicators;
            } else if (gameState.dora) {
                // æ—§å½¢å¼ã®ãƒ‰ãƒ©è¡¨ç¤º
                doraText = gameState.dora.displayName || gameState.dora.unicode || '?';
            }
            
            doraElement.textContent = doraText;
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        function updateActionButtons() {
            if (!gameState) return;
            
            const isMyTurn = gameState.currentPlayer === myPlayerId;
            const player = gameState.players?.[myPlayerId];
            const handTiles = player?.hand?.tiles?.length || 0;
            const meldCount = player?.hand?.melds?.length || 0;
            const totalTiles = handTiles + (meldCount * 3);
            
            console.log('ğŸ” updateActionButtons DEBUG:', {
                handTiles,
                meldCount,
                totalTiles,
                isMyTurn
            });
            
            // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆlastDiscardedTileãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            const hasMeldOpportunity = lastDiscardedTile && lastDiscardedTile.playerId !== 0;
            
            // åŸºæœ¬ãƒœã‚¿ãƒ³åˆ¶å¾¡
            const drawBtn = document.getElementById('drawBtn');
            const discardBtn = document.getElementById('discardBtn');
            const riichiBtn = document.getElementById('riichiBtn');
            const tsumoBtn = document.getElementById('tsumoBtn');
            
            if (drawBtn) drawBtn.style.display = (isMyTurn && totalTiles === 13) ? 'inline-block' : 'none';
            if (discardBtn) discardBtn.style.display = (isMyTurn && totalTiles === 14) ? 'inline-block' : 'none';
            if (riichiBtn) riichiBtn.style.display = (isMyTurn && totalTiles === 14 && canCallRiichi()) ? 'inline-block' : 'none';
            if (tsumoBtn) tsumoBtn.style.display = (isMyTurn && totalTiles === 14 && canCallTsumo()) ? 'inline-block' : 'none';
            
            // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã‚‚è¡¨ç¤ºå¯èƒ½
            const chiBtn = document.getElementById('chiBtn');
            const ponBtn = document.getElementById('ponBtn');
            const kanBtn = document.getElementById('kanBtn');
            const ronBtn = document.getElementById('ronBtn');
            
            // ãƒ¡ãƒ«ãƒ‰ãƒœã‚¿ãƒ³ã®æ¡ä»¶è¡¨ç¤ºï¼ˆãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šãŒã‚ã‚‹å ´åˆã¯æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ä¿æŒï¼‰
            // ãƒ¡ãƒ«ãƒ‰æ©Ÿä¼šãŒãªã„å ´åˆã®ã¿éè¡¨ç¤ºã«ã™ã‚‹
            if (chiBtn && !hasMeldOpportunity) chiBtn.style.display = 'none';  
            if (ponBtn && !hasMeldOpportunity) ponBtn.style.display = 'none';  
            
            // ã‚«ãƒ³ãƒœã‚¿ãƒ³ã¯åŠ æ§“ãƒ»æš—æ§“å¯èƒ½ãªå ´åˆã‚‚è¡¨ç¤º
            const canKakan = isMyTurn && canCallKakan();
            const canAnkan = isMyTurn && canCallAnkan();
            const canAnyKan = canKakan || canAnkan;
            
            if (kanBtn && !hasMeldOpportunity && !canAnyKan) kanBtn.style.display = 'none';
            if (kanBtn && canAnyKan) kanBtn.style.display = 'inline-block';
            const canRon = canCallRon();
            console.log('ğŸ” ãƒ­ãƒ³ãƒœã‚¿ãƒ³åˆ¶å¾¡:', {
                isMyTurn: isMyTurn,
                canRon: canRon,
                lastDiscardedTile: lastDiscardedTile,
                shouldShowRon: !isMyTurn && canRon
            });
            if (ronBtn) ronBtn.style.display = (!isMyTurn && canRon) ? 'inline-block' : 'none';
            
            // æ¨ã¦ç‰Œæ›´æ–°ã‚’è¿½è·¡
            trackDiscardUpdates();
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function canCallRiichi() {
            if (!gameState || !gameState.players[myPlayerId]) return false;
            const player = gameState.players[myPlayerId];
            return !player.hand.riichi && player.score >= 1000; // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ãªã„ã€1000ç‚¹ä»¥ä¸Šã‚ã‚‹
        }
        
        // åŠ æ§“å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canCallKakan() {
            if (!gameState || !gameState.players[0]) return false;
            
            const player = gameState.players[0];
            const myTiles = player.hand.tiles || [];
            const myMelds = player.hand.melds || [];
            
            // ãƒãƒ³ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (const meld of myMelds) {
                if (meld.type === 'pon') {
                    const meldTile = meld.tiles[0];
                    // æ‰‹ç‰Œã«åŒã˜ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    for (const handTile of myTiles) {
                        if (isSameTile(handTile, meldTile)) {
                            return true;
                        }
                    }
                }
            }
            
            return false;
        }
        
        // æš—æ§“å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canCallAnkan() {
            if (!gameState || !gameState.players[0]) return false;
            
            const player = gameState.players[0];
            const myTiles = player.hand.tiles || [];
            
            // æ‰‹ç‰Œã§4æšåŒã˜ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const tileCounts = {};
            for (const tile of myTiles) {
                const key = `${tile.suit}_${tile.rank}_${tile.honor}`;
                if (!tileCounts[key]) tileCounts[key] = [];
                tileCounts[key].push(tile);
            }
            
            // 4æšæƒã£ã¦ã„ã‚‹ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (const [key, tiles] of Object.entries(tileCounts)) {
                if (tiles.length >= 4) {
                    console.log('ğŸ” æš—æ§“å¯èƒ½:', key, tiles);
                    return true;
                }
            }
            
            return false;
        }
        
        function canCallTsumo() {
            if (!gameState || !gameState.players[0]) return false;
            
            const player = gameState.players[0];
            const handTiles = player.hand.tiles.length;
            const meldCount = player.hand.melds ? player.hand.melds.length : 0;
            const totalTiles = handTiles + (meldCount * 3);
            
            console.log('ğŸ” canCallTsumo DEBUG:', {
                handTiles,
                meldCount,
                totalTiles,
                currentPlayer: gameState.currentPlayer
            });
            
            // ç·ç‰Œæ•°ãŒ14æšã§ãªã„ã¨ãƒ„ãƒ¢ã§ããªã„
            if (totalTiles !== 14) return false;
            
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ãªã„ã¨ãƒ„ãƒ¢ã§ããªã„
            if (gameState.currentPlayer !== 0) return false;
            
            // å®Ÿéš›ã®å’Œäº†å½¢ãƒã‚§ãƒƒã‚¯
            const canWin = checkClientWinning(player.hand.tiles, player.hand.melds);
            console.log('ğŸ” canCallTsumo å’Œäº†ãƒã‚§ãƒƒã‚¯:', {
                tiles: player.hand.tiles,
                melds: player.hand.melds,
                canWin: canWin
            });
            return canWin;
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤åˆ¤å®šï¼ˆæ”¹å–„ç‰ˆï¼šã‚µãƒ¼ãƒãƒ¼æƒ…å ±å„ªå…ˆï¼‰
        function checkClientTenpai() {
            if (!gameState || !gameState.players[0]) {
                return { isTenpai: false, waitingTiles: [] };
            }
            
            const player = gameState.players[0];
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ†ãƒ³ãƒ‘ã‚¤æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
            if (player.tenpaiInfo) {
                return {
                    isTenpai: player.tenpaiInfo.isTenpai,
                    waitingTiles: player.tenpaiInfo.waitingTiles || [],
                    waitType: player.tenpaiInfo.waitType,
                    isFuriten: player.tenpaiInfo.isFuriten
                };
            }
            
            // ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ãŒãªã„å ´åˆã®ç°¡æ˜“åˆ¤å®š
            const handTiles = player.hand.tiles.length;
            const meldCount = player.hand.melds ? player.hand.melds.length : 0;
            const totalTiles = handTiles + (meldCount * 3);
            
            console.log('ğŸ” checkClientTenpai DEBUG:', {
                handTiles,
                meldCount,
                totalTiles,
                actualTiles: player.hand.tiles,
                actualMelds: player.hand.melds
            });
            
            // 13æšã®å ´åˆã®ã¿ãƒ†ãƒ³ãƒ‘ã‚¤ãƒã‚§ãƒƒã‚¯
            if (totalTiles !== 13) {
                return { isTenpai: false, waitingTiles: [] };
            }
            
            // ã‚ˆã‚Šæ­£ç¢ºãªãƒ†ãƒ³ãƒ‘ã‚¤åˆ¤å®šï¼ˆå¼·åŒ–ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ï¼‰
            try {
                const handForAnalysis = convertTilesToAdvancedFormat(player.hand.tiles);
                const meldsForAnalysis = convertMeldsToAdvancedFormat(player.hand.melds || []);
                
                // å„ç‰Œã‚’è¿½åŠ ã—ã¦ã¿ã¦å’Œäº†å½¢ã«ãªã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const allTileTypes = generateAllTileTypes();
                const waitingTiles = [];
                
                for (const testTile of allTileTypes) {
                    const testHand = [...handForAnalysis, testTile];
                    if (isCompleteHand(testHand, meldsForAnalysis)) {
                        // å½¹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const yaku = calculateAdvancedYaku(testHand, meldsForAnalysis);
                        
                        console.log('ğŸ” ãƒ†ãƒ³ãƒ‘ã‚¤å½¹åˆ¤å®š:', {
                            testTile: testTile,
                            hand: testHand,
                            melds: meldsForAnalysis,
                            yaku: yaku
                        });
                        
                        const waitingTileInfo = {
                            suit: testTile.suit,
                            rank: testTile.rank,
                            honor: testTile.type || null,
                            displayName: getTileDisplayName(testTile),
                            hasYaku: yaku.length > 0,
                            yaku: yaku
                        };
                        
                        // å½¹ãŒã‚ã‚‹å ´åˆã€ã¾ãŸã¯å½¹ãªã—ã§ã‚‚å’Œäº†å½¢ã®å ´åˆã¯è¿½åŠ 
                        if (yaku.length > 0 || isCompleteHand(testHand, meldsForAnalysis)) {
                            waitingTiles.push(waitingTileInfo);
                        }
                    }
                }
                
                return {
                    isTenpai: waitingTiles.length > 0,
                    waitingTiles: waitingTiles
                };
                
            } catch (error) {
                console.warn('ãƒ†ãƒ³ãƒ‘ã‚¤åˆ¤å®šã‚¨ãƒ©ãƒ¼:', error);
                return { isTenpai: false, waitingTiles: [] };
            }
        }
        
        // å…¨ç‰Œç¨®é¡ç”Ÿæˆ
        function generateAllTileTypes() {
            const tiles = [];
            
            // æ•°ç‰Œ
            ['man', 'pin', 'sou'].forEach(suit => {
                for (let rank = 1; rank <= 9; rank++) {
                    tiles.push({ suit, rank });
                }
            });
            
            // å­—ç‰Œ
            ['east', 'south', 'west', 'north', 'haku', 'hatsu', 'chun'].forEach(type => {
                tiles.push({ suit: 'honors', type });
            });
            
            return tiles;
        }
        
        // ã‚ˆã‚Šè©³ç´°ãªåŸºæœ¬å½¢å’Œäº†ãƒã‚§ãƒƒã‚¯
        function checkBasicWinForm(hand, melds = []) {
            if (!hand || hand.length === 0) return false;
            
            // æ‰‹ç‰Œã‚’æ•°ç‰Œã¨å­—ç‰Œã«åˆ†ã‘ã‚‹
            const numberTiles = {};
            const honorTiles = {};
            
            for (const tile of hand) {
                if (tile.suit && (tile.suit === 'man' || tile.suit === 'pin' || tile.suit === 'sou')) {
                    if (!numberTiles[tile.suit]) numberTiles[tile.suit] = {};
                    const rank = tile.rank || tile.number;
                    numberTiles[tile.suit][rank] = (numberTiles[tile.suit][rank] || 0) + 1;
                } else {
                    const key = tile.honor || tile.type || `${tile.suit}_${tile.rank}`;
                    honorTiles[key] = (honorTiles[key] || 0) + 1;
                }
            }
            
            // é¢å­ã¨é›€é ­ã®çµ„ã¿åˆã‚ã›ã‚’å†å¸°çš„ã«ãƒã‚§ãƒƒã‚¯
            const requiredMentsus = 4 - melds.length;
            return checkMentsuCombination(numberTiles, honorTiles, requiredMentsus, 0, false);
        }
        
        // é¢å­çµ„ã¿åˆã‚ã›ã®å†å¸°ãƒã‚§ãƒƒã‚¯
        function checkMentsuCombination(numberTiles, honorTiles, requiredMentsus, foundMentsus, hasJantou) {
            // å¿…è¦ãªé¢å­æ•°ã«é”ã—ãŸå ´åˆ
            if (foundMentsus >= requiredMentsus) {
                // é›€é ­ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (hasJantou) {
                    // æ®‹ã‚Šç‰ŒãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
                    const remainingTiles = countRemainingTiles(numberTiles, honorTiles);
                    return remainingTiles === 0;
                } else {
                    // é›€é ­ã‚’ä½œã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const remainingTiles = countRemainingTiles(numberTiles, honorTiles);
                    return remainingTiles === 2 && canMakeJantou(numberTiles, honorTiles);
                }
            }
            
            // å­—ç‰Œã®åˆ»å­ã‚’ãƒã‚§ãƒƒã‚¯
            for (const [type, count] of Object.entries(honorTiles)) {
                if (count >= 3) {
                    honorTiles[type] -= 3;
                    if (checkMentsuCombination(numberTiles, honorTiles, requiredMentsus, foundMentsus + 1, hasJantou)) {
                        honorTiles[type] += 3;
                        return true;
                    }
                    honorTiles[type] += 3;
                }
            }
            
            // æ•°ç‰Œã®é¢å­ã‚’ãƒã‚§ãƒƒã‚¯
            for (const suit of ['man', 'pin', 'sou']) {
                if (numberTiles[suit]) {
                    // åˆ»å­ãƒã‚§ãƒƒã‚¯
                    for (let rank = 1; rank <= 9; rank++) {
                        if ((numberTiles[suit][rank] || 0) >= 3) {
                            numberTiles[suit][rank] -= 3;
                            if (checkMentsuCombination(numberTiles, honorTiles, requiredMentsus, foundMentsus + 1, hasJantou)) {
                                numberTiles[suit][rank] += 3;
                                return true;
                            }
                            numberTiles[suit][rank] += 3;
                        }
                    }
                    
                    // é †å­ãƒã‚§ãƒƒã‚¯
                    for (let rank = 1; rank <= 7; rank++) {
                        if ((numberTiles[suit][rank] || 0) >= 1 && 
                            (numberTiles[suit][rank + 1] || 0) >= 1 && 
                            (numberTiles[suit][rank + 2] || 0) >= 1) {
                            numberTiles[suit][rank]--;
                            numberTiles[suit][rank + 1]--;
                            numberTiles[suit][rank + 2]--;
                            if (checkMentsuCombination(numberTiles, honorTiles, requiredMentsus, foundMentsus + 1, hasJantou)) {
                                numberTiles[suit][rank]++;
                                numberTiles[suit][rank + 1]++;
                                numberTiles[suit][rank + 2]++;
                                return true;
                            }
                            numberTiles[suit][rank]++;
                            numberTiles[suit][rank + 1]++;
                            numberTiles[suit][rank + 2]++;
                        }
                    }
                }
            }
            
            return false;
        }
        
        // æ®‹ã‚Šç‰Œæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        function countRemainingTiles(numberTiles, honorTiles) {
            let count = 0;
            
            for (const suit of Object.values(numberTiles)) {
                for (const tileCount of Object.values(suit)) {
                    count += tileCount;
                }
            }
            
            for (const tileCount of Object.values(honorTiles)) {
                count += tileCount;
            }
            
            return count;
        }
        
        // é›€é ­ã‚’ä½œã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function canMakeJantou(numberTiles, honorTiles) {
            // å­—ç‰Œã§é›€é ­
            for (const count of Object.values(honorTiles)) {
                if (count === 2) return true;
            }
            
            // æ•°ç‰Œã§é›€é ­
            for (const suit of Object.values(numberTiles)) {
                for (const count of Object.values(suit)) {
                    if (count === 2) return true;
                }
            }
            
            return false;
        }

        // å’Œäº†å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function isCompleteHand(hand, melds = []) {
            if (!hand) return false;
            
            // ãƒ¡ãƒ«ãƒ‰ã‚’è€ƒæ…®ã—ãŸç·ç‰Œæ•°ãƒã‚§ãƒƒã‚¯
            const totalTiles = hand.length + (melds.length * 3);
            if (totalTiles !== 14) return false;
            
            // ä¸ƒå¯¾å­ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¡ãƒ«ãƒ‰ãŒãªã„å ´åˆã®ã¿ï¼‰
            if (melds.length === 0 && checkChiitoiAdvanced(hand)) return true;
            
            // å›½å£«ç„¡åŒãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¡ãƒ«ãƒ‰ãŒãªã„å ´åˆã®ã¿ï¼‰
            if (melds.length === 0 && checkKokushiAdvanced(hand)) return true;
            
            // åŸºæœ¬å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆ4é¢å­1é›€é ­ï¼‰- ã‚ˆã‚Šè©³ç´°ãªåˆ¤å®š
            return checkBasicWinForm(hand, melds);
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹ã‚’æ›´æ–°ãƒ»è¡¨ç¤º
        function updateTenpaiStatus() {
            if (!gameState || !gameState.players[0]) return;
            
            const newTenpaiStatus = checkClientTenpai();
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹ã‚„å¾…ã¡ç‰ŒãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿æ›´æ–°
            const waitingTilesChanged = JSON.stringify(newTenpaiStatus.waitingTiles) !== JSON.stringify(currentTenpaiStatus.waitingTiles);
            
            if (newTenpaiStatus.isTenpai !== currentTenpaiStatus.isTenpai || waitingTilesChanged) {
                currentTenpaiStatus = newTenpaiStatus;
                
                if (currentTenpaiStatus.isTenpai) {
                    // å½¹ã‚ã‚Šãƒ»å½¹ãªã—å¾…ã¡ã‚’åˆ†é¡
                    const yakuTiles = currentTenpaiStatus.waitingTiles.filter(t => t.hasYaku);
                    const noyakuTiles = currentTenpaiStatus.waitingTiles.filter(t => !t.hasYaku);
                    
                    let notificationText = 'ãƒ†ãƒ³ãƒ‘ã‚¤ï¼';
                    
                    if (yakuTiles.length > 0) {
                        const yakuWaitingText = yakuTiles.map(t => t.displayName).join('ãƒ»');
                        notificationText += ` å½¹ã‚ã‚Šå¾…ã¡: ${yakuWaitingText}`;
                    }
                    
                    if (noyakuTiles.length > 0) {
                        const noyakuWaitingText = noyakuTiles.map(t => t.displayName).join('ãƒ»');
                        if (yakuTiles.length > 0) {
                            notificationText += ` / å½¹ãªã—: ${noyakuWaitingText}`;
                        } else {
                            notificationText += ` å½¹ãªã—å¾…ã¡: ${noyakuWaitingText}`;
                        }
                    }
                    
                    showNotification(notificationText, yakuTiles.length > 0 ? 'success' : 'warning');
                    console.log('ğŸ¯ ãƒ†ãƒ³ãƒ‘ã‚¤çŠ¶æ…‹:', currentTenpaiStatus);
                } else {
                    console.log('ğŸ¯ ãƒ†ãƒ³ãƒ‘ã‚¤è§£é™¤');
                }
            }
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã®æ›´æ–°
            displayTenpaiStatus();
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤º
        function displayTenpaiStatus() {
            // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
            let tenpaiDisplay = document.getElementById('tenpaiDisplay');
            if (!tenpaiDisplay) {
                tenpaiDisplay = document.createElement('div');
                tenpaiDisplay.id = 'tenpaiDisplay';
                tenpaiDisplay.style.cssText = `
                    position: fixed;
                    top: 120px;
                    right: 20px;
                    background: rgba(255, 193, 7, 0.9);
                    color: #212529;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-weight: bold;
                    font-size: 0.9rem;
                    z-index: 1000;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    border: 2px solid #ffc107;
                `;
                document.body.appendChild(tenpaiDisplay);
            }
            
            if (currentTenpaiStatus.isTenpai) {
                // å½¹ã‚ã‚Šãƒ»å½¹ãªã—å¾…ã¡ã‚’åˆ†é¡
                const yakuTiles = currentTenpaiStatus.waitingTiles.filter(t => t.hasYaku);
                const noyakuTiles = currentTenpaiStatus.waitingTiles.filter(t => !t.hasYaku);
                
                let content = 'ğŸ¯ ãƒ†ãƒ³ãƒ‘ã‚¤<br>';
                
                if (yakuTiles.length > 0) {
                    const yakuText = yakuTiles.map(t => t.displayName).join('ãƒ»');
                    content += `<small style="color: #28a745;">å½¹ã‚ã‚Š: ${yakuText}</small>`;
                }
                
                if (noyakuTiles.length > 0) {
                    const noyakuText = noyakuTiles.map(t => t.displayName).join('ãƒ»');
                    if (yakuTiles.length > 0) {
                        content += '<br>';
                    }
                    content += `<small style="color: #dc3545;">å½¹ãªã—: ${noyakuText}</small>`;
                }
                
                // èƒŒæ™¯è‰²ã‚’å½¹ã®æœ‰ç„¡ã«å¿œã˜ã¦å¤‰æ›´
                if (yakuTiles.length > 0) {
                    tenpaiDisplay.style.background = 'rgba(40, 167, 69, 0.9)'; // ç·‘ï¼ˆå½¹ã‚ã‚Šï¼‰
                    tenpaiDisplay.style.color = 'white';
                } else {
                    tenpaiDisplay.style.background = 'rgba(255, 193, 7, 0.9)'; // é»„ï¼ˆå½¹ãªã—ã®ã¿ï¼‰
                    tenpaiDisplay.style.color = '#212529';
                }
                
                tenpaiDisplay.innerHTML = content;
                tenpaiDisplay.style.display = 'block';
            } else {
                tenpaiDisplay.style.display = 'none';
            }
        }
        
        function canCallChi() {
            if (!gameState || !gameState.players[0] || !lastDiscardedTile) return false;
            
            // ãƒãƒ¼ã¯å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã®ã¿å¯èƒ½
            const prevPlayer = (gameState.currentPlayer + 3) % 4;
            if (lastDiscardedPlayer !== prevPlayer) return false;
            
            // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹å ´åˆã¯é³´ã‘ãªã„
            if (gameState.players[0].hand.riichi) return false;
            
            // ç°¡æ˜“åˆ¤å®š: åŒã˜ã‚¹ãƒ¼ãƒˆï¼ˆjiä»¥å¤–ï¼‰ã§é€£ç¶šã™ã‚‹ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const discardedTile = lastDiscardedTile;
            if (discardedTile.suit === 'ji') return false; // å­—ç‰Œã¯ãƒãƒ¼ä¸å¯
            
            const myTiles = gameState.players[0].hand.tiles;
            const targetRank = discardedTile.rank;
            
            // é€£ç¶šã™ã‚‹ç‰Œã®çµ„ã¿åˆã‚ã›ã‚’ãƒã‚§ãƒƒã‚¯
            const hasSequence = myTiles.some((tile1, i) => 
                myTiles.some((tile2, j) => {
                    if (i >= j) return false;
                    if (tile1.suit !== discardedTile.suit || tile2.suit !== discardedTile.suit) return false;
                    
                    // 3ã¤ã®æ•°å­—ã®çµ„ã¿åˆã‚ã›ã‚’ãƒã‚§ãƒƒã‚¯
                    const ranks = [tile1.rank, tile2.rank, targetRank].sort((a, b) => a - b);
                    return ranks[0] + 1 === ranks[1] && ranks[1] + 1 === ranks[2];
                })
            );
            
            return hasSequence;
        }
        
        function canCallPon() {
            if (!gameState || !gameState.players[0] || !lastDiscardedTile) return false;
            
            // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹å ´åˆã¯é³´ã‘ãªã„
            if (gameState.players[0].hand.riichi) return false;
            
            // åŒã˜ç‰ŒãŒ2æšä»¥ä¸Šæ‰‹ç‰Œã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const discardedTile = lastDiscardedTile;
            const myTiles = gameState.players[0].hand.tiles;
            
            let matchCount = 0;
            for (const tile of myTiles) {
                if (isSameTile(tile, discardedTile)) {
                    matchCount++;
                    if (matchCount >= 2) return true;
                }
            }
            
            return false;
        }
        
        function canCallKan() {
            if (!gameState || !gameState.players[0]) return false;
            
            // æ—¢ã«ãƒªãƒ¼ãƒã—ã¦ã„ã‚‹å ´åˆã¯é³´ã‘ãªã„ï¼ˆæš—æ§“ã¯ä¾‹å¤–ã ãŒç°¡ç•¥åŒ–ï¼‰
            if (gameState.players[0].hand.riichi) return false;
            
            const myTiles = gameState.players[0].hand.tiles;
            
            // åŒã˜ç‰ŒãŒ4æšã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæš—æ§“ï¼‰
            const tileCounts = {};
            for (const tile of myTiles) {
                const key = `${tile.suit}_${tile.rank}_${tile.honor}`;
                tileCounts[key] = (tileCounts[key] || 0) + 1;
                if (tileCounts[key] >= 4) return true;
            }
            
            // æ˜æ§“ã®å ´åˆï¼ˆç›¸æ‰‹ã®æ¨ç‰Œ+æ‰‹ç‰Œ3æšï¼‰
            if (lastDiscardedTile) {
                let matchCount = 0;
                for (const tile of myTiles) {
                    if (isSameTile(tile, lastDiscardedTile)) {
                        matchCount++;
                        if (matchCount >= 3) return true;
                    }
                }
            }
            
            return false;
        }
        
        function canCallRon() {
            if (!gameState || !gameState.players[0] || !lastDiscardedTile) return false;
            
            const player = gameState.players[0];
            const handTiles = player.hand.tiles.length;
            const meldCount = player.hand.melds ? player.hand.melds.length : 0;
            const totalTiles = handTiles + (meldCount * 3);
            
            console.log('ğŸ” canCallRon DEBUG:', {
                handTiles,
                meldCount,
                totalTiles,
                currentPlayer: gameState.currentPlayer,
                lastDiscardedTile: lastDiscardedTile
            });
            
            // ç·ç‰Œæ•°ãŒ13æšã§ãªã„ã¨ãƒ­ãƒ³ã§ããªã„
            if (totalTiles !== 13) return false;
            
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã¯ãƒ­ãƒ³ã§ããªã„
            if (gameState.currentPlayer === 0) return false;
            
            // æ¨ã¦ç‰Œã‚’åŠ ãˆãŸ14æšã§ã®å’Œäº†å½¢ãƒã‚§ãƒƒã‚¯
            const discardedTile = lastDiscardedTile.tile || lastDiscardedTile;
            const tilesWithRon = [...player.hand.tiles, discardedTile];
            
            console.log('ğŸ” ãƒ­ãƒ³åˆ¤å®šè©³ç´°:', {
                handTiles: player.hand.tiles,
                discardedTile: discardedTile,
                tilesWithRon: tilesWithRon,
                melds: player.hand.melds,
                totalTilesWithRon: tilesWithRon.length + (player.hand.melds?.length || 0) * 3
            });
            
            const canWin = checkClientWinning(tilesWithRon, player.hand.melds);
            console.log('ğŸ” ãƒ­ãƒ³åˆ¤å®šçµæœ:', canWin);
            
            return canWin;
        }

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´å’Œäº†å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function checkClientWinning(tiles, melds = []) {
            if (!tiles || tiles.length === 0) return false;
            
            // ãƒ¡ãƒ«ãƒ‰ã‚’å«ã‚ãŸå…¨ç‰Œæ•°ãŒ14æšã«ãªã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const totalTiles = tiles.length + (melds.length * 3);
            if (totalTiles !== 14) return false;
            
            try {
                // åŸºæœ¬å’Œäº†å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆ4é¢å­1é›€é ­ï¼‰
                if (checkClientBasicWin(tiles, melds)) return true;
                
                // ä¸ƒå¯¾å­ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¡ãƒ«ãƒ‰ãŒãªã„å ´åˆã®ã¿ï¼‰
                if (melds.length === 0 && checkClientChiitoi(tiles)) return true;
                
                return false;
            } catch (error) {
                console.error('ğŸ” checkClientWinning error:', error);
                console.error('ğŸ” tiles:', tiles);
                console.error('ğŸ” melds:', melds);
                return false;
            }
        }

        // åŸºæœ¬å’Œäº†å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function checkClientBasicWin(tiles, melds) {
            console.log('ğŸ” checkClientBasicWin tiles:', tiles);
            
            // æ‰‹ç‰Œã‚’ã‚½ãƒ¼ãƒˆ
            const sortedTiles = [...tiles].filter(tile => tile).sort((a, b) => {
                if (!a || !b) return 0;
                
                // suitãŒundefinedã®å ´åˆã®å®‰å…¨ãªå‡¦ç†
                const aSuit = a.suit || '';
                const bSuit = b.suit || '';
                
                if (aSuit !== bSuit) return aSuit.localeCompare(bSuit);
                const aRank = a.rank || a.number || 0;
                const bRank = b.rank || b.number || 0;
                return aRank - bRank;
            });
            
            // å†å¸°çš„ã«é¢å­ã‚’å–ã‚Šé™¤ã„ã¦é›€é ­ãŒæ®‹ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            return findMentsusAndJantou(sortedTiles, []);
        }

        // é¢å­ã¨é›€é ­ã®çµ„ã¿åˆã‚ã›ã‚’æ¢ã™å†å¸°é–¢æ•°
        function findMentsusAndJantou(tiles, usedGroups) {
            if (tiles.length === 0) return usedGroups.length > 0;
            if (tiles.length < 2) return false;
            
            // é›€é ­ã‚’æ¢ã™
            if (tiles.length >= 2 && tiles[0] && tiles[1] && tiles[0].suit === tiles[1].suit && tiles[0].rank === tiles[1].rank) {
                const remaining = tiles.slice(2);
                if (remaining.length === 0) return true; // é›€é ­ã®ã¿ã§çµ‚äº†
                
                // æ®‹ã‚Šã®ç‰Œã§é¢å­ã‚’ä½œã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (findAllMentsus(remaining)) return true;
            }
            
            // å…ˆé ­ã‹ã‚‰é¢å­ã‚’ä½œã£ã¦å†å¸°
            // åˆ»å­ãƒã‚§ãƒƒã‚¯
            if (tiles.length >= 3 && tiles[0] && tiles[1] && tiles[2] &&
                tiles[0].suit === tiles[1].suit && tiles[0].rank === tiles[1].rank &&
                tiles[1].suit === tiles[2].suit && tiles[1].rank === tiles[2].rank) {
                const remaining = tiles.slice(3);
                if (findMentsusAndJantou(remaining, [...usedGroups, 'kotsu'])) return true;
            }
            
            // é †å­ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°ç‰Œã®ã¿ï¼‰
            if (tiles[0] && tiles[0].suit !== 'honors' && tiles.length >= 3) {
                const tile1 = tiles[0];
                const tile1Rank = tile1.rank || tile1.number || 0;
                const tile2Index = tiles.findIndex(t => t && t.suit === tile1.suit && (t.rank || t.number || 0) === tile1Rank + 1);
                const tile3Index = tiles.findIndex(t => t && t.suit === tile1.suit && (t.rank || t.number || 0) === tile1Rank + 2);
                
                if (tile2Index !== -1 && tile3Index !== -1) {
                    const remaining = [...tiles];
                    remaining.splice(tile3Index, 1);
                    remaining.splice(tile2Index > tile3Index ? tile2Index - 1 : tile2Index, 1);
                    remaining.splice(0, 1);
                    
                    if (findMentsusAndJantou(remaining, [...usedGroups, 'shuntsu'])) return true;
                }
            }
            
            return false;
        }

        // ã™ã¹ã¦é¢å­ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function findAllMentsus(tiles) {
            if (tiles.length === 0) return true;
            if (tiles.length % 3 !== 0) return false;
            
            // åˆ»å­ãƒã‚§ãƒƒã‚¯
            if (tiles.length >= 3 && tiles[0] && tiles[1] && tiles[2] &&
                tiles[0].suit === tiles[1].suit && tiles[0].rank === tiles[1].rank &&
                tiles[1].suit === tiles[2].suit && tiles[1].rank === tiles[2].rank) {
                return findAllMentsus(tiles.slice(3));
            }
            
            // é †å­ãƒã‚§ãƒƒã‚¯
            if (tiles[0] && tiles[0].suit !== 'honors' && tiles.length >= 3) {
                const tile1 = tiles[0];
                const tile1Rank = tile1.rank || tile1.number || 0;
                const tile2Index = tiles.findIndex(t => t && t.suit === tile1.suit && (t.rank || t.number || 0) === tile1Rank + 1);
                const tile3Index = tiles.findIndex(t => t && t.suit === tile1.suit && (t.rank || t.number || 0) === tile1Rank + 2);
                
                if (tile2Index !== -1 && tile3Index !== -1) {
                    const remaining = [...tiles];
                    remaining.splice(tile3Index, 1);
                    remaining.splice(tile2Index > tile3Index ? tile2Index - 1 : tile2Index, 1);
                    remaining.splice(0, 1);
                    
                    return findAllMentsus(remaining);
                }
            }
            
            return false;
        }

        // ä¸ƒå¯¾å­ãƒã‚§ãƒƒã‚¯
        function checkClientChiitoi(tiles) {
            if (tiles.length !== 14) return false;
            
            const tileCounts = {};
            for (const tile of tiles) {
                if (!tile) continue;
                const rank = tile.rank || tile.number || 0;
                const key = `${tile.suit}_${rank}`;
                tileCounts[key] = (tileCounts[key] || 0) + 1;
            }
            
            const counts = Object.values(tileCounts);
            return counts.length === 7 && counts.every(count => count === 2);
        }

        // ç‰Œé¸æŠ
        function selectTile(playerIndex, tileIndex, tile) {
            // è¦–è¦šä½ç½®ã‹ã‚‰å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’å–å¾—
            const actualPlayerId = getActualPlayerId(playerIndex, myPlayerId);
            
            if (actualPlayerId !== myPlayerId) {
                showNotification('è‡ªåˆ†ã®ç‰Œã®ã¿é¸æŠã§ãã¾ã™', 'warning');
                return;
            }
            
            if (gameState && gameState.currentPlayer !== myPlayerId) {
                showNotification('ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            // é¸æŠè§£é™¤
            document.querySelectorAll('.tile.selected').forEach(t => t.classList.remove('selected'));

            // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ç‰Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯æ‰“ç‰Œ
            if (selectedTile && selectedTile.tileIndex === tileIndex && selectedTile.tile.id === tile.id) {
                discardSelected();
                return;
            }

            // æ–°ã—ã„ç‰Œã‚’é¸æŠ
            selectedTile = { playerIndex: actualPlayerId, tileIndex, tile };
            document.getElementById('hand0').children[tileIndex].classList.add('selected');
            soundManager.playSound('tileSelect');
            showNotification(`${tile.displayName || tile.unicode} ã‚’é¸æŠï¼ˆå†ã‚¯ãƒªãƒƒã‚¯ã§æ‰“ç‰Œï¼‰`, 'info');
        }

        // æ‰“ç‰Œå‡¦ç†
        function discardSelected() {
            console.log('ğŸ¯ discardSelected called');
            console.log('ğŸ” selectedTile:', selectedTile);
            console.log('ğŸ” gameId:', gameId);
            console.log('ğŸ” isConnected:', isConnected);
            
            if (!selectedTile) {
                showNotification('ç‰Œã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            if (!gameId) {
                showNotification('ã‚²ãƒ¼ãƒ IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                console.error('âŒ gameId is null/undefined');
                return;
            }
            
            if (!isConnected) {
                showNotification('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            console.log('ğŸ¯ æ‰“ç‰Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡:', selectedTile.tile);
            socket.emit('playerAction', {
                type: 'discard',
                playerId: 'player_0',
                tileId: selectedTile.tile.id,
                priority: 1,
                timestamp: Date.now()
            });
            
            selectedTile = null;
            soundManager.playSound('tilePlace');
        }

        // ãƒ„ãƒ¢å‡¦ç†
        function drawTile() {
            if (!gameId || !isConnected) {
                showNotification('ã‚²ãƒ¼ãƒ ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('ğŸ¯ ãƒ„ãƒ¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'draw',
                playerId: 'player_0',
                priority: 1,
                timestamp: Date.now()
            });
            
            soundManager.playSound('tilePlace');
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹å–å¾—
        function requestGameState() {
            if (!gameId || !isConnected) {
                showNotification('ã‚²ãƒ¼ãƒ ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('ğŸ”„ ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ');
            socket.emit('requestGameState');
        }

        // AIå®Ÿè¡Œ
        async function executeAI() {
            if (!gameId) return;
            
            try {
                const response = await fetch(`/api/game/${gameId}/ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.status === 'OK') {
                    gameState = result.data.gameState;
                    updateGameDisplay();
                    soundManager.playSound('tilePlace');
                    showNotification(result.message || 'AI ãŒè¡Œå‹•ã—ã¾ã—ãŸ', 'success');
                } else {
                    showNotification(result.message || 'AIå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('AI error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
        function hidePassButton() {
            const passBtn = document.getElementById('passBtn');
            if (passBtn) {
                passBtn.style.display = 'none';
            }
        }

        // ãƒ¡ãƒ«ãƒ‰ãƒ‘ã‚¹é–¢æ•°
        function passMeld() {
            console.log('â© passMeld() called');
            
            if (!gameId || !isConnected) {
                showNotification('ã‚²ãƒ¼ãƒ ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('â© ãƒ‘ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'pass',
                playerId: `player_${myPlayerId}`,
                timestamp: Date.now()
            });
            
            // ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            hidePassButton();
            
            // ãƒ¡ãƒ«ãƒ‰é¸æŠUIã‚’éè¡¨ç¤º
            const existingUI = document.querySelector('.meld-selection-modal');
            if (existingUI) {
                existingUI.remove();
            }
            
            // ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤º
            hidePassButton();
            
            showNotification('ãƒ‘ã‚¹ã—ã¾ã—ãŸ', 'info');
        }

        // é³´ãé–¢æ•°
        // ãƒãƒ¼
        async function callChi() {
            console.log('ğŸ¯ callChi() called');
            console.log('ğŸ¯ gameState:', !!gameState);
            console.log('ğŸ¯ lastDiscardedTile:', lastDiscardedTile);
            console.log('ğŸ¯ lastDiscardedPlayer:', lastDiscardedPlayer);
            
            if (!gameState || !lastDiscardedTile) {
                console.log('ğŸ¯ Chi early return - missing gameState or lastDiscardedTile');
                showNotification('ãƒãƒ¼ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // æ‰‹ç‰Œã‹ã‚‰ãƒãƒ¼ã«ä½¿ç”¨ã™ã‚‹ç‰Œã‚’è¦‹ã¤ã‘ã‚‹
                const myTiles = gameState.players[0].hand.tiles;
                const targetRank = lastDiscardedTile.rank;
                
                // é€£ç¶šã™ã‚‹ç‰Œã®çµ„ã¿åˆã‚ã›ã‚’æ¢ã™
                let chiTiles = null;
                for (let i = 0; i < myTiles.length - 1; i++) {
                    for (let j = i + 1; j < myTiles.length; j++) {
                        const tile1 = myTiles[i];
                        const tile2 = myTiles[j];
                        
                        if (tile1.suit !== lastDiscardedTile.suit || tile2.suit !== lastDiscardedTile.suit) continue;
                        if (tile1.suit === 'ji') continue; // å­—ç‰Œã¯ãƒãƒ¼ä¸å¯
                        
                        const ranks = [tile1.rank, tile2.rank, targetRank].sort((a, b) => a - b);
                        if (ranks[0] + 1 === ranks[1] && ranks[1] + 1 === ranks[2]) {
                            chiTiles = [tile1, tile2];
                            break;
                        }
                    }
                    if (chiTiles) break;
                }
                
                if (!chiTiles) {
                    showNotification('ãƒãƒ¼ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const meld = {
                    id: `chi_${Date.now()}_player0`,
                    type: 'chi',
                    tiles: [...chiTiles, lastDiscardedTile],
                    fromPlayer: lastDiscardedPlayer,
                    isConcealed: false,
                    calledTile: lastDiscardedTile
                };

                console.log('ğŸ¯ ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
                socket.emit('playerAction', {
                    type: 'chi',
                    playerId: 'player_0',
                    meld: meld,
                    tile: lastDiscardedTile,
                    priority: 2,
                    timestamp: Date.now()
                });
                
                // ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                hidePassButton();
                
                soundManager.playSound('meld');
            } catch (error) {
                console.error('Chi error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒãƒ³
        async function callPon() {
            console.log('ğŸ¯ callPon() called');
            console.log('ğŸ¯ gameState:', !!gameState);
            console.log('ğŸ¯ lastDiscardedTile:', lastDiscardedTile);
            console.log('ğŸ¯ lastDiscardedPlayer:', lastDiscardedPlayer);
            
            if (!gameState || !lastDiscardedTile) {
                console.log('ğŸ¯ Pon early return - missing gameState or lastDiscardedTile');
                showNotification('ãƒãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // æ‰‹ç‰Œã‹ã‚‰åŒã˜ç‰Œã‚’2æšæ¢ã™
                const myTiles = gameState.players[0].hand.tiles;
                const matchingTiles = [];
                
                for (const tile of myTiles) {
                    if (isSameTile(tile, lastDiscardedTile)) {
                        matchingTiles.push(tile);
                        if (matchingTiles.length >= 2) break;
                    }
                }
                
                if (matchingTiles.length < 2) {
                    showNotification('ãƒãƒ³ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const meld = {
                    id: `pon_${Date.now()}_player0`,
                    type: 'pon',
                    tiles: [...matchingTiles, lastDiscardedTile],
                    fromPlayer: lastDiscardedPlayer,
                    isConcealed: false,
                    calledTile: lastDiscardedTile
                };

                console.log('ğŸ¯ ãƒãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
                console.log('ğŸ€„ [PON DEBUG] lastDiscardedTile:', lastDiscardedTile);
                console.log('ğŸ€„ [PON DEBUG] matchingTiles:', matchingTiles);
                console.log('ğŸ€„ [PON DEBUG] meld:', meld);
                console.log('ğŸ€„ [PON DEBUG] currentPlayer:', gameState.currentPlayer);
                console.log('ğŸ€„ [PON DEBUG] lastDiscardedPlayer:', lastDiscardedPlayer);
                
                socket.emit('playerAction', {
                    type: 'pon',
                    playerId: 'player_0',
                    meld: meld,
                    tile: lastDiscardedTile,
                    priority: 2,
                    timestamp: Date.now()
                });
                
                soundManager.playSound('meld');
            } catch (error) {
                console.error('Pon error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚«ãƒ³
        // ãƒãƒ¼å®Ÿè¡Œï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function callChi() {
            if (!gameState || !lastDiscardedTile) {
                showNotification('ãƒãƒ¼ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const myTiles = gameState.players[0].hand.tiles;
                const discardedTile = lastDiscardedTile;
                
                // ãƒãƒ¼å¯èƒ½ãªçµ„ã¿åˆã‚ã›ã‚’æ¤œç´¢
                const chiCombinations = findChiCombinations(myTiles, discardedTile);
                
                if (chiCombinations.length === 0) {
                    showNotification('ãƒãƒ¼ã§ãã‚‹çµ„ã¿åˆã‚ã›ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                if (chiCombinations.length === 1) {
                    // 1ã¤ã ã‘ã®å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
                    executeChiAction(chiCombinations[0], discardedTile);
                } else {
                    // è¤‡æ•°ã®å ´åˆã¯é¸æŠUIã‚’è¡¨ç¤º
                    showChiSelectionUI(chiCombinations, discardedTile);
                }
            } catch (error) {
                console.error('Chi error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ãƒãƒ³å®Ÿè¡Œï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function callPon() {
            if (!gameState || !lastDiscardedTile) {
                showNotification('ãƒãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const myTiles = gameState.players[0].hand.tiles;
                const discardedTile = lastDiscardedTile;
                
                // ãƒãƒ³å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                const ponTiles = findPonTiles(myTiles, discardedTile);
                
                if (ponTiles.length < 2) {
                    showNotification('ãƒãƒ³ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒãƒ³ã‚’å®Ÿè¡Œ
                executePonAction(ponTiles, discardedTile);
            } catch (error) {
                console.error('Pon error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ãƒ¡ãƒ«ãƒ‰é¸æŠã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµ±åˆé–¢æ•°
        async function callMeld() {
            if (!gameState || !lastDiscardedTile) {
                showNotification('ãƒ¡ãƒ«ãƒ‰ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            const myTiles = gameState.players[0].hand.tiles;
            const discardedTile = lastDiscardedTile;
            
            // å…¨ã¦ã®å¯èƒ½ãªãƒ¡ãƒ«ãƒ‰ã‚’æ¤œç´¢
            const chiCombinations = findChiCombinations(myTiles, discardedTile);
            const ponTiles = findPonTiles(myTiles, discardedTile);
            const kanTiles = findKanTiles(myTiles, discardedTile);
            
            const allOptions = [];
            
            // ãƒãƒ¼é¸æŠè‚¢ã‚’è¿½åŠ 
            chiCombinations.forEach((combo, index) => {
                allOptions.push({
                    type: 'chi',
                    displayName: `ãƒãƒ¼: ${combo.map(t => getTileDisplayName(t)).join('')}`,
                    tiles: combo,
                    discardedTile: discardedTile
                });
            });
            
            // ãƒãƒ³é¸æŠè‚¢ã‚’è¿½åŠ 
            if (ponTiles.length >= 2) {
                allOptions.push({
                    type: 'pon',
                    displayName: `ãƒãƒ³: ${getTileDisplayName(discardedTile)}${getTileDisplayName(discardedTile)}${getTileDisplayName(discardedTile)}`,
                    tiles: ponTiles,
                    discardedTile: discardedTile
                });
            }
            
            // ã‚«ãƒ³é¸æŠè‚¢ã‚’è¿½åŠ 
            if (kanTiles.length >= 3) {
                allOptions.push({
                    type: 'kan',
                    displayName: `ã‚«ãƒ³: ${getTileDisplayName(discardedTile)}${getTileDisplayName(discardedTile)}${getTileDisplayName(discardedTile)}${getTileDisplayName(discardedTile)}`,
                    tiles: kanTiles,
                    discardedTile: discardedTile
                });
            }
            
            if (allOptions.length === 0) {
                showNotification('ãƒ¡ãƒ«ãƒ‰ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            if (allOptions.length === 1) {
                // 1ã¤ã ã‘ã®å ´åˆã¯ç›´æ¥å®Ÿè¡Œ
                executeMeldAction(allOptions[0]);
            } else {
                // è¤‡æ•°ã®å ´åˆã¯é¸æŠUIã‚’è¡¨ç¤º
                showMeldSelectionUI(allOptions);
            }
        }
        
        // ãƒãƒ¼çµ„ã¿åˆã‚ã›æ¤œç´¢
        function findChiCombinations(tiles, discardedTile) {
            if (discardedTile.honor) return []; // å­—ç‰Œã¯ãƒãƒ¼ã§ããªã„
            
            const combinations = [];
            const rank = discardedTile.rank;
            const suit = discardedTile.suit;
            
            // ABCå‹ï¼ˆdiscardedTileãŒCï¼‰
            if (rank >= 3) {
                const needed = [
                    { suit: suit, rank: rank - 2 },
                    { suit: suit, rank: rank - 1 }
                ];
                const found = findTilesInHand(tiles, needed);
                if (found.length === 2) {
                    combinations.push([...found, discardedTile]);
                }
            }
            
            // ABCå‹ï¼ˆdiscardedTileãŒBï¼‰
            if (rank >= 2 && rank <= 8) {
                const needed = [
                    { suit: suit, rank: rank - 1 },
                    { suit: suit, rank: rank + 1 }
                ];
                const found = findTilesInHand(tiles, needed);
                if (found.length === 2) {
                    combinations.push([found[0], discardedTile, found[1]]);
                }
            }
            
            // ABCå‹ï¼ˆdiscardedTileãŒAï¼‰
            if (rank <= 7) {
                const needed = [
                    { suit: suit, rank: rank + 1 },
                    { suit: suit, rank: rank + 2 }
                ];
                const found = findTilesInHand(tiles, needed);
                if (found.length === 2) {
                    combinations.push([discardedTile, ...found]);
                }
            }
            
            return combinations;
        }
        
        // ãƒãƒ³å¯èƒ½ç‰Œæ¤œç´¢
        function findPonTiles(tiles, discardedTile) {
            const matchingTiles = [];
            for (const tile of tiles) {
                if (isSameTile(tile, discardedTile)) {
                    matchingTiles.push(tile);
                    if (matchingTiles.length >= 2) break;
                }
            }
            return matchingTiles;
        }
        
        // ã‚«ãƒ³å¯èƒ½ç‰Œæ¤œç´¢
        function findKanTiles(tiles, discardedTile) {
            const matchingTiles = [];
            for (const tile of tiles) {
                if (isSameTile(tile, discardedTile)) {
                    matchingTiles.push(tile);
                    if (matchingTiles.length >= 3) break;
                }
            }
            return matchingTiles;
        }
        
        // æ‰‹ç‰Œã‹ã‚‰å¿…è¦ãªç‰Œã‚’æ¤œç´¢
        function findTilesInHand(tiles, needed) {
            const found = [];
            const usedIndices = [];
            
            for (const needTile of needed) {
                let foundIndex = -1;
                for (let i = 0; i < tiles.length; i++) {
                    if (usedIndices.includes(i)) continue;
                    if (isSameTile(tiles[i], needTile)) {
                        foundIndex = i;
                        break;
                    }
                }
                if (foundIndex !== -1) {
                    found.push(tiles[foundIndex]);
                    usedIndices.push(foundIndex);
                } else {
                    return []; // å¿…è¦ãªç‰ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„
                }
            }
            
            return found;
        }
        
        // ãƒ¡ãƒ«ãƒ‰é¸æŠUIè¡¨ç¤º
        function showMeldSelectionUI(options) {
            // æ—¢å­˜ã®é¸æŠUIãŒã‚ã‚Œã°å‰Šé™¤
            const existingUI = document.querySelector('.meld-selection-modal');
            if (existingUI) {
                existingUI.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'meld-selection-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.95);
                border: 2px solid #ffc107;
                border-radius: 10px;
                padding: 20px;
                z-index: 10000;
                color: white;
                font-family: 'Noto Sans JP', sans-serif;
                max-width: 500px;
                width: 90%;
            `;
            
            const title = document.createElement('h3');
            title.textContent = 'ãƒ¡ãƒ«ãƒ‰é¸æŠ';
            title.style.cssText = `
                margin: 0 0 15px 0;
                color: #ffc107;
                text-align: center;
            `;
            
            const optionContainer = document.createElement('div');
            optionContainer.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 10px;
            `;
            
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option.displayName;
                button.style.cssText = `
                    padding: 12px 20px;
                    background: linear-gradient(45deg, #007bff, #0056b3);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: all 0.3s ease;
                `;
                
                button.addEventListener('mouseenter', () => {
                    button.style.background = 'linear-gradient(45deg, #0056b3, #003d82)';
                    button.style.transform = 'scale(1.05)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.background = 'linear-gradient(45deg, #007bff, #0056b3)';
                    button.style.transform = 'scale(1)';
                });
                
                button.addEventListener('click', () => {
                    modal.remove();
                    executeMeldAction(option);
                });
                
                optionContainer.appendChild(button);
            });
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelButton.style.cssText = `
                padding: 10px 20px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            `;
            
            cancelButton.addEventListener('click', () => {
                modal.remove();
            });
            
            modal.appendChild(title);
            modal.appendChild(optionContainer);
            modal.appendChild(cancelButton);
            document.body.appendChild(modal);
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    modal.remove();
                }
            }, 5000);
        }
        
        // ãƒ¡ãƒ«ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function executeMeldAction(option) {
            switch (option.type) {
                case 'chi':
                    executeChiAction(option.tiles, option.discardedTile);
                    break;
                case 'pon':
                    executePonAction(option.tiles, option.discardedTile);
                    break;
                case 'kan':
                    executeKanAction(option.tiles, option.discardedTile);
                    break;
                default:
                    console.error('Unknown meld type:', option.type);
            }
        }
        
        // ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function executeChiAction(tiles, discardedTile) {
            const meld = {
                id: `chi_${Date.now()}_player0`,
                type: 'chi',
                tiles: tiles,
                fromPlayer: lastDiscardedPlayer,
                isConcealed: false,
                calledTile: discardedTile
            };
            
            console.log('ğŸ¯ ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'chi',
                playerId: 'player_0',
                meld: meld,
                tile: discardedTile,
                priority: 1,
                timestamp: Date.now()
            });
            
            soundManager.playSound('meld');
        }
        
        // ãƒãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function executePonAction(tiles, discardedTile) {
            const meld = {
                id: `pon_${Date.now()}_player0`,
                type: 'pon',
                tiles: [...tiles, discardedTile],
                fromPlayer: lastDiscardedPlayer,
                isConcealed: false,
                calledTile: discardedTile
            };
            
            console.log('ğŸ¯ ãƒãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'pon',
                playerId: 'player_0',
                meld: meld,
                tile: discardedTile,
                priority: 2,
                timestamp: Date.now()
            });
            
            soundManager.playSound('meld');
        }
        
        // ã‚«ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function executeKanAction(tiles, discardedTile) {
            const meld = {
                id: `kan_${Date.now()}_player0`,
                type: 'kan',
                tiles: [...tiles, discardedTile],
                fromPlayer: lastDiscardedPlayer,
                isConcealed: false,
                calledTile: discardedTile
            };
            
            console.log('ğŸ¯ ã‚«ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'kan',
                playerId: 'player_0',
                meld: meld,
                tile: discardedTile,
                priority: 3,
                timestamp: Date.now()
            });
            
            soundManager.playSound('meld');
        }
        
        // ç‰Œã®è¡¨ç¤ºåã‚’å–å¾—
        function getTileDisplayName(tile) {
            // UnicodeãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯å„ªå…ˆ
            if (tile.unicode) {
                return tile.unicode;
            }
            
            if (tile.honor) {
                // å­—ç‰Œã®Unicode
                const honorUnicodes = {
                    'east': 'ğŸ€€', 'south': 'ğŸ€', 'west': 'ğŸ€‚', 'north': 'ğŸ€ƒ',
                    'white': 'ğŸ€†', 'green': 'ğŸ€…', 'red': 'ğŸ€„'
                };
                return honorUnicodes[tile.honor] || tile.honor;
            } else {
                // æ•°ç‰Œã®Unicode
                const suitUnicodes = {
                    man: ['ğŸ€‡', 'ğŸ€ˆ', 'ğŸ€‰', 'ğŸ€Š', 'ğŸ€‹', 'ğŸ€Œ', 'ğŸ€', 'ğŸ€', 'ğŸ€'],
                    pin: ['ğŸ€™', 'ğŸ€š', 'ğŸ€›', 'ğŸ€œ', 'ğŸ€', 'ğŸ€', 'ğŸ€Ÿ', 'ğŸ€ ', 'ğŸ€¡'],
                    sou: ['ğŸ€', 'ğŸ€‘', 'ğŸ€’', 'ğŸ€“', 'ğŸ€”', 'ğŸ€•', 'ğŸ€–', 'ğŸ€—', 'ğŸ€˜']
                };
                
                if (suitUnicodes[tile.suit] && tile.rank >= 1 && tile.rank <= 9) {
                    return suitUnicodes[tile.suit][tile.rank - 1];
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const suitNames = { 'man': 'm', 'pin': 'p', 'sou': 's' };
                return `${tile.rank}${suitNames[tile.suit] || tile.suit}`;
            }
        }
        
        // ç‰ŒãŒåŒã˜ã‹ãƒã‚§ãƒƒã‚¯
        function isSameTile(tile1, tile2) {
            if (tile1.honor && tile2.honor) {
                return tile1.honor === tile2.honor;
            } else if (!tile1.honor && !tile2.honor) {
                return tile1.suit === tile2.suit && tile1.rank === tile2.rank;
            }
            return false;
        }

        async function callKan() {
            if (!gameState) {
                showNotification('ã‚«ãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const myTiles = gameState.players[0].hand.tiles;
                let kanTiles = [];
                let kanType = null;
                
                // æ˜æ§“ã®å ´åˆï¼ˆç›¸æ‰‹ã®æ¨ç‰Œ+æ‰‹ç‰Œ3æšï¼‰
                if (lastDiscardedTile) {
                    const matchingTiles = [];
                    for (const tile of myTiles) {
                        if (isSameTile(tile, lastDiscardedTile)) {
                            matchingTiles.push(tile);
                            if (matchingTiles.length >= 3) break;
                        }
                    }
                    
                    if (matchingTiles.length >= 3) {
                        kanTiles = [...matchingTiles, lastDiscardedTile];
                        kanType = 'kan';
                    }
                }
                
                // åŠ æ§“ã®å ´åˆï¼ˆæ—¢å­˜ã®ãƒãƒ³ã«æ‰‹ç‰Œã®åŒã˜ç‰Œã‚’è¿½åŠ ï¼‰
                if (kanTiles.length === 0) {
                    const myMelds = gameState.players[0].hand.melds || [];
                    for (const meld of myMelds) {
                        if (meld.type === 'pon') {
                            const meldTile = meld.tiles[0]; // ãƒãƒ³ã®ç‰Œ
                            for (const handTile of myTiles) {
                                if (isSameTile(handTile, meldTile)) {
                                    kanTiles = [...meld.tiles, handTile];
                                    kanType = 'kakan'; // åŠ æ§“
                                    console.log('ğŸ” åŠ æ§“å¯èƒ½:', kanTiles);
                                    break;
                                }
                            }
                            if (kanTiles.length > 0) break;
                        }
                    }
                }

                // æš—æ§“ã®å ´åˆï¼ˆæ‰‹ç‰Œ4æšï¼‰
                if (kanTiles.length === 0) {
                    const tileCounts = {};
                    for (const tile of myTiles) {
                        const key = `${tile.suit}_${tile.rank}_${tile.honor}`;
                        if (!tileCounts[key]) tileCounts[key] = [];
                        tileCounts[key].push(tile);
                    }
                    
                    for (const [key, tiles] of Object.entries(tileCounts)) {
                        if (tiles.length >= 4) {
                            kanTiles = tiles.slice(0, 4);
                            kanType = 'ankan';
                            break;
                        }
                    }
                }
                
                if (kanTiles.length === 0) {
                    showNotification('ã‚«ãƒ³ã§ãã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                const meld = {
                    id: `kan_${Date.now()}_player0`,
                    type: kanType,
                    tiles: kanTiles,
                    fromPlayer: kanType === 'ankan' ? 0 : lastDiscardedPlayer,
                    isConcealed: kanType === 'ankan',
                    calledTile: kanType === 'ankan' ? null : lastDiscardedTile
                };

                console.log('ğŸ¯ ã‚«ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
                socket.emit('playerAction', {
                    type: kanType,
                    playerId: 'player_0',
                    meld: meld,
                    tile: kanType === 'ankan' ? kanTiles[0] : lastDiscardedTile,
                    priority: 3,
                    timestamp: Date.now()
                });
                
                soundManager.playSound('meld');
            } catch (error) {
                console.error('Kan error:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ„ãƒ¢å’Œäº†
        function callTsumo() {
            if (!gameState || gameState.currentPlayer !== 0) {
                showNotification('ãƒ„ãƒ¢ã§ãã¾ã›ã‚“ï¼ˆã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            console.log('ğŸ¯ ãƒ„ãƒ¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'tsumo',
                playerId: 'player_0',
                priority: 5,
                timestamp: Date.now()
            });
            
            soundManager.playSound('tilePlace');
        }

        // ãƒ­ãƒ³å’Œäº†
        function callRon() {
            if (!gameState || gameState.currentPlayer === 0) {
                showNotification('ãƒ­ãƒ³ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            console.log('ğŸ¯ ãƒ­ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡');
            socket.emit('playerAction', {
                type: 'ron',
                playerId: 'player_0',
                priority: 5,
                timestamp: Date.now()
            });
            
            soundManager.playSound('tilePlace');
        }

        // ãƒªãƒ¼ãƒ
        function callRiichi() {
            if (!gameState || gameState.currentPlayer !== 0) {
                showNotification('ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“ï¼ˆã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            if (!canCallRiichi()) {
                showNotification('ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“ï¼ˆæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ï¼‰', 'error');
                return;
            }
            
            // ãƒªãƒ¼ãƒæ£’æ¼”å‡º
            showRiichiStick();
            
            performAction('riichi', {}, (result) => {
                if (result.success) {
                    showNotification('ãƒªãƒ¼ãƒï¼', 'success');
                    requestGameState();
                } else {
                    showNotification(`ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“: ${result.error}`, 'error');
                    hideRiichiStick(); // å¤±æ•—æ™‚ã¯æ£’ã‚’éš ã™
                }
            });
        }
        
        // ãƒªãƒ¼ãƒæ£’æ¼”å‡º
        function showRiichiStick() {
            const riichiStick = document.getElementById('riichiStick');
            if (riichiStick) {
                riichiStick.style.display = 'block';
                riichiStick.style.animation = 'riichiPlace 0.5s ease-out';
                riichiStick.textContent = '1000ç‚¹æ£’';
            }
        }
        
        function hideRiichiStick() {
            const riichiStick = document.getElementById('riichiStick');
            if (riichiStick) {
                riichiStick.style.display = 'none';
            }
        }
        
        // å¹ãå‡ºã—è¡¨ç¤ºæ©Ÿèƒ½
        function showSpeechBubble(playerIndex, message, duration = 2000) {
            const bubble = document.getElementById(`speechBubble${playerIndex}`);
            if (bubble) {
                bubble.textContent = message;
                bubble.style.display = 'block';
                bubble.style.animation = 'speechAppear 0.3s ease-out';
                
                // ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•éè¡¨ç¤º
                setTimeout(() => {
                    bubble.style.display = 'none';
                }, duration);
            }
        }
        
        // ãƒ¡ãƒ«ãƒ‰å®£è¨€ç”¨ã®å¹ãå‡ºã—
        function showMeldAnnouncement(playerIndex, meldType, tiles) {
            let message = '';
            switch (meldType) {
                case 'chi':
                    message = 'ãƒãƒ¼ï¼';
                    break;
                case 'pon':
                    message = 'ãƒãƒ³ï¼';
                    break;
                case 'kan':
                    message = 'ã‚«ãƒ³ï¼';
                    break;
                case 'riichi':
                    message = 'ãƒªãƒ¼ãƒï¼';
                    break;
                case 'tsumo':
                    message = 'ãƒ„ãƒ¢ï¼';
                    break;
                case 'ron':
                    message = 'ãƒ­ãƒ³ï¼';
                    break;
                default:
                    message = meldType;
            }
            showSpeechBubble(playerIndex, message, 3000);
        }
        
        // ãƒ¡ãƒ«ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½
        function updateMeldDisplay() {
            if (!gameState || !gameState.players) return;
            
            gameState.players.forEach((player, playerIndex) => {
                const meldArea = document.getElementById(`melds${playerIndex}`);
                if (!meldArea) return;
                
                meldArea.innerHTML = '';
                
                if (player.hand && player.hand.melds) {
                    player.hand.melds.forEach((meld, meldIndex) => {
                        const meldGroup = createMeldDisplay(meld);
                        meldArea.appendChild(meldGroup);
                    });
                }
            });
        }
        
        function createMeldDisplay(meld) {
            const meldGroup = document.createElement('div');
            meldGroup.className = `meld-group ${meld.type}`;
            
            // ãƒ¡ãƒ«ãƒ‰ãƒ©ãƒ™ãƒ«
            const label = document.createElement('div');
            label.className = 'meld-label';
            label.textContent = meld.type.toUpperCase();
            meldGroup.appendChild(label);
            
            // ãƒ¡ãƒ«ãƒ‰ã®ç‰Œè¡¨ç¤º
            meld.tiles.forEach((tile, tileIndex) => {
                const tileElement = document.createElement('div');
                tileElement.className = 'meld-tile';
                
                if (tile.isRed) tileElement.classList.add('red');
                
                // é³´ã„ãŸç‰Œã¯æ¨ªå‘ãï¼ˆãƒãƒ¼ãƒ»ãƒãƒ³ã®å ´åˆã€æœ€å¾Œã®ç‰Œï¼‰
                if (meld.type !== 'kan' && tileIndex === meld.tiles.length - 1) {
                    tileElement.classList.add('called');
                }
                
                tileElement.textContent = getTileDisplayName(tile);
                meldGroup.appendChild(tileElement);
            });
            
            return meldGroup;
        }

        function toggleDebug() {
            debugMode = !debugMode;
            showNotification(debugMode ? 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ON' : 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰OFF', 'info');
        }

        // CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        let cpuAutoMode = false;
        function toggleCpuAuto() {
            if (!gameId) {
                showNotification('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            cpuAutoMode = !cpuAutoMode;
            const btn = document.getElementById('cpuAutoBtn');
            
            if (cpuAutoMode) {
                btn.textContent = 'CPUè‡ªå‹•åœæ­¢';
                btn.className = 'btn btn-danger';
                showNotification('ğŸ¤– CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«CPUè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/cpu-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: true,
                        speed: 400
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        console.log('âœ… CPUè‡ªå‹•å¯¾æˆ¦é–‹å§‹:', data.message);
                        // å®šæœŸçš„ã«ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
                        startCpuAutoMonitoring();
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('âŒ CPUè‡ªå‹•å¯¾æˆ¦é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('CPUè‡ªå‹•å¯¾æˆ¦é–‹å§‹å¤±æ•—: ' + error.message, 'error');
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    cpuAutoMode = false;
                    btn.textContent = 'CPUè‡ªå‹•é–‹å§‹';
                    btn.className = 'btn btn-success';
                });
            } else {
                btn.textContent = 'CPUè‡ªå‹•é–‹å§‹';
                btn.className = 'btn btn-success';
                showNotification('ğŸ›‘ CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰åœæ­¢', 'warning');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«CPUè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰åœæ­¢ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/cpu-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: false
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ›‘ CPUè‡ªå‹•å¯¾æˆ¦åœæ­¢:', data.message);
                    stopCpuAutoMonitoring();
                })
                .catch(error => {
                    console.error('âŒ CPUè‡ªå‹•å¯¾æˆ¦åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                });
            }
        }

        // CPUè‡ªå‹•å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ç›£è¦–
        let cpuAutoInterval = null;
        function startCpuAutoMonitoring() {
            if (cpuAutoInterval) clearInterval(cpuAutoInterval);
            
            cpuAutoInterval = setInterval(() => {
                if (cpuAutoMode && gameId) {
                    requestGameState();
                }
            }, 2000); // 2ç§’ã”ã¨ã«çŠ¶æ…‹ç¢ºèª
        }

        function stopCpuAutoMonitoring() {
            if (cpuAutoInterval) {
                clearInterval(cpuAutoInterval);
                cpuAutoInterval = null;
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        let playerAutoMode = false;
        function togglePlayerAuto() {
            if (!gameId) {
                showNotification('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            playerAutoMode = !playerAutoMode;
            const btn = document.getElementById('playerAutoBtn');
            
            if (playerAutoMode) {
                btn.textContent = 'ã‚ªãƒ¼ãƒˆåˆ‡OFF';
                btn.className = 'btn btn-primary';
                showNotification('ğŸ¯ ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/player-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        console.log('âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šé–‹å§‹:', data.message);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šé–‹å§‹å¤±æ•—: ' + error.message, 'error');
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    playerAutoMode = false;
                    btn.textContent = 'ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Š';
                    btn.className = 'btn btn-secondary';
                });
            } else {
                btn.textContent = 'ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Š';
                btn.className = 'btn btn-secondary';
                showNotification('ğŸ›‘ ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šãƒ¢ãƒ¼ãƒ‰åœæ­¢', 'warning');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰åœæ­¢ã‚’é€šçŸ¥
                fetch(`/api/game/${gameId}/player-auto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: false
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ›‘ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šåœæ­¢:', data.message);
                })
                .catch(error => {
                    console.error('âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ¼ãƒˆãƒ„ãƒ¢åˆ‡ã‚Šåœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                });
            }
        }

        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°ç¾¤
        function forceCPUTurn() {
            if (!gameState) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            const currentPlayer = gameState.players[gameState.currentPlayer];
            if (currentPlayer && currentPlayer.name.includes('CPU')) {
                executeAI();
                showNotification(`${currentPlayer.name}ã®ã‚¿ãƒ¼ãƒ³ã‚’å¼·åˆ¶å®Ÿè¡Œ`, 'info');
            } else {
                showNotification('ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯CPUã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
        }

        function showGameLog() {
            if (!gameState || !gameState.gameLog) {
                console.log('ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ­ã‚°: ãªã—');
                showNotification('ã‚²ãƒ¼ãƒ ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            console.log('ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ­ã‚°:', gameState.gameLog);
            console.log('ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ­ã‚°è©³ç´°:');
            gameState.gameLog.forEach((log, index) => {
                console.log(`  ${index + 1}. [${log.type}] ${log.description}`, log);
            });
            showNotification(`ã‚²ãƒ¼ãƒ ãƒ­ã‚°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º (${gameState.gameLog.length}ä»¶)`, 'info');
        }

        function toggleDebugMode() {
            debugMode = !debugMode;
            showNotification(debugMode ? 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ON' : 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰OFF', 'info');
        }

        function skipToNextPlayer() {
            if (!gameState) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            const nextPlayer = (gameState.currentPlayer + 1) % 4;
            console.log(`â­ï¸ æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¼·åˆ¶ç§»è¡Œ: ${gameState.currentPlayer} â†’ ${nextPlayer}`);
            showNotification(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${nextPlayer}ã®ã‚¿ãƒ¼ãƒ³ã«ç§»è¡Œ`, 'info');
        }

        function showDiscards() {
            if (!gameState) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            console.log('ğŸ—‚ï¸ æ¨ã¦ç‰Œæƒ…å ±:');
            gameState.players.forEach((player, index) => {
                console.log(`  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${index} (${player.name}): `, player.hand.discards);
            });
            if (gameState.gameLog) {
                const discardLogs = gameState.gameLog.filter(log => log.type === 'discard');
                console.log(`ğŸ—‚ï¸ ã‚²ãƒ¼ãƒ ãƒ­ã‚°å†…ã®æ¨ã¦ç‰Œ: ${discardLogs.length}ä»¶`, discardLogs);
            }
            showNotification('æ¨ã¦ç‰Œæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º', 'info');
        }
        
        // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤º
        async function showErrorLogs() {
            try {
                const response = await fetch('/api/logs/error');
                const result = await response.json();
                
                if (result.status === 'OK') {
                    console.log('ğŸ“‹ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° (æœ€æ–°50è¡Œ):');
                    console.log('=' .repeat(60));
                    console.log(result.logs || 'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“');
                    console.log('=' .repeat(60));
                    showNotification('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã—ã¾ã—ãŸ', 'info');
                } else {
                    console.error('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å–å¾—å¤±æ•—:', result.message);
                    showNotification('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function clearConsole() {
            console.clear();
            showNotification('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // æ¨ã¦ç‰Œåº§æ¨™ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        function testDiscardCoordinates() {
            console.log('ğŸ¯ æ¨ã¦ç‰Œåº§æ¨™ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            if (!gameState || !gameState.players) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒç„¡åŠ¹ã§ã™', 'error');
                return;
            }
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ã®åº§æ¨™ã‚’ç¢ºèª
            for (let i = 0; i < 4; i++) {
                const discardElement = document.getElementById(`discards${i}`);
                if (discardElement) {
                    const rect = discardElement.getBoundingClientRect();
                    const style = window.getComputedStyle(discardElement);
                    
                    console.log(`ğŸ“ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i} æ¨ã¦ç‰Œã‚¨ãƒªã‚¢åº§æ¨™:`);
                    console.log(`  - ä½ç½®: x=${rect.left.toFixed(1)}, y=${rect.top.toFixed(1)}`);
                    console.log(`  - ã‚µã‚¤ã‚º: width=${rect.width.toFixed(1)}, height=${rect.height.toFixed(1)}`);
                    console.log(`  - CSS: position=${style.position}, transform=${style.transform}`);
                    console.log(`  - æ¨ã¦ç‰Œæ•°: ${gameState.players[i].hand.discards.length}æš`);
                    
                    // æ¨ã¦ç‰Œã®é…ç½®æ–¹å‘ã‚’ãƒ†ã‚¹ãƒˆ
                    const discards = discardElement.children;
                    if (discards.length > 0) {
                        console.log(`  - æœ€åˆã®ç‰Œä½ç½®: x=${discards[0].getBoundingClientRect().left.toFixed(1)}`);
                        if (discards.length > 1) {
                            console.log(`  - æœ€å¾Œã®ç‰Œä½ç½®: x=${discards[discards.length-1].getBoundingClientRect().left.toFixed(1)}`);
                            console.log(`  - é…ç½®æ–¹å‘: ${discards[0].getBoundingClientRect().left < discards[discards.length-1].getBoundingClientRect().left ? 'å·¦â†’å³' : 'å³â†’å·¦'}`);
                        }
                    }
                    
                    // è¦–è¦šçš„ãƒ†ã‚¹ãƒˆç”¨ã®ä¸€æ™‚çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    discardElement.style.border = '3px solid red';
                    setTimeout(() => {
                        discardElement.style.border = '';
                    }, 2000);
                }
            }
            
            // æ¨ã¦ç‰Œã®å‘ãã¨é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
            testDiscardRotations();
            showNotification('æ¨ã¦ç‰Œåº§æ¨™ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ', 'info');
        }
        
        // æ¨ã¦ç‰Œã®å›è»¢ã¨é…ç½®ãƒ†ã‚¹ãƒˆ
        function testDiscardRotations() {
            console.log('ğŸ”„ æ¨ã¦ç‰Œå›è»¢ãƒ†ã‚¹ãƒˆ:');
            
            for (let i = 0; i < 4; i++) {
                const playerName = ['ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', 'CPUå—', 'CPUè¥¿', 'CPUåŒ—'][i];
                const expectedRotation = [0, 0, 180, 0][i]; // æœŸå¾…ã•ã‚Œã‚‹å›è»¢è§’åº¦
                const expectedDirection = ['å·¦â†’å³', 'ä¸Šâ†’ä¸‹', 'å³â†’å·¦', 'ä¸‹â†’ä¸Š'][i]; // æœŸå¾…ã•ã‚Œã‚‹é…ç½®æ–¹å‘
                
                console.log(`  ${playerName} (ä½ç½®${i}):`);
                console.log(`    - æœŸå¾…å›è»¢: ${expectedRotation}åº¦`);
                console.log(`    - æœŸå¾…é…ç½®: ${expectedDirection}`);
                
                const discardElement = document.getElementById(`discards${i}`);
                if (discardElement && discardElement.children.length > 0) {
                    const firstTile = discardElement.children[0];
                    const style = window.getComputedStyle(firstTile);
                    console.log(`    - å®Ÿéš›CSS: transform=${style.transform}`);
                }
            }
        }
        
        // æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãƒ†ã‚¹ãƒˆ
        function addDiscardClickTest() {
            for (let i = 0; i < 4; i++) {
                const discardElement = document.getElementById(`discards${i}`);
                if (discardElement) {
                    discardElement.addEventListener('click', function() {
                        console.log(`ğŸ–±ï¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ`);
                        showNotification(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®æ¨ã¦ç‰Œã‚¨ãƒªã‚¢`, 'info');
                        
                        // è©³ç´°ãªæ¨ã¦ç‰Œæƒ…å ±ã‚’è¡¨ç¤º
                        showDiscardDetails(i);
                    });
                }
            }
        }
        
        // æŒ‡å®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ã¦ç‰Œè©³ç´°è¡¨ç¤º
        function showDiscardDetails(playerIndex) {
            if (!gameState || !gameState.players[playerIndex]) return;
            
            const player = gameState.players[playerIndex];
            const discards = player.hand.discards;
            
            console.log(`ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${playerIndex} æ¨ã¦ç‰Œè©³ç´°:`);
            console.log(`  - ç·æ•°: ${discards.length}æš`);
            
            discards.forEach((tile, index) => {
                console.log(`  ${index + 1}. ${tile.displayName || tile.unicode} (ID: ${tile.id})`);
            });
            
            if (gameState.lastDiscard && gameState.lastDiscardPlayer === playerIndex) {
                console.log(`  â­ æœ€æ–°æ¨ã¦ç‰Œ: ${gameState.lastDiscard.displayName || gameState.lastDiscard.unicode}`);
            }
        }
        
        // æ¨ã¦ç‰Œæ›´æ–°ã®ç›£è¦–ï¼ˆupdateGameDisplayã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
        function trackDiscardUpdates() {
            if (!gameState) return;
            
            const currentDiscardCounts = gameState.players.map(p => p.hand.discards.length);
            
            // å‰å›ã¨æ¯”è¼ƒã—ã¦å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ
            if (window.lastDiscardCounts) {
                for (let i = 0; i < 4; i++) {
                    if (currentDiscardCounts[i] !== window.lastDiscardCounts[i]) {
                        const change = currentDiscardCounts[i] - window.lastDiscardCounts[i];
                        // console.log(`ğŸ”„ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i} æ¨ã¦ç‰Œå¤‰æ›´: ${window.lastDiscardCounts[i]}æš â†’ ${currentDiscardCounts[i]}æš (${change > 0 ? '+' : ''}${change})`);
                        
                        if (change > 0 && gameState.players[i].hand.discards.length > 0) {
                            const latestDiscard = gameState.players[i].hand.discards[gameState.players[i].hand.discards.length - 1];
                            // console.log(`  æ–°ã—ã„æ¨ã¦ç‰Œ: ${latestDiscard.displayName || latestDiscard.unicode}`);
                        }
                    }
                }
            }
            
            window.lastDiscardCounts = [...currentDiscardCounts];
        }

        // ç‚¹æ•°è¨ˆç®—ãƒ†ã‚¹ãƒˆ
        function testScoreCalculation() {
            console.log('ğŸ’° [ç‚¹æ•°è¨ˆç®—ãƒ†ã‚¹ãƒˆ] é–‹å§‹');
            
            const testCases = [
                {
                    name: 'ã‚¿ãƒ³ãƒ¤ã‚ªã®ã¿ï¼ˆå­ãƒ„ãƒ¢ï¼‰',
                    yaku: [{ name: 'ã‚¿ãƒ³ãƒ¤ã‚ª', han: 1, isYakuman: false }],
                    fu: 30,
                    isParent: false,
                    isTsumo: true
                },
                {
                    name: 'ãƒªãƒ¼ãƒãƒ»ã‚¿ãƒ³ãƒ¤ã‚ªï¼ˆå­ãƒ­ãƒ³ï¼‰',
                    yaku: [
                        { name: 'ãƒªãƒ¼ãƒ', han: 1, isYakuman: false },
                        { name: 'ã‚¿ãƒ³ãƒ¤ã‚ª', han: 1, isYakuman: false }
                    ],
                    fu: 30,
                    isParent: false,
                    isTsumo: false
                },
                {
                    name: 'æº€è²«ï¼ˆå­ãƒ„ãƒ¢ï¼‰',
                    yaku: [
                        { name: 'ãƒªãƒ¼ãƒ', han: 1, isYakuman: false },
                        { name: 'ã‚¿ãƒ³ãƒ¤ã‚ª', han: 1, isYakuman: false },
                        { name: 'ãƒ‰ãƒ©', han: 3, isYakuman: false }
                    ],
                    fu: 30,
                    isParent: false,
                    isTsumo: true
                },
                {
                    name: 'è¦ªæº€è²«ï¼ˆãƒ„ãƒ¢ï¼‰',
                    yaku: [
                        { name: 'ãƒªãƒ¼ãƒ', han: 1, isYakuman: false },
                        { name: 'ãƒ‰ãƒ©', han: 4, isYakuman: false }
                    ],
                    fu: 30,
                    isParent: true,
                    isTsumo: true
                }
            ];
            
            testCases.forEach(testCase => {
                console.log(`\nğŸ’° ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: ${testCase.name}`);
                console.log(`   å½¹: ${testCase.yaku.map(y => `${y.name}(${y.han}ç¿»)`).join(', ')}`);
                console.log(`   ${testCase.fu}ç¬¦ ${testCase.isParent ? 'è¦ª' : 'å­'} ${testCase.isTsumo ? 'ãƒ„ãƒ¢' : 'ãƒ­ãƒ³'}`);
                
                const totalHan = testCase.yaku.reduce((sum, y) => sum + y.han, 0);
                console.log(`   åˆè¨ˆç¿»æ•°: ${totalHan}ç¿»`);
                
                const expectedScore = calculateExpectedScore(totalHan, testCase.fu, testCase.isParent, testCase.isTsumo);
                console.log(`   æœŸå¾…ç‚¹æ•°: ${expectedScore}ç‚¹`);
            });
            
            showNotification('ç‚¹æ•°è¨ˆç®—ãƒ†ã‚¹ãƒˆã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„', 'info');
        }
        
        // æœŸå¾…ç‚¹æ•°è¨ˆç®—ï¼ˆæ¤œè¨¼ç”¨ï¼‰
        function calculateExpectedScore(han, fu, isParent, isTsumo) {
            let baseScore;
            
            // æº€è²«ä»¥ä¸Šåˆ¤å®š
            if (han >= 5 || (han >= 4 && fu >= 40) || (han >= 3 && fu >= 70)) {
                baseScore = 2000; // æº€è²«
            } else if (han >= 6) {
                baseScore = 3000; // è·³æº€
            } else if (han >= 8) {
                baseScore = 4000; // å€æº€
            } else if (han >= 11) {
                baseScore = 6000; // ä¸‰å€æº€
            } else if (han >= 13) {
                baseScore = 8000; // æ•°ãˆå½¹æº€
            } else {
                baseScore = fu * Math.pow(2, han + 2);
            }
            
            // è¦ªè£œæ­£
            if (isParent) {
                baseScore = Math.floor(baseScore * 1.5);
            }
            
            // ãƒ„ãƒ¢/ãƒ­ãƒ³è£œæ­£ï¼ˆå¾—ç‚¹è¨ˆç®—ï¼‰
            if (isTsumo) {
                if (isParent) {
                    // è¦ªãƒ„ãƒ¢ï¼šå­ãŒå…¨é¡ã®1/3ãšã¤ â†’ 3äººåˆ†åˆè¨ˆ
                    return Math.ceil(baseScore / 3 / 100) * 300;
                } else {
                    // å­ãƒ„ãƒ¢ï¼šè¦ªãŒåŠé¡ã€ä»–ã®å­ãŒ1/4ãšã¤ â†’ åˆè¨ˆ
                    const parentPay = Math.ceil(baseScore / 2 / 100) * 100;
                    const childPay = Math.ceil(baseScore / 4 / 100) * 200;
                    return parentPay + childPay;
                }
            } else {
                // ãƒ­ãƒ³ï¼šæ”¾éŠƒè€…ãŒå…¨é¡æ”¯æ‰•ã„
                return Math.ceil(baseScore / 100) * 100;
            }
        }

        // å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        function testYakuAnalysis() {
            console.log('ğŸ° å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            if (!gameState || !gameState.players) {
                showNotification('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒç„¡åŠ¹ã§ã™', 'error');
                return;
            }
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç‰Œã‚’åˆ†æ
            gameState.players.forEach((player, index) => {
                console.log(`ğŸ° ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${index} (${player.name}) æ‰‹ç‰Œåˆ†æ:`);
                console.log(`  æ‰‹ç‰Œ: ${player.hand.tiles.length}æš`);
                console.log(`  ãƒ¡ãƒ«ãƒ‰: ${player.hand.melds.length}å€‹`);
                console.log(`  ãƒªãƒ¼ãƒ: ${player.hand.riichi ? 'Yes' : 'No'}`);
                console.log(`  æ¨ã¦ç‰Œ: ${player.hand.discards.length}æš`);
                
                // æ‰‹ç‰Œã®å†…å®¹ã‚’è¡¨ç¤º
                if (index === 0) { // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®æ‰‹ç‰Œã¯è¦‹ãˆã‚‹
                    console.log(`  æ‰‹ç‰Œè©³ç´°: ${player.hand.tiles.map(t => t.displayName || t.unicode).join(' ')}`);
                    
                    // å’Œäº†å½¢ã‹ãƒã‚§ãƒƒã‚¯
                    testWinningHand(player.hand.tiles, player.hand.melds, index);
                    
                    // ã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°ã‚’ãƒ†ã‚¹ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ç°¡æ˜“è¨ˆç®—ï¼‰
                    const shanten = calculateSimpleShanten(player.hand.tiles, player.hand.melds);
                    console.log(`  æ¨å®šã‚·ãƒ£ãƒ³ãƒ†ãƒ³æ•°: ${shanten}`);
                    
                    // å¾…ã¡ç‰Œã®å¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆ
                    if (shanten <= 1) {
                        testWaitingTiles(player.hand.tiles);
                    }
                } else {
                    console.log(`  æ‰‹ç‰Œè©³ç´°: [éè¡¨ç¤º] ${player.hand.tiles.length}æš`);
                }
                
                // ãƒ¡ãƒ«ãƒ‰ã®è©³ç´°
                if (player.hand.melds.length > 0) {
                    console.log(`  ãƒ¡ãƒ«ãƒ‰è©³ç´°:`);
                    player.hand.melds.forEach((meld, meldIndex) => {
                        console.log(`    ${meldIndex + 1}. ${meld.type}: ${meld.tiles.map(t => t.displayName || t.unicode).join(' ')}`);
                    });
                }
                
                console.log(''); // ç©ºè¡Œ
            });
            
            showNotification('å½¹åˆ¤å®šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸ', 'info');
        }
        
        // å’Œäº†å½¢ãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function testWinningHand(tiles, melds, playerIndex) {
            if (tiles.length + melds.length * 3 !== 14 && tiles.length + melds.length * 3 !== 13) {
                console.log(`  âš ï¸ ç‰Œæ•°ç•°å¸¸: ${tiles.length + melds.length * 3}æš`);
                return;
            }
            
            // ä¸ƒå¯¾å­ãƒã‚§ãƒƒã‚¯
            const isChiitoi = checkChiitoi(tiles);
            if (isChiitoi && tiles.length === 14) {
                console.log(`  ğŸ‰ ä¸ƒå¯¾å­å½¢: å’Œäº†å¯èƒ½`);
                simulateYaku(tiles, melds, playerIndex, 'ä¸ƒå¯¾å­');
                return;
            }
            
            // å›½å£«ç„¡åŒãƒã‚§ãƒƒã‚¯
            const isKokushi = checkKokushi(tiles);
            if (isKokushi && tiles.length === 14) {
                console.log(`  ğŸ‰ å›½å£«ç„¡åŒå½¢: å½¹æº€ï¼`);
                simulateYaku(tiles, melds, playerIndex, 'å›½å£«ç„¡åŒ');
                return;
            }
            
            // æ¨™æº–å½¢ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ï¼‰
            const isStandard = checkStandardForm(tiles, melds);
            if (isStandard) {
                console.log(`  ğŸ‰ æ¨™æº–å½¢: å’Œäº†å¯èƒ½`);
                simulateYaku(tiles, melds, playerIndex, 'æ¨™æº–å½¢');
                return;
            }
            
            console.log(`  âŒ å’Œäº†å½¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
        }
        
        // å½¹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function simulateYaku(tiles, melds, playerIndex, formType) {
            console.log(`  ğŸ“Š ${formType}ã®å½¹åˆ†æ:`);
            
            // æ‰‹ç‰Œã‚’å¼·åŒ–ç‰ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
            const handForYaku = convertTilesToAdvancedFormat(tiles);
            const meldsForYaku = convertMeldsToAdvancedFormat(melds);
            
            // å¼·åŒ–ç‰ˆå½¹è¨ˆç®—ã‚’å®Ÿè¡Œ
            const yaku = calculateAdvancedYaku(handForYaku, meldsForYaku);
            
            if (yaku.length > 0) {
                const yakuStrings = yaku.map(y => `${y.name}(${y.han >= 13 ? 'å½¹æº€' : y.han + 'ç¿»'})`);
                console.log(`    å½¹: ${yakuStrings.join(', ')}`);
                const totalHan = yaku.reduce((sum, y) => sum + y.han, 0);
                console.log(`    åˆè¨ˆ: ${totalHan >= 13 ? 'å½¹æº€' : totalHan + 'ç¿»'}`);
            } else {
                console.log(`    å½¹: ãªã—ï¼ˆå½¹ãªã—ï¼‰`);
            }
        }
        
        // ã‚¿ã‚¤ãƒ«å½¢å¼å¤‰æ›é–¢æ•°
        function convertTilesToAdvancedFormat(tiles) {
            return tiles.map(tile => {
                if (tile.honor) {
                    const honorMap = {
                        'white': 'haku', 'green': 'hatsu', 'red': 'chun',
                        'east': 'east', 'south': 'south', 'west': 'west', 'north': 'north'
                    };
                    return { suit: 'honors', type: honorMap[tile.honor] };
                } else {
                    return { suit: tile.suit, rank: tile.rank };
                }
            });
        }
        
        // ãƒ¡ãƒ«ãƒ‰å½¢å¼å¤‰æ›é–¢æ•°
        function convertMeldsToAdvancedFormat(melds) {
            return melds.map(meld => ({
                type: meld.type,
                tiles: convertTilesToAdvancedFormat(meld.tiles),
                isConcealed: meld.isConcealed || false
            }));
        }
        
        // å¼·åŒ–ç‰ˆå½¹è¨ˆç®—ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function calculateAdvancedYaku(hand, meldData = []) {
            const yaku = [];
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå‰¯éœ²ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šï¼ˆä¸€æ™‚çš„ï¼‰
            const originalMelds = typeof melds !== 'undefined' ? melds : [];
            if (typeof melds === 'undefined') {
                window.melds = meldData;
            }
            
            try {
                // å½¹æº€å„ªå…ˆåˆ¤å®š
                if (checkKokushiAdvanced(hand)) {
                    yaku.push({ name: 'å›½å£«ç„¡åŒ', han: 13 });
                    return yaku;
                }
                if (checkSuuankouAdvanced(hand)) {
                    yaku.push({ name: 'å››æš—åˆ»', han: 13 });
                    return yaku;
                }
                if (checkDaisangenAdvanced(hand)) {
                    yaku.push({ name: 'å¤§ä¸‰å…ƒ', han: 13 });
                    return yaku;
                }
                if (checkTsuuiisouAdvanced(hand)) {
                    yaku.push({ name: 'å­—ä¸€è‰²', han: 13 });
                    return yaku;
                }
                if (checkChinroutouAdvanced(hand)) {
                    yaku.push({ name: 'æ¸…è€é ­', han: 13 });
                    return yaku;
                }
                if (checkRyuuiisouAdvanced(hand)) {
                    yaku.push({ name: 'ç·‘ä¸€è‰²', han: 13 });
                    return yaku;
                }
                if (checkChuurenAdvanced(hand)) {
                    yaku.push({ name: 'ä¹è“®å®ç‡ˆ', han: 13 });
                    return yaku;
                }
                if (checkSuukantsuAdvanced(hand)) {
                    yaku.push({ name: 'å››æ§“å­', han: 13 });
                    return yaku;
                }

                // ç‰¹æ®Šå½¢åˆ¤å®š
                if (checkChiitoiAdvanced(hand)) {
                    yaku.push({ name: 'ä¸ƒå¯¾å­', han: 2 });
                    if (checkTanyaoAdvanced(hand)) yaku.push({ name: 'ã‚¿ãƒ³ãƒ¤ã‚ª', han: 1 });
                    if (checkChinitsuAdvanced(hand)) yaku.push({ name: 'æ¸…ä¸€è‰²', han: 6 });
                    if (checkHonitsuAdvanced(hand)) yaku.push({ name: 'æ··ä¸€è‰²', han: 3 });
                    return yaku;
                }

                // é€šå¸¸å½¹åˆ¤å®š
                if (checkTanyaoAdvanced(hand)) yaku.push({ name: 'ã‚¿ãƒ³ãƒ¤ã‚ª', han: 1 });
                
                // ä¸€ç›ƒå£ãƒ»äºŒç›ƒå£
                if (checkRyanpeikouAdvanced(hand)) {
                    yaku.push({ name: 'äºŒç›ƒå£', han: 3 });
                } else if (checkIipeikouAdvanced(hand)) {
                    yaku.push({ name: 'ä¸€ç›ƒå£', han: 1 });
                }
                
                // ãƒ”ãƒ³ãƒ•
                if (checkPinfuAdvanced(hand)) {
                    yaku.push({ name: 'ãƒ”ãƒ³ãƒ•', han: 1 });
                }
                
                // å½¹ç‰Œ
                const yakuhaiDetails = getYakuhaiDetailsAdvanced(hand, meldData);
                yakuhaiDetails.forEach(yakuhai => {
                    yaku.push(yakuhai);
                });
                
                // ãã®ä»–ã®å½¹
                if (checkToitoiAdvanced(hand)) yaku.push({ name: 'å¯¾ã€…å’Œ', han: 2 });
                if (checkSanankouAdvanced(hand)) yaku.push({ name: 'ä¸‰æš—åˆ»', han: 2 });
                if (checkSanshokuAdvanced(hand)) yaku.push({ name: 'ä¸‰è‰²åŒé †', han: 2 });
                if (checkIttsuAdvanced(hand)) yaku.push({ name: 'ä¸€æ°—é€šè²«', han: 2 });
                if (checkChantaAdvanced(hand)) yaku.push({ name: 'æ··å…¨å¸¯ä¹ˆä¹', han: 2 });
                if (checkJunchanAdvanced(hand)) yaku.push({ name: 'ç´”å…¨å¸¯ä¹ˆä¹', han: 3 });
                if (checkHonroutouAdvanced(hand)) yaku.push({ name: 'æ··è€é ­', han: 2 });
                if (checkShousangenAdvanced(hand)) yaku.push({ name: 'å°ä¸‰å…ƒ', han: 2 });
                if (checkHonitsuAdvanced(hand)) yaku.push({ name: 'æ··ä¸€è‰²', han: 3 });
                if (checkChinitsuAdvanced(hand)) yaku.push({ name: 'æ¸…ä¸€è‰²', han: 6 });
                
                return yaku;
            } finally {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’å¾©å…ƒ
                if (typeof melds !== 'undefined' && originalMelds !== melds) {
                    window.melds = originalMelds;
                }
            }
        }
        
        // ã‚¿ã‚¤ãƒ«ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function getTileCountsAdvanced(hand) {
            const counts = {};
            hand.forEach(tile => {
                const key = getTileKeyAdvanced(tile);
                counts[key] = (counts[key] || 0) + 1;
            });
            return counts;
        }
        
        // ã‚¿ã‚¤ãƒ«ã‚­ãƒ¼å–å¾—ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function getTileKeyAdvanced(tile) {
            if (tile.suit === 'honors') {
                return `honors_${tile.type}`;
            } else {
                return `${tile.suit}_${tile.rank}`;
            }
        }
        
        // === å½¹æº€åˆ¤å®šé–¢æ•°ç¾¤ ===
        
        function checkKokushiAdvanced(hand) {
            if (hand.length !== 14) return false;
            const yaochuTiles = [
                'man_1', 'man_9', 'pin_1', 'pin_9', 'sou_1', 'sou_9',
                'honors_east', 'honors_south', 'honors_west', 'honors_north',
                'honors_haku', 'honors_hatsu', 'honors_chun'
            ];
            
            const counts = getTileCountsAdvanced(hand);
            let pairFound = false;
            
            // å„ä¹ˆä¹ç‰ŒãŒ1æšä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (const yaochu of yaochuTiles) {
                if (!counts[yaochu]) return false;
                if (counts[yaochu] === 2) {
                    if (pairFound) return false; // é›€é ­ã¯1ã¤ã®ã¿
                    pairFound = true;
                } else if (counts[yaochu] !== 1) {
                    return false;
                }
            }
            
            return pairFound;
        }
        
        function checkSuuankouAdvanced(hand) {
            const counts = getTileCountsAdvanced(hand);
            const triplets = Object.values(counts).filter(count => count >= 3).length;
            const pairs = Object.values(counts).filter(count => count === 2).length;
            return triplets === 4 && pairs === 1;
        }
        
        function checkDaisangenAdvanced(hand) {
            const dragons = ['honors_haku', 'honors_hatsu', 'honors_chun'];
            const counts = getTileCountsAdvanced(hand);
            return dragons.every(dragon => counts[dragon] >= 3);
        }
        
        function checkTsuuiisouAdvanced(hand) {
            return hand.every(tile => tile.suit === 'honors');
        }
        
        function checkChinroutouAdvanced(hand) {
            return hand.every(tile => {
                if (tile.suit === 'honors') return false;
                return tile.rank === 1 || tile.rank === 9;
            });
        }
        
        function checkRyuuiisouAdvanced(hand) {
            const greenTiles = ['sou_2', 'sou_3', 'sou_4', 'sou_6', 'sou_8', 'honors_hatsu'];
            return hand.every(tile => {
                const key = getTileKeyAdvanced(tile);
                return greenTiles.includes(key);
            });
        }
        
        function checkChuurenAdvanced(hand) {
            const suits = ['man', 'pin', 'sou'];
            return suits.some(suit => {
                const suitTiles = hand.filter(tile => tile.suit === suit);
                if (suitTiles.length !== 14) return false;
                
                const counts = {};
                suitTiles.forEach(tile => {
                    counts[tile.rank] = (counts[tile.rank] || 0) + 1;
                });
                
                return counts[1] >= 3 && counts[9] >= 3 && 
                       [2,3,4,5,6,7,8].every(rank => counts[rank] >= 1);
            });
        }
        
        function checkSuukantsuAdvanced(hand) {
            const counts = getTileCountsAdvanced(hand);
            const quads = Object.values(counts).filter(count => count === 4).length;
            return quads === 4;
        }
        
        // === ç‰¹æ®Šå½¢åˆ¤å®šé–¢æ•°ç¾¤ ===
        
        function checkChiitoiAdvanced(hand) {
            if (hand.length !== 14) return false;
            const counts = getTileCountsAdvanced(hand);
            const values = Object.values(counts);
            return values.length === 7 && values.every(count => count === 2);
        }
        
        // === é€šå¸¸å½¹åˆ¤å®šé–¢æ•°ç¾¤ ===
        
        function checkTanyaoAdvanced(hand) {
            return hand.every(tile => {
                if (tile.suit === 'honors') return false;
                return tile.rank >= 2 && tile.rank <= 8;
            });
        }
        
        function checkPinfuAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            const structure = analyzeHandStructureAdvanced(hand);
            if (!structure || !structure.isComplete) return false;
            
            // 4ã¤ã®é †å­ã¨1ã¤ã®é›€é ­
            if (structure.sequences.length !== 4) return false;
            if (structure.triplets.length > 0 || structure.quads.length > 0) return false;
            if (structure.pairs.length !== 1) return false;
            
            // é›€é ­ãŒå½¹ç‰Œã§ãªã„ã“ã¨
            const pairKey = structure.pairs[0];
            if (typeof pairKey === 'string' && pairKey.startsWith('honors')) return false;
            
            return true;
        }
        
        function checkIipeikouAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            const structure = analyzeHandStructureAdvanced(hand);
            if (!structure || !structure.isComplete) return false;
            if (structure.sequences.length < 2) return false;
            
            // é †å­ã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
            const sequencePatterns = structure.sequences.map(seq => {
                return seq.sort().join(',');
            });
            
            const patternCounts = {};
            sequencePatterns.forEach(pattern => {
                patternCounts[pattern] = (patternCounts[pattern] || 0) + 1;
            });
            
            // åŒã˜é †å­ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            return Object.values(patternCounts).some(count => count >= 2);
        }
        
        function checkRyanpeikouAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            const groups = analyzeHandStructureAdvanced(hand);
            if (!groups) return false;
            
            const sequences = groups.sequences.map(seq => seq.sort().join(''));
            const counts = {};
            
            sequences.forEach(seq => {
                counts[seq] = (counts[seq] || 0) + 1;
            });
            
            const pairs = Object.values(counts).filter(count => count >= 2);
            return pairs.length >= 2;
        }
        
        function getYakuhaiDetailsAdvanced(hand, meldData = []) {
            const counts = getTileCountsAdvanced(hand);
            const yakuhaiList = [];
            
            console.log('ğŸ” å½¹ç‰Œåˆ¤å®š:', {
                hand: hand,
                meldData: meldData,
                counts: counts
            });
            
            // å‰¯éœ²ã‹ã‚‰ã‚‚ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ 
            meldData.forEach(meld => {
                if (meld.type === 'pon' || meld.type === 'kan' || meld.type === 'ankan') {
                    const key = getTileKeyAdvanced(meld.tiles[0]);
                    const meldCount = meld.tiles.length;
                    counts[key] = (counts[key] || 0) + meldCount;
                    console.log('ğŸ” ãƒ¡ãƒ«ãƒ‰ã‹ã‚‰å½¹ç‰Œã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ :', {
                        key: key,
                        meldCount: meldCount,
                        newCount: counts[key]
                    });
                }
            });
            
            // ä¸‰å…ƒç‰Œãƒã‚§ãƒƒã‚¯
            const dragonNames = { haku: 'ç™½', hatsu: 'ç™¼', chun: 'ä¸­' };
            Object.entries(dragonNames).forEach(([type, name]) => {
                const key = `honors_${type}`;
                if (counts[key] >= 3) {
                    yakuhaiList.push({ name: `å½¹ç‰Œ(${name})`, han: 1, type: 'dragon' });
                }
            });
            
            // å ´é¢¨ãƒã‚§ãƒƒã‚¯
            const gameWindKey = `honors_${gameSettings.gameWind}`;
            if (counts[gameWindKey] >= 3) {
                const windNames = { east: 'æ±', south: 'å—', west: 'è¥¿', north: 'åŒ—' };
                yakuhaiList.push({ 
                    name: `å ´é¢¨(${windNames[gameSettings.gameWind]})`, 
                    han: 1, 
                    type: 'gameWind' 
                });
            }
            
            // è‡ªé¢¨ãƒã‚§ãƒƒã‚¯
            const playerWindKey = `honors_${gameSettings.playerWind}`;
            if (counts[playerWindKey] >= 3) {
                const windNames = { east: 'æ±', south: 'å—', west: 'è¥¿', north: 'åŒ—' };
                yakuhaiList.push({ 
                    name: `è‡ªé¢¨(${windNames[gameSettings.playerWind]})`, 
                    han: 1, 
                    type: 'playerWind' 
                });
            }
            
            return yakuhaiList;
        }
        
        function checkToitoiAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            const counts = getTileCountsAdvanced(hand);
            const triplets = Object.values(counts).filter(count => count >= 3).length;
            const pairs = Object.values(counts).filter(count => count === 2).length;
            return triplets === 4 && pairs === 1;
        }
        
        function checkSanankouAdvanced(hand) {
            const counts = getTileCountsAdvanced(hand);
            const triplets = Object.values(counts).filter(count => count >= 3).length;
            return triplets >= 3;
        }
        
        function checkSanshokuAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            // ä¸‰è‰²åŒé †ã®åˆ¤å®šï¼š3ã¤ã®è‰²ã§åŒã˜é †å­
            for (let rank = 1; rank <= 7; rank++) {
                const manSeq = [`man_${rank}`, `man_${rank+1}`, `man_${rank+2}`];
                const pinSeq = [`pin_${rank}`, `pin_${rank+1}`, `pin_${rank+2}`];
                const souSeq = [`sou_${rank}`, `sou_${rank+1}`, `sou_${rank+2}`];
                
                const counts = getTileCountsAdvanced(hand);
                
                if (manSeq.every(tile => counts[tile] >= 1) &&
                    pinSeq.every(tile => counts[tile] >= 1) &&
                    souSeq.every(tile => counts[tile] >= 1)) {
                    return true;
                }
            }
            return false;
        }
        
        function checkIttsuAdvanced(hand) {
            // ä¸€æ°—é€šè²«ï¼šåŒä¸€è‰²ã§1-9ã®é †å­
            const suits = ['man', 'pin', 'sou'];
            return suits.some(suit => {
                const seq1 = [`${suit}_1`, `${suit}_2`, `${suit}_3`];
                const seq2 = [`${suit}_4`, `${suit}_5`, `${suit}_6`];
                const seq3 = [`${suit}_7`, `${suit}_8`, `${suit}_9`];
                
                const counts = getTileCountsAdvanced(hand);
                
                return seq1.every(tile => counts[tile] >= 1) &&
                       seq2.every(tile => counts[tile] >= 1) &&
                       seq3.every(tile => counts[tile] >= 1);
            });
        }
        
        function checkChantaAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            // æ··å…¨å¸¯ä¹ˆä¹ï¼šå„ãƒ¡ãƒ³ãƒ„ã«ç«¯ç‰Œã‹å­—ç‰ŒãŒå«ã¾ã‚Œã‚‹
            return hand.every(tile => {
                if (tile.suit === 'honors') return true;
                return tile.rank === 1 || tile.rank === 9;
            });
        }
        
        function checkJunchanAdvanced(hand) {
            if (checkChiitoiAdvanced(hand)) return false;
            
            // ç´”å…¨å¸¯ä¹ˆä¹ï¼šå„ãƒ¡ãƒ³ãƒ„ã«ç«¯ç‰Œï¼ˆ1,9ï¼‰ãŒå«ã¾ã‚Œã€å­—ç‰Œãªã—
            const hasHonors = hand.some(tile => tile.suit === 'honors');
            if (hasHonors) return false;
            
            return hand.every(tile => tile.rank === 1 || tile.rank === 9);
        }
        
        function checkHonroutouAdvanced(hand) {
            // æ··è€é ­ï¼šç«¯ç‰Œã¨å­—ç‰Œã®ã¿
            return hand.every(tile => {
                if (tile.suit === 'honors') return true;
                return tile.rank === 1 || tile.rank === 9;
            });
        }
        
        function checkShousangenAdvanced(hand) {
            const dragons = ['honors_haku', 'honors_hatsu', 'honors_chun'];
            const counts = getTileCountsAdvanced(hand);
            
            let tripletCount = 0;
            let pairCount = 0;
            
            dragons.forEach(dragon => {
                if (counts[dragon] >= 3) tripletCount++;
                if (counts[dragon] === 2) pairCount++;
            });
            
            return tripletCount === 2 && pairCount === 1;
        }
        
        function checkHonitsuAdvanced(hand) {
            // æ··ä¸€è‰²ï¼š1ã¤ã®æ•°ç‰Œã¨å­—ç‰Œã®ã¿
            const suits = new Set(hand.map(tile => tile.suit));
            const hasHonors = suits.has('honors');
            const numberSuits = [...suits].filter(suit => suit !== 'honors');
            
            return hasHonors && numberSuits.length === 1;
        }
        
        function checkChinitsuAdvanced(hand) {
            // æ¸…ä¸€è‰²ï¼š1ã¤ã®æ•°ç‰Œã®ã¿
            const suits = new Set(hand.map(tile => tile.suit));
            return suits.size === 1 && !suits.has('honors');
        }
        
        // æ‰‹ç‰Œæ§‹é€ åˆ†æï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function analyzeHandStructureAdvanced(hand) {
            if (hand.length !== 14) return null;
            
            // ç°¡æ˜“å®Ÿè£…ï¼šåŸºæœ¬çš„ãªé¢å­æ§‹æˆã‚’åˆ¤å®š
            const counts = getTileCountsAdvanced(hand);
            
            let pairs = 0;
            let triplets = 0;
            let sequences = 0;
            
            // å¯¾å­ã¨åˆ»å­ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            Object.values(counts).forEach(count => {
                if (count === 2) pairs++;
                else if (count >= 3) triplets++;
            });
            
            // é †å­ã®æ¨å®šï¼ˆç°¡æ˜“ï¼‰
            const remainingTiles = hand.length - (pairs * 2) - (triplets * 3);
            sequences = Math.floor(remainingTiles / 3);
            
            const isComplete = (pairs === 1 && triplets + sequences === 4);
            
            return {
                isComplete,
                pairs: pairs > 0 ? ['pair'] : [],
                triplets: Array(triplets).fill(['triplet']),
                sequences: Array(sequences).fill(['sequence']),
                quads: []
            };
        }
        
        // ç°¡æ˜“ã‚·ãƒ£ãƒ³ãƒ†ãƒ³è¨ˆç®—
        function calculateSimpleShanten(tiles, melds) {
            if (tiles.length + melds.length * 3 === 14) return -1; // å’Œäº†å½¢
            if (tiles.length + melds.length * 3 !== 13) return 8; // ç•°å¸¸
            
            // è¶…ç°¡æ˜“è¨ˆç®—ï¼ˆå®Ÿéš›ã®è¨ˆç®—ã¯è¤‡é›‘ï¼‰
            const tileCounts = {};
            tiles.forEach(tile => {
                const key = tile.honor || `${tile.suit}_${tile.rank}`;
                tileCounts[key] = (tileCounts[key] || 0) + 1;
            });
            
            let pairs = 0;
            let sets = 0;
            
            Object.values(tileCounts).forEach(count => {
                if (count >= 3) sets++;
                else if (count === 2) pairs++;
            });
            
            // éå¸¸ã«ç°¡æ˜“çš„ãªæ¨å®š
            const currentSets = sets + melds.length;
            const neededSets = 4;
            const neededPairs = 1;
            
            return Math.max(0, (neededSets - currentSets) * 2 + Math.max(0, neededPairs - pairs));
        }
        
        // å¾…ã¡ç‰Œãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function testWaitingTiles(tiles) {
            console.log(`  ğŸ¯ å¯èƒ½æ€§ã®ã‚ã‚‹å¾…ã¡ç‰Œ:`);
            
            // è¶…ç°¡æ˜“çš„ãªå¾…ã¡ç‰Œæ¨å®š
            const suits = ['man', 'pin', 'sou'];
            const possibleWaits = [];
            
            suits.forEach(suit => {
                for (let rank = 1; rank <= 9; rank++) {
                    // ã“ã®ç‰Œã‚’åŠ ãˆã¦å’Œäº†ã«ãªã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆè¶…ç°¡æ˜“ï¼‰
                    const testTile = { suit, rank, unicode: '', displayName: `${suit}${rank}`, id: 0, isRed: false };
                    possibleWaits.push(`${suit}${rank}`);
                }
            });
            
            // å­—ç‰Œ
            ['æ±', 'å—', 'è¥¿', 'åŒ—', 'ç™½', 'ç™¼', 'ä¸­'].forEach(honor => {
                possibleWaits.push(honor);
            });
            
            console.log(`    æ¨å®šå¾…ã¡: ${possibleWaits.slice(0, 5).join(', ')}... (ç°¡æ˜“æ¨å®š)`);
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function checkChiitoi(tiles) {
            if (tiles.length !== 14) return false;
            const counts = {};
            tiles.forEach(tile => {
                const key = tile.honor || `${tile.suit}_${tile.rank}`;
                counts[key] = (counts[key] || 0) + 1;
            });
            
            const values = Object.values(counts);
            return values.length === 7 && values.every(count => count === 2);
        }
        
        function checkKokushi(tiles) {
            if (tiles.length !== 14) return false;
            // ç°¡æ˜“å›½å£«åˆ¤å®šï¼ˆå®Ÿéš›ã¯ã‚ˆã‚Šè¤‡é›‘ï¼‰
            const yaochuCount = tiles.filter(t => 
                t.honor || t.rank === 1 || t.rank === 9
            ).length;
            return yaochuCount >= 12;
        }
        
        function checkStandardForm(tiles, melds) {
            // è¶…ç°¡æ˜“æ¨™æº–å½¢åˆ¤å®š
            const totalTiles = tiles.length + melds.length * 3;
            return totalTiles === 14 || totalTiles === 13;
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // =====================================
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°
        // =====================================

        // å‹åˆ©ã‚»ãƒ¬ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function triggerWinCelebration(data) {
            console.log('ğŸŠ å‹åˆ©ã‚»ãƒ¬ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            // è‡ªåˆ†ã®å‹åˆ©ã®å ´åˆ
            if (data.winner === 0) {
                // æ‰‹ç‰Œã‚¨ãƒªã‚¢ã«ã‚»ãƒ¬ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                const handArea = document.getElementById('hand0');
                if (handArea) {
                    handArea.classList.add('win-celebration');
                    setTimeout(() => {
                        handArea.classList.remove('win-celebration');
                    }, 800);
                }
                
                // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                createConfetti();
                
                // å‹åˆ©éŸ³åŠ¹æœ
                soundManager.playSound('win');
            }
            
            // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            flashBackground('#4CAF50', 500);
        }

        // å½¹æº€ç‰¹åˆ¥ã‚»ãƒ¬ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function triggerYakumanCelebration() {
            console.log('ğŸŒŸ å½¹æº€ã‚»ãƒ¬ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            // ã‚ˆã‚Šæ´¾æ‰‹ãªç´™å¹é›ª
            for (let i = 0; i < 3; i++) {
                setTimeout(() => createConfetti(), i * 200);
            }
            
            // é»„é‡‘ã®èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
            flashBackground('#FFD700', 1000);
            
            // ç”»é¢å…¨ä½“ã®ç¥è³€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const body = document.body;
            body.style.animation = 'winCelebration 1s ease-in-out';
            setTimeout(() => {
                body.style.animation = '';
            }, 1000);
        }

        // ãƒªãƒ¼ãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function triggerRiichiEffect(playerId) {
            console.log(`ğŸ”¥ ãƒªãƒ¼ãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–‹å§‹: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${playerId}`);
            
            if (playerId === 0) {
                // è‡ªåˆ†ã®ãƒªãƒ¼ãƒ - æ‰‹ç‰Œã«èµ¤ã„å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                const handArea = document.getElementById('hand0');
                if (handArea) {
                    handArea.classList.add('riichi-glow');
                    setTimeout(() => {
                        handArea.classList.remove('riichi-glow');
                    }, 3000);
                }
            }
            
            // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆèµ¤ï¼‰
            flashBackground('#FF5722', 300);
            
            // ãƒªãƒ¼ãƒéŸ³åŠ¹æœ
            soundManager.playSound('riichi');
        }

        // ç´™å¹é›ªç”Ÿæˆ
        function createConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
            }
            
            // 3ç§’å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
            setTimeout(() => {
                document.body.removeChild(container);
            }, 3000);
        }

        // ä¸‰å®¶å’Œç”¨èŠ±ç«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createFireworks() {
            const container = document.createElement('div');
            container.className = 'fireworks-container';
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            
            const colors = ['#ff1744', '#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0'];
            
            // è¤‡æ•°ã®èŠ±ç«ã‚’ä½œæˆ
            for (let firework = 0; firework < 5; firework++) {
                setTimeout(() => {
                    const centerX = Math.random() * window.innerWidth;
                    const centerY = Math.random() * (window.innerHeight * 0.6) + window.innerHeight * 0.2;
                    
                    // èŠ±ç«ã®ç«èŠ±ã‚’ä½œæˆ
                    for (let i = 0; i < 30; i++) {
                        const spark = document.createElement('div');
                        spark.style.position = 'absolute';
                        spark.style.width = '4px';
                        spark.style.height = '4px';
                        spark.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        spark.style.borderRadius = '50%';
                        spark.style.left = centerX + 'px';
                        spark.style.top = centerY + 'px';
                        
                        const angle = (i / 30) * 2 * Math.PI;
                        const distance = 150 + Math.random() * 100;
                        const endX = centerX + Math.cos(angle) * distance;
                        const endY = centerY + Math.sin(angle) * distance;
                        
                        spark.style.transition = 'all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        container.appendChild(spark);
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                        setTimeout(() => {
                            spark.style.transform = `translate(${endX - centerX}px, ${endY - centerY}px)`;
                            spark.style.opacity = '0';
                        }, 10);
                    }
                }, firework * 400);
            }
            
            // 4ç§’å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
            setTimeout(() => {
                document.body.removeChild(container);
            }, 4000);
        }

        // æµã—æº€è²«ç”¨æ³¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createWaveEffect() {
            const container = document.createElement('div');
            container.className = 'wave-container';
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '9999';
            container.style.overflow = 'hidden';
            document.body.appendChild(container);
            
            // è¤‡æ•°ã®æ³¢ã‚’ä½œæˆ
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const wave = document.createElement('div');
                    wave.style.position = 'absolute';
                    wave.style.bottom = '-50px';
                    wave.style.left = '-50%';
                    wave.style.width = '200%';
                    wave.style.height = '200px';
                    wave.style.background = `linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3))`;
                    wave.style.borderRadius = '50%';
                    wave.style.transform = 'translateY(100%)';
                    wave.style.transition = 'all 2s ease-out';
                    container.appendChild(wave);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                    setTimeout(() => {
                        wave.style.transform = 'translateY(-100%)';
                        wave.style.opacity = '0';
                    }, 10);
                }, i * 300);
            }
            
            // 4ç§’å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
            setTimeout(() => {
                document.body.removeChild(container);
            }, 4000);
        }

        // ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
        function updateTenpaiDisplay(gameState) {
            if (!gameState || !gameState.players) return;
            
            gameState.players.forEach((player, index) => {
                const playerElement = document.querySelector(`#player${index}`);
                if (!playerElement) return;
                
                // æ—¢å­˜ã®ãƒ†ãƒ³ãƒ‘ã‚¤è¡¨ç¤ºã‚’å‰Šé™¤
                const existingTenpai = playerElement.querySelector('.tenpai-indicator');
                if (existingTenpai) {
                    existingTenpai.remove();
                }
                
                // ãƒ†ãƒ³ãƒ‘ã‚¤æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                if (player.tenpaiInfo && player.tenpaiInfo.isTenpai) {
                    const tenpaiIndicator = createTenpaiIndicator(player.tenpaiInfo, index);
                    playerElement.appendChild(tenpaiIndicator);
                }
            });
        }
        
        // ãƒ†ãƒ³ãƒ‘ã‚¤ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä½œæˆ
        function createTenpaiIndicator(tenpaiInfo, playerIndex) {
            const indicator = document.createElement('div');
            indicator.className = 'tenpai-indicator';
            indicator.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                background: linear-gradient(45deg, #ff6b6b, #ee5a24);
                color: white;
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 4px 8px rgba(0,0,0,0.4);
                border: 2px solid rgba(255,255,255,0.3);
                z-index: 100;
                animation: tenpai-pulse 2s infinite;
                min-width: 60px;
                text-align: center;
            `;
            
            // ãƒ†ãƒ³ãƒ‘ã‚¤æƒ…å ±ã®ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
            let text = 'ãƒ†ãƒ³ãƒ‘ã‚¤';
            
            // ãƒ•ãƒªãƒ†ãƒ³ã®å ´åˆã¯è¡¨ç¤ºã‚’å¤‰æ›´
            if (tenpaiInfo.isFuriten) {
                text = 'ãƒ•ãƒªãƒ†ãƒ³';
                indicator.style.background = 'linear-gradient(45deg, #666, #444)';
            }
            
            // å¾…ã¡ã®ç¨®é¡è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªèº«ã®å ´åˆã®ã¿è©³ç´°è¡¨ç¤ºï¼‰
            if (playerIndex === 0 && tenpaiInfo.waitType) {
                const waitTypeText = getWaitTypeDisplayName(tenpaiInfo.waitType);
                text += ` (${waitTypeText})`;
            }
            
            indicator.textContent = text;
            
            // å¾…ã¡ç‰Œè¡¨ç¤ºï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªèº«ã®å ´åˆã®ã¿ï¼‰- æ­£å¼ç‰ˆ
            if (playerIndex === 0 && tenpaiInfo.waitingTiles && tenpaiInfo.waitingTiles.length > 0) {
                const waitingTilesDisplay = document.createElement('div');
                waitingTilesDisplay.style.cssText = `
                    margin-top: 4px;
                    font-size: 12px;
                    opacity: 1;
                    background: rgba(0,0,0,0.7);
                    padding: 2px 6px;
                    border-radius: 4px;
                    border: 1px solid rgba(255,215,0,0.3);
                `;
                
                // å¾…ã¡ç‰Œã®ã‚·ãƒ³ãƒœãƒ«è¡¨ç¤º
                const waitingSymbols = tenpaiInfo.waitingTiles
                    .map(tile => getTileDisplaySymbol(tile))
                    .join(' ');
                
                // å¾…ã¡æšæ•°è¨ˆç®—ï¼ˆå®Ÿéš›ã®æ®‹ã‚Šæšæ•°ã‚’è€ƒæ…®ï¼‰
                const totalWaitingCount = calculateActualWaitingCount(tenpaiInfo.waitingTiles);
                
                waitingTilesDisplay.innerHTML = `
                    <div style="color: #FFD700; font-weight: bold;">
                        å¾…ã¡: ${waitingSymbols}
                    </div>
                    <div style="font-size: 10px; color: #AAA;">
                        ${tenpaiInfo.waitingTiles.length}ç¨®${totalWaitingCount}æš
                    </div>
                `;
                indicator.appendChild(waitingTilesDisplay);
            }
            
            return indicator;
        }
        
        // å¾…ã¡ã‚¿ã‚¤ãƒ—ã®è¡¨ç¤ºå
        function getWaitTypeDisplayName(waitType) {
            const typeMap = {
                'tanki': 'å˜é¨',
                'ryanmen': 'ä¸¡é¢',
                'kanchan': 'åµŒå¼µ',
                'penchan': 'è¾ºå¼µ',
                'shanpon': 'ã‚·ãƒ£ãƒ³ãƒãƒ³',
                'sanmenchan': 'ä¸‰é¢å¼µ',
                'chiitoi': 'ä¸ƒå¯¾å­',
                'kokushi': 'å›½å£«ç„¡åŒ',
                'multiple': 'å¤šé¢å¾…ã¡',
                'none': 'ãªã—'
            };
            return typeMap[waitType] || waitType;
        }

        // ç‰Œè¡¨ç¤ºç”¨ã‚·ãƒ³ãƒœãƒ«å–å¾—ï¼ˆæ­£å¼ç‰ˆï¼‰
        function getTileDisplaySymbol(tile) {
            if (!tile) return '?';
            
            if (tile.suit === 'honors') {
                const honorMap = {
                    east: 'ğŸ€€', south: 'ğŸ€', west: 'ğŸ€‚', north: 'ğŸ€ƒ',
                    haku: 'ğŸ€†', hatsu: 'ğŸ€…', chun: 'ğŸ€„'
                };
                return honorMap[tile.type] || tile.type;
            } else {
                // æ•°ç‰Œã®å ´åˆã¯æ•°å­—ã¨ã‚¹ãƒ¼ãƒˆã‚·ãƒ³ãƒœãƒ«ã‚’è¡¨ç¤º
                const suitMap = {
                    man: 'ğŸ€‡', pin: 'ğŸ€™', sou: 'ğŸ€'
                };
                const baseSymbol = suitMap[tile.suit];
                if (baseSymbol && tile.rank >= 1 && tile.rank <= 9) {
                    // Unicodeã®éº»é›€ç‰Œã¯é€£ç¶šã—ãŸç•ªå·ãªã®ã§è¨ˆç®—ã§æ±‚ã‚ã‚‹
                    const offset = tile.rank - 1;
                    return String.fromCodePoint(baseSymbol.codePointAt(0) + offset);
                }
                return `${tile.rank}${tile.suit}`;
            }
        }

        // æ•°å­—ã‚’æ¼¢å­—ã«å¤‰æ›
        function numberToKanji(num) {
            const kanjiNumbers = {
                1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”',
                6: 'å…­', 7: 'ä¸ƒ', 8: 'å…«', 9: 'ä¹'
            };
            return kanjiNumbers[num] || num;
        }

        // ç‰Œã®è¡¨ç¤ºåå–å¾—ï¼ˆUnicodeå„ªå…ˆï¼‰
        function getTileDisplayName(tile) {
            if (!tile) return 'ğŸ€«';
            
            try {
                // UnicodeãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯æœ€å„ªå…ˆ
                if (tile.unicode) {
                    return tile.unicode;
                }
                
                // å­—ç‰Œï¼ˆå½¹ç‰Œãƒ»é¢¨ç‰Œï¼‰ã®å‡¦ç†
                if (tile.suit === 'honors' || tile.honor) {
                    const honorUnicodes = {
                        east: 'ğŸ€€', south: 'ğŸ€', west: 'è¥¿', north: 'ğŸ€ƒ',
                        haku: 'ğŸ€†', hatsu: 'ğŸ€…', chun: 'ğŸ€„',
                        white: 'ğŸ€†', green: 'ğŸ€…', red: 'ğŸ€„'  // è‹±èªè¡¨è¨˜ã«ã‚‚å¯¾å¿œ
                    };
                    const key = tile.type || tile.honor;
                    return honorUnicodes[key] || key;
                }
                
                // æ•°ç‰Œï¼ˆè¬å­ãƒ»ç­’å­ãƒ»ç´¢å­ï¼‰ã®å‡¦ç†
                if (tile.suit && (tile.rank || tile.number)) {
                    const suitUnicodes = {
                        man: ['ğŸ€‡', 'ğŸ€ˆ', 'ğŸ€‰', 'ğŸ€Š', 'ğŸ€‹', 'ğŸ€Œ', 'ğŸ€', 'ğŸ€', 'ğŸ€'],
                        pin: ['ğŸ€™', 'ğŸ€š', 'ğŸ€›', 'ğŸ€œ', 'ğŸ€', 'ğŸ€', 'ğŸ€Ÿ', 'ğŸ€ ', 'ğŸ€¡'],
                        sou: ['ğŸ€', 'ğŸ€‘', 'ğŸ€’', 'ğŸ€“', 'ğŸ€”', 'ğŸ€•', 'ğŸ€–', 'ğŸ€—', 'ğŸ€˜']
                    };
                    
                    const rank = tile.rank || tile.number;
                    if (suitUnicodes[tile.suit] && rank >= 1 && rank <= 9) {
                        return suitUnicodes[tile.suit][rank - 1];
                    }
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                return tile.displayName || `${tile.suit}${tile.rank}` || 'ğŸ€«';
                
            } catch (error) {
                console.error('getTileDisplayName error:', error, tile);
                return tile.displayName || tile.unicode || `${tile.suit}${tile.rank}` || '?';
            }
        }

        // ç‰Œã®è©³ç´°è¡¨ç¤ºåå–å¾—ï¼ˆå¾“æ¥ç‰ˆã‚‚æ®‹ã™ï¼‰
        function getTileDetailedName(tile) {
            if (!tile) return 'ä¸æ˜';
            
            if (tile.suit === 'honors') {
                const honorMap = {
                    east: 'æ±', south: 'å—', west: 'è¥¿', north: 'åŒ—',
                    haku: 'ç™½', hatsu: 'ç™¼', chun: 'ä¸­'
                };
                return honorMap[tile.type] || tile.type;
            } else {
                const suitMap = {
                    man: 'è¬', pin: 'ç­’', sou: 'ç´¢'
                };
                return `${tile.rank}${suitMap[tile.suit] || tile.suit}`;
            }
        }

        // å®Ÿéš›ã®å¾…ã¡æšæ•°è¨ˆç®—ï¼ˆæ²³ã‚„æ‰‹ç‰Œã‚’è€ƒæ…®ï¼‰
        function calculateActualWaitingCount(waitingTiles) {
            if (!gameState || !gameState.discardPiles) {
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒå–å¾—ã§ããªã„å ´åˆã¯ç°¡æ˜“è¨ˆç®—
                return waitingTiles.length * 4;
            }

            let totalCount = 0;
            
            waitingTiles.forEach(waitTile => {
                let availableCount = 4; // å„ç‰Œã¯æœ€å¤§4æš
                
                // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ²³ã‚’ãƒã‚§ãƒƒã‚¯
                gameState.discardPiles.forEach(discardPile => {
                    if (discardPile && Array.isArray(discardPile)) {
                        discardPile.forEach(discardedTile => {
                            if (tilesEqual(discardedTile, waitTile)) {
                                availableCount--;
                            }
                        });
                    }
                });
                
                // è‡ªåˆ†ã®æ‰‹ç‰Œã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢ã«æŒã£ã¦ã„ã‚‹åˆ†ã‚’é™¤å¤–ï¼‰
                if (gameState.players && gameState.players[0] && gameState.players[0].hand) {
                    const myTiles = gameState.players[0].hand.tiles || [];
                    myTiles.forEach(myTile => {
                        if (tilesEqual(myTile, waitTile)) {
                            availableCount--;
                        }
                    });
                }
                
                totalCount += Math.max(0, availableCount);
            });
            
            return totalCount;
        }

        // ç‰Œã®æ¯”è¼ƒé–¢æ•°
        function tilesEqual(tile1, tile2) {
            if (!tile1 || !tile2) return false;
            
            if (tile1.suit !== tile2.suit) return false;
            
            if (tile1.suit === 'honors') {
                return tile1.type === tile2.type;
            } else {
                return tile1.rank === tile2.rank;
            }
        }

        // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function flashBackground(color, duration) {
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0';
            flash.style.left = '0';
            flash.style.width = '100%';
            flash.style.height = '100%';
            flash.style.backgroundColor = color;
            flash.style.opacity = '0.3';
            flash.style.pointerEvents = 'none';
            flash.style.zIndex = '9998';
            flash.style.transition = `opacity ${duration}ms ease-out`;
            
            document.body.appendChild(flash);
            
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                flash.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(flash);
                }, duration);
            }, 50);
        }

        // ç‰Œã®é…ç‰Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateTileDistribution() {
            const handArea = document.getElementById('hand0');
            const tiles = handArea.querySelectorAll('.tile');
            
            tiles.forEach((tile, index) => {
                tile.style.opacity = '0';
                tile.style.transform = 'scale(0.8)';
                
                setTimeout(() => {
                    tile.style.transition = 'all 0.3s ease-out';
                    tile.style.opacity = '1';
                    tile.style.transform = 'scale(1)';
                }, index * 100);
            });
        }

        // æ‰“ç‰Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateDiscard(tileElement) {
            if (!tileElement) return;
            
            tileElement.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            tileElement.style.transform = 'scale(0.9)';
            tileElement.style.opacity = '0.7';
            
            setTimeout(() => {
                tileElement.style.transform = 'scale(1)';
                tileElement.style.opacity = '1';
            }, 400);
        }

        // ãƒªãƒ¼ãƒè¡¨ç¤ºæ›´æ–°é–¢æ•°
        function updateRiichiDisplay(playerElement, player, playerIndex) {
            // æ—¢å­˜ã®ãƒªãƒ¼ãƒè¡¨ç¤ºã‚’å‰Šé™¤
            const existingRiichiIndicator = playerElement.querySelector('.riichi-indicator');
            if (existingRiichiIndicator) {
                existingRiichiIndicator.remove();
            }
            
            // ãƒªãƒ¼ãƒä¸­ã®å ´åˆã¯è¡¨ç¤ºã‚’è¿½åŠ 
            if (player.hand && player.hand.riichi) {
                const riichiIndicator = document.createElement('div');
                riichiIndicator.className = 'riichi-indicator';
                riichiIndicator.innerHTML = 'ğŸ”¥ ãƒªãƒ¼ãƒ';
                riichiIndicator.style.cssText = `
                    position: absolute;
                    top: -15px;
                    right: -15px;
                    background: linear-gradient(135deg, #ff4444, #cc0000);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 15px;
                    font-size: 0.8rem;
                    font-weight: bold;
                    border: 2px solid #fff;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    animation: riichiGlow 2s ease-in-out infinite;
                    z-index: 100;
                `;
                playerElement.appendChild(riichiIndicator);
                console.log(`ğŸ”¥ ãƒªãƒ¼ãƒè¡¨ç¤ºè¿½åŠ : ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${playerIndex} (${player.name})`);
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') drawTile();
            if (e.key === 's' || e.key === 'S') discardSelected();
            if (e.key === 'a' || e.key === 'A') executeAI();
            if (e.key === 'r' || e.key === 'R') requestGameState();
            if (e.key === 'n' || e.key === 'N') newGame();
            if (e.key === 'q' || e.key === 'Q') toggleDebug();
        });

        // Socket.IOã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°ã¯ä¸è¦
        // ãŸã ã—ã€æ¥ç¶šç¢ºèªã®ãŸã‚ã«60ç§’ã”ã¨ã«pingã‚’é€ä¿¡
        setInterval(() => {
            if (isConnected) {
                socket.emit('ping');
            }
        }, 60000);
    </script>
</body>
</html>